<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2D5A3D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="PK Explorer">
    <meta name="description" content="Explore e mapeie a hist√≥ria de Presidente Dutra">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
    
    <title>PK Explorer ‚Äî Sistema Completo</title>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <style>
        /* ==================== RESET & VARS ==================== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --primary: #2D5A3D;
            --gold: #C4A35A;
            --gold-light: #E8C97A;
            --paper: #F5F1E8;
            --paper-dark: #EAE4D4;
            --ink: #1A1A2E;
            --white: #FFFEF9;
            --red: #8B1A1A;
            --orange: #D4700A;
            --blue: #1A4A6B;
            --green: #10B981;
            --gray: #6B7280;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Crimson Text', serif;
            background: var(--paper);
            color: var(--ink);
            font-size: 17px;
        }

        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        .topbar {
            background: var(--primary);
            border-bottom: 3px solid var(--gold);
            padding: 0.75rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 50;
        }

        .topbar-left { display: flex; align-items: center; gap: 0.75rem; }
        
        .topbar-back {
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: none; color: white;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        .topbar-logo { font-family: 'Playfair Display', serif; font-size: 1.35rem; color: var(--gold); }
        .topbar-right { display: flex; align-items: center; gap: 0.75rem; }

        .notification-badge {
            position: absolute; top: -4px; right: -4px;
            background: var(--red); color: white; font-size: 0.7rem;
            min-width: 18px; height: 18px; border-radius: 9px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--primary); animation: badgePulse 2s infinite;
        }
        
        @keyframes badgePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .topbar-xp { background: rgba(196,163,90,0.2); border: 1px solid var(--gold); color: var(--gold-light); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; }
        .topbar-avatar { width: 34px; height: 34px; border-radius: 50%; background: var(--gold); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; border: 2px solid var(--gold-light); }

        .screens { flex: 1; overflow: hidden; position: relative; }
        .screen { position: absolute; inset: 0; overflow-y: auto; display: none; background: var(--paper); animation: screenIn 0.25s ease-out; }
        .screen.active { display: block; }

        @keyframes screenIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav { background: var(--white); border-top: 3px solid var(--gold); display: flex; flex-shrink: 0; padding-bottom: var(--safe-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.6rem 0.25rem; color: var(--gray); border: none; background: none; }
        .nav-item.active { color: var(--primary); position: relative; }
        .nav-item.active::before { content: ''; position: absolute; top: 0; left: 15%; right: 15%; height: 3px; background: var(--gold); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 0.15rem; }
        .nav-label { font-size: 0.65rem; font-weight: 600; }

        /* Estilos adicionais para Cards e Modais */
        .card { background: white; margin: 1rem; padding: 1.25rem; border-radius: 16px; border: 2px solid var(--paper-dark); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 1000; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-sheet { background: var(--white); border-radius: 20px 20px 0 0; border-top: 3px solid var(--gold); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding-bottom: var(--safe-bottom); animation: sheetUp 0.3s ease-out; }
        @keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Auth Styles */
        .auth-card { background: var(--white); border: 2px solid var(--gold); border-radius: 20px; padding: 2rem; width: 100%; max-width: 400px; }
        .form-group { margin-bottom: 1rem; }
        .form-input, .form-select { width: 100%; padding: 0.75rem; border: 2px solid var(--gold); border-radius: 10px; font-family: inherit; }
        .btn-full { width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 0.5rem; }
        .hidden { display: none !important; }

        /* Map UI */
        #map { width: 100%; height: 100%; }
        .map-wrapper { position: relative; height: 100%; }
        .map-fab { position: absolute; bottom: 1.5rem; right: 1.5rem; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: 3px solid var(--gold); font-size: 1.5rem; z-index: 10; display: flex; align-items: center; justify-content: center; }

        /* Feedback */
        .feedback-category.selected { border-color: var(--gold); background: white; box-shadow: 0 4px 12px rgba(196,163,90,0.3); }
        .star-btn { font-size: 2rem; background: none; border: none; cursor: pointer; filter: grayscale(1); opacity: 0.4; }
        .star-btn.active { filter: grayscale(0); opacity: 1; }

        /* AR Overlay */
        .ar-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; }
        #arCamera { width: 100%; height: 100%; object-fit: cover; }
        .ar-photo-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #arHistoricalPhoto { max-width: 80%; border-radius: 12px; transition: opacity 0.2s; }
        .ar-slider-container { pointer-events: auto; position: absolute; bottom: 100px; width: 80%; background: rgba(0,0,0,0.6); padding: 1rem; border-radius: 20px; }

        .toast-container { position: fixed; top: 70px; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: white; border: 2px solid var(--gold); padding: 0.75rem 1rem; border-radius: 12px; display: flex; gap: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<div id="authScreen" style="height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1.5rem; background: var(--paper-dark);">
    <div class="auth-card">
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <span style="font-size: 3rem;">üó∫Ô∏è</span>
            <h2 style="font-family: 'Playfair Display'; color: var(--primary);">PK Explorer</h2>
            <p style="color: var(--gold); font-style: italic;">Mem√≥rias de Presidente Dutra</p>
        </div>

        <div id="loginForm">
            <div class="form-group">
                <input type="email" class="form-input" id="loginEmail" placeholder="E-mail">
            </div>
            <div class="form-group">
                <input type="password" class="form-input" id="loginPassword" placeholder="Senha">
            </div>
            <button class="btn-full" onclick="login()">Entrar</button>
            <button class="btn-full" style="background: var(--gold);" onclick="quickLogin()">‚ö° Acesso R√°pido</button>
        </div>
    </div>
</div>

<div class="app-shell" id="appShell" style="display:none;">
    <div class="topbar">
        <div class="topbar-left">
            <button class="topbar-back" id="topbarBack" onclick="goBack()" style="display:none;">‚Üê</button>
            <div class="topbar-logo" id="topbarLogo">üó∫Ô∏è PK Explorer</div>
        </div>
        <div class="topbar-right">
            <div class="topbar-xp" id="topbarXP">‚≠ê 0 XP</div>
            <div class="topbar-avatar" id="topbarAvatar" onclick="navigateTo('profile')">U</div>
        </div>
    </div>

    <div class="screens">
        <div class="screen active" id="screen-home">
            <div style="padding: 1.25rem;">
                <div class="card" style="background: var(--primary); color: white; margin: 0 0 1rem 0;">
                    <h3 id="welcomeName">Ol√°! üëã</h3>
                    <p style="opacity: 0.8;">Pronto para explorar a hist√≥ria hoje?</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <div class="card" style="margin: 0; text-align: center;" onclick="navigateTo('map')">
                        <span style="font-size: 2rem;">üó∫Ô∏è</span>
                        <p>Ver Mapa</p>
                    </div>
                    <div class="card" style="margin: 0; text-align: center;" onclick="openRegisterModal()">
                        <span style="font-size: 2rem;">üìç</span>
                        <p>Cadastrar</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" id="screen-map">
            <div class="map-wrapper">
                <div id="map"></div>
                <button class="map-fab" onclick="openRegisterModal()">üìç</button>
            </div>
        </div>

        <div class="screen" id="screen-missions">
            <div id="studentProgress"></div> <div id="teacherPanel" style="display:none;"></div>
        </div>

        <div class="screen" id="screen-feed">
            <div id="feedContent" style="padding: 1rem;"></div>
        </div>

        <div class="screen" id="screen-profile">
            <div id="profileContainer" style="padding: 1rem;">
                <div class="card" style="text-align: center;">
                    <div id="profileAvatarBig" style="width: 80px; height: 80px; border-radius: 50%; background: var(--gold); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold;">U</div>
                    <h2 id="profileName">Usu√°rio</h2>
                    <p id="profileRole" style="color: var(--gray);">Explorador</p>
                    <button class="btn-full" style="background: var(--red); margin-top: 2rem;" onclick="logout()">Sair da conta</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="navigateTo('home')" id="nav-home">
            <div class="nav-icon">üè†</div><div class="nav-label">In√≠cio</div>
        </button>
        <button class="nav-item" onclick="navigateTo('map')" id="nav-map">
            <div class="nav-icon">üó∫Ô∏è</div><div class="nav-label">Mapa</div>
        </button>
        <button class="nav-item" onclick="navigateTo('missions')" id="nav-missions">
            <div class="nav-icon">üìä</div><div class="nav-label">Painel</div>
        </button>
        <button class="nav-item" onclick="navigateTo('feed')" id="nav-feed">
            <div class="nav-icon">üì∞</div><div class="nav-label">Feed</div>
        </button>
        <button class="nav-item" onclick="navigateTo('profile')" id="nav-profile">
            <div class="nav-icon">üë§</div><div class="nav-label">Perfil</div>
        </button>
    </nav>
</div>

<div class="ar-overlay" id="arOverlay">
    <div style="position: absolute; top: 1rem; left: 1rem; z-index: 10;">
        <button onclick="closeAR()" style="background: white; border: none; padding: 0.5rem 1rem; border-radius: 20px;">Sair do AR</button>
    </div>
    <video id="arCamera" autoplay playsinline muted></video>
    <div class="ar-photo-overlay" id="arPhotoOverlay" style="display: none;">
        <img id="arHistoricalPhoto" src="">
        <div class="ar-slider-container">
            <input type="range" min="0" max="100" value="50" style="width: 100%;" oninput="document.getElementById('arHistoricalPhoto').style.opacity = this.value/100">
        </div>
    </div>
</div>

<div class="modal-overlay" id="registerModal">
    <div class="modal-sheet">
        <div style="padding: 1.5rem;">
            <h3>üìç Cadastrar Ponto Hist√≥rico</h3>
            <div class="form-group" style="margin-top: 1rem;">
                <label>Nome do Local</label>
                <input type="text" id="pointName" class="form-input">
            </div>
            <div class="form-group">
                <label>Descri√ß√£o (m√≠n. 100 letras)</label>
                <textarea id="pointDesc" class="form-input" style="height: 100px;"></textarea>
            </div>
            <button class="btn-full" onclick="submitPoint()">Enviar para An√°lise</button>
            <button class="btn-full" style="background: var(--gray);" onclick="closeRegisterModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
    'use strict';

    let AppState = {
        user: null,
        currentScreen: 'home',
        map: null,
        markers: [],
        location: null
    };

    const Auth = {
        getCurrent: () => JSON.parse(localStorage.getItem('pk_current_user') || 'null'),
        setCurrent: (u) => localStorage.setItem('pk_current_user', JSON.stringify(u)),
        clear: () => localStorage.removeItem('pk_current_user'),
        quickLogin: () => {
            const user = { name: 'Maria Santos', role: 'aluno', turma: '6ANOA', xp: 350, points: 7 };
            Auth.setCurrent(user);
            return user;
        }
    };

    window.addEventListener('load', () => {
        const user = Auth.getCurrent();
        if (user) {
            AppState.user = user;
            showApp();
        }
    });

    function login() { quickLogin(); } // Simplificado para demo

    function quickLogin() {
        AppState.user = Auth.quickLogin();
        showApp();
        showToast('‚ö°', 'Bem-vinda!', 'Maria Santos conectada');
    }

    function logout() {
        Auth.clear();
        location.reload();
    }

    function showApp() {
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('appShell').style.display = 'flex';
        updateUI();
        navigateTo('home');
        initMap();
        renderFeed();
    }

    function updateUI() {
        const u = AppState.user;
        document.getElementById('welcomeName').textContent = `Ol√°, ${u.name.split(' ')[0]}! üëã`;
        document.getElementById('topbarXP').textContent = `‚≠ê ${u.xp} XP`;
        document.getElementById('topbarAvatar').textContent = u.name.charAt(0);
        document.getElementById('profileName').textContent = u.name;
        document.getElementById('profileRole').textContent = u.role === 'aluno' ? `Aluno - ${u.turma}` : 'Professor';
    }

    function navigateTo(screen) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

        const target = document.getElementById('screen-' + screen);
        if (target) target.classList.add('active');
        
        const nav = document.getElementById('nav-' + screen);
        if (nav) nav.classList.add('active');

        AppState.currentScreen = screen;

        if (screen === 'missions') {
            renderStudentProgress();
        }
        
        if (screen === 'map' && AppState.map) {
            setTimeout(() => AppState.map.resize(), 100);
        }
    }

    function goBack() { navigateTo('home'); }

    // ==================== MAPA ====================
    function initMap() {
        if (AppState.map) return;
        AppState.map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: { 'osm': { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 } },
                layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
            },
            center: [-44.4934, -5.2912],
            zoom: 14
        });
    }

    // ==================== FEED (CORRIGIDO) ====================
    function renderFeed() {
        const points = [
            { id: 1, title: 'Igreja Matriz', author: 'Maria S.', turma: '6ANOA', category: '‚õ™ Igreja', likes: 24, img: 'https://images.unsplash.com/photo-1548625149-fc4a29cf7092?w=400' },
            { id: 2, title: 'Pra√ßa Central', author: 'Jo√£o P.', turma: '7ANOA', category: 'üå≥ Pra√ßa', likes: 18, img: 'https://images.unsplash.com/photo-1561731216-c3a4d99437d5?w=400' }
        ];

        document.getElementById('feedContent').innerHTML = points.map(p => `
            <div class="card" style="margin: 0 0 1rem 0; padding: 0; overflow: hidden;">
                <img src="${p.img}" style="width: 100%; height: 150px; object-fit: cover;">
                <div style="padding: 1rem;">
                    <small style="color: var(--gold);">${p.category}</small>
                    <h4 style="margin: 0.25rem 0;">${p.title}</h4>
                    <p style="font-size: 0.8rem; color: var(--gray);">Por ${p.author} (${p.turma})</p>
                </div>
            </div>
        `).join('');
    }

    // ==================== PROGRESSO (CORRIGIDO ID) ====================
    function renderStudentProgress() {
        const container = document.getElementById('studentProgress');
        if (!container) return;
        
        container.innerHTML = `
            <div class="card" style="background: var(--gold); color: var(--primary);">
                <h3>Seu Progresso</h3>
                <div style="font-size: 2rem; font-weight: bold;">${AppState.user.points} Pontos</div>
                <p>Mantenha a sequ√™ncia de descobertas!</p>
            </div>
            <div class="card">
                <h4>Conquistas</h4>
                <p>üèÜ Explorador Iniciante</p>
                <p>üì∏ Primeiro Registro</p>
            </div>
        `;
    }

    // ==================== REGISTRO ====================
    function openRegisterModal() { document.getElementById('registerModal').classList.add('active'); }
    function closeRegisterModal() { document.getElementById('registerModal').classList.remove('active'); }

    function submitPoint() {
        const name = document.getElementById('pointName').value;
        const desc = document.getElementById('pointDesc').value;

        if (name && desc.length >= 100) {
            AppState.user.xp += 75;
            AppState.user.points += 1;
            Auth.setCurrent(AppState.user);
            updateUI();
            closeRegisterModal();
            showToast('üéâ', 'Sucesso!', 'Ponto enviado para revis√£o');
            navigateTo('missions');
        } else {
            showToast('‚ö†Ô∏è', 'Erro', 'Preencha o nome e a descri√ß√£o longa');
        }
    }

    // ==================== AR MODE ====================
    function openAR() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                document.getElementById('arOverlay').style.display = 'block';
                document.getElementById('arCamera').srcObject = stream;
            });
    }

    function closeAR() {
        const video = document.getElementById('arCamera');
        if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        document.getElementById('arOverlay').style.display = 'none';
    }

    // ==================== UTILIT√ÅRIOS ====================
    function showToast(icon, title, body) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<div>${icon}</div><div><strong>${title}</strong><br><small>${body}</small></div>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>
</body>
</html>
