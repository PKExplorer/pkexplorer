<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2D5A3D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="PK Explorer">
    <meta name="description" content="Explore e mapeie a hist√≥ria de Presidente Dutra">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons (fallback to emoji data URI if files don't exist) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
    <link rel="apple-touch-icon" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%232D5A3D' rx='40'/><text y='140' x='96' font-size='120' text-anchor='middle'>üó∫Ô∏è</text></svg>">
    
    <title>PK Explorer ‚Äî Sistema Completo</title>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <style>
        /* ==================== RESET & VARS ==================== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --primary: #2D5A3D;
            --gold: #C4A35A;
            --gold-light: #E8C97A;
            --paper: #F5F1E8;
            --paper-dark: #EAE4D4;
            --ink: #1A1A2E;
            --white: #FFFEF9;
            --red: #8B1A1A;
            --orange: #D4700A;
            --blue: #1A4A6B;
            --green: #10B981;
            --gray: #6B7280;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Crimson Text', serif;
            background: var(--paper);
            color: var(--ink);
            font-size: 17px; /* Aumentado para melhor legibilidade no celular */
        }

        /* ==================== APP SHELL ==================== */
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* ==================== TOP NAVBAR ==================== */
        .topbar {
            background: var(--primary);
            border-bottom: 3px solid var(--gold);
            padding: 0.75rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 50;
        }

        .topbar-logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.35rem;
            color: var(--gold);
            letter-spacing: 0.5px;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .topbar-xp {
            background: rgba(196,163,90,0.2);
            border: 1px solid var(--gold);
            color: var(--gold-light);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .topbar-avatar {
            width: 34px; height: 34px;
            border-radius: 50%;
            background: var(--gold);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            border: 2px solid var(--gold-light);
        }

        /* ==================== SCREEN CONTAINER ==================== */
        .screens {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .screen {
            position: absolute;
            inset: 0;
            overflow-y: auto;
            display: none;
            background: var(--paper);
            animation: screenIn 0.25s ease-out;
        }

        .screen.active { display: block; }

        @keyframes screenIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== BOTTOM NAV ==================== */
        .bottom-nav {
            background: var(--white);
            border-top: 3px solid var(--gold);
            display: flex;
            flex-shrink: 0;
            padding-bottom: var(--safe-bottom);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray);
            position: relative;
            border: none;
            background: none;
            font-family: 'Crimson Text', serif;
        }

        .nav-item:hover { color: var(--primary); }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0; left: 15%; right: 15%;
            height: 3px;
            background: var(--gold);
            border-radius: 0 0 4px 4px;
        }

        .nav-icon {
            font-size: 1.4rem;
            margin-bottom: 0.15rem;
            transition: transform 0.2s;
        }

        .nav-item.active .nav-icon { transform: scale(1.1); }

        .nav-label {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .nav-badge {
            position: absolute;
            top: 0.4rem; right: calc(50% - 18px);
            background: var(--red);
            color: var(--white);
            font-size: 0.6rem;
            font-weight: 700;
            width: 16px; height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ==================== AUTH SCREEN ==================== */
        #screen-auth {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            padding: 2rem 1rem;
        }

        .auth-card {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            width: 100%;
            max-width: 440px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo-icon { font-size: 4rem; display: block; margin-bottom: 0.5rem; }

        .auth-logo-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--primary);
        }

        .auth-logo-sub {
            color: var(--gold);
            font-style: italic;
            font-size: 0.9rem;
        }

        .auth-tabs {
            display: flex;
            border: 2px solid var(--gold);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            transition: all 0.2s;
            border: none;
            background: var(--white);
            color: var(--gray);
        }

        .auth-tab.active { background: var(--primary); color: var(--white); }

        .form-group { margin-bottom: 1rem; }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.4rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gold);
            border-radius: 10px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            background: var(--white);
            color: var(--ink);
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-error {
            color: var(--red);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .btn-full {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }

        .btn-full:hover { background: #1d3d28; transform: translateY(-2px); }

        .btn-full.btn-gold { background: var(--gold); color: var(--primary); }
        .btn-full.btn-gold:hover { background: var(--gold-light); }

        .auth-divider {
            text-align: center;
            color: var(--gray);
            font-size: 0.875rem;
            margin: 1rem 0;
            position: relative;
        }

        .auth-divider::before, .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--paper-dark);
        }

        .auth-divider::before { left: 0; }
        .auth-divider::after { right: 0; }

        /* ==================== MAP SCREEN ==================== */
        #map { width: 100%; height: 100%; }

        .map-wrapper { position: relative; height: 100%; }

        .map-fab {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 60px; height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            border: 3px solid var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .map-fab:hover { transform: scale(1.1); background: #1d3d28; }

        .map-layer-btn {
            position: absolute;
            bottom: 1.5rem;
            left: 1.5rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--gold);
            font-size: 1.35rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .map-layer-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .map-layer-panel {
            position: absolute;
            bottom: 5rem;
            left: 1.5rem;
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 15;
            min-width: 200px;
        }

        .layer-option {
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.65rem;
            margin-bottom: 0.35rem;
            font-size: 0.9rem;
        }

        .layer-option:hover {
            background: var(--paper-dark);
        }

        .layer-option input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .map-filters {
            position: absolute;
            top: 4.5rem; left: 1rem; right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .map-search-bar {
            position: absolute;
            top: 1rem; left: 1rem; right: 1rem;
            z-index: 10;
            display: flex;
            gap: 0.5rem;
        }
        
        .map-search-bar input {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 25px;
            border: 2px solid var(--gold);
            background: var(--white);
            font-family: 'Crimson Text', serif;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .map-search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(45,90,61,0.3);
        }
        
        .map-search-bar button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            background: var(--white);
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }
        
        .map-search-bar button:hover {
            background: var(--red);
            color: white;
        }

        .map-filter-btn {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            border: 2px solid var(--gold);
            background: var(--white);
            color: var(--primary);
            font-family: 'Crimson Text', serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .map-filter-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .map-offline-banner {
            position: absolute;
            top: 4rem; left: 1rem; right: 1rem;
            background: var(--orange);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            z-index: 10;
            display: none;
        }

        /* ==================== SECTION SCREENS ==================== */
        .screen-content { padding: 1.25rem; }

        .screen-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gold);
        }

        .screen-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--primary);
        }

        /* ==================== HOME/DASHBOARD ==================== */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary), #1d3d28);
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 1.5rem;
            color: var(--white);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::after {
            content: 'üó∫Ô∏è';
            position: absolute;
            right: 1rem; top: 50%;
            transform: translateY(-50%);
            font-size: 4rem;
            opacity: 0.2;
        }

        .welcome-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.35rem;
            color: var(--gold-light);
            margin-bottom: 0.25rem;
        }

        .welcome-sub { font-size: 0.9rem; opacity: 0.8; }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .quick-stat {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1rem 0.75rem;
            text-align: center;
        }

        .quick-stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .quick-stat-label { font-size: 0.7rem; color: var(--gray); }

        .section-label {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .quick-action {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1.25rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .quick-action:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45,90,61,0.15);
        }

        .quick-action-icon { font-size: 1.75rem; }
        .quick-action-label { font-size: 0.85rem; font-weight: 600; color: var(--primary); text-align: center; }

        .active-mission {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .active-mission:hover { border-color: var(--primary); }

        .mission-icon-wrap {
            width: 44px; height: 44px;
            border-radius: 10px;
            background: rgba(45,90,61,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .mission-info { flex: 1; }
        .mission-name { font-weight: 600; color: var(--primary); font-size: 0.95rem; }
        .mission-xp { font-size: 0.8rem; color: var(--gold); }

        .mission-progress-mini {
            height: 6px;
            background: var(--paper-dark);
            border-radius: 3px;
            margin-top: 0.35rem;
            overflow: hidden;
        }

        .mission-progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--gold)); border-radius: 3px; }

        /* ==================== MODAL ==================== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal-sheet {
            background: var(--white);
            border-radius: 20px 20px 0 0;
            border-top: 3px solid var(--gold);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: sheetUp 0.3s ease-out;
            padding-bottom: var(--safe-bottom);
        }

        @keyframes sheetUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-handle {
            width: 40px; height: 4px;
            background: var(--paper-dark);
            border-radius: 2px;
            margin: 0.75rem auto 0;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--paper-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .modal-close {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--paper-dark);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body { padding: 1.5rem; }

        /* ==================== REGISTRATION WIZARD ==================== */
        .wizard-steps {
            display: flex;
            gap: 0;
            margin-bottom: 1.5rem;
        }

        .wizard-step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            position: relative;
        }

        .wizard-step::after {
            content: '';
            position: absolute;
            top: 16px; left: 50%;
            width: 100%; height: 2px;
            background: var(--paper-dark);
            z-index: 0;
        }

        .wizard-step:last-child::after { display: none; }
        .wizard-step.done::after { background: var(--gold); }

        .wizard-dot {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--paper-dark);
            border: 2px solid var(--paper-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            margin: 0 auto 0.25rem;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .wizard-step.active .wizard-dot { background: var(--primary); color: var(--white); border-color: var(--primary); }
        .wizard-step.done .wizard-dot { background: var(--gold); color: var(--primary); border-color: var(--gold); }

        .wizard-step-label { font-size: 0.65rem; color: var(--gray); }

        .wizard-page { display: none; }
        .wizard-page.active { display: block; }

        .location-card {
            background: var(--paper);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .location-icon { font-size: 1.5rem; }

        .location-info { flex: 1; }
        .location-coords { font-size: 0.8rem; color: var(--gray); }
        .location-address { font-weight: 600; color: var(--primary); font-size: 0.9rem; }

        .char-counter { font-size: 0.75rem; color: var(--gray); text-align: right; margin-top: 0.25rem; }

        .media-upload {
            border: 2px dashed var(--gold);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.75rem;
        }

        .media-upload:hover { border-color: var(--primary); background: rgba(45,90,61,0.03); }
        .media-upload.has-file { border-style: solid; border-color: var(--green); background: rgba(16,185,129,0.05); }

        .media-preview { max-width: 100%; max-height: 160px; border-radius: 8px; }

        textarea.form-input { min-height: 100px; resize: vertical; }

        .wizard-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 2px solid var(--paper-dark);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary); color: var(--white); flex: 1; }
        .btn-primary:hover { background: #1d3d28; }
        .btn-secondary { background: var(--paper-dark); color: var(--primary); }
        .btn-secondary:hover { background: var(--paper); }

        /* ==================== PROFILE SCREEN ==================== */
        .profile-header {
            background: linear-gradient(135deg, var(--primary), #1d3d28);
            padding: 2rem 1.25rem;
            text-align: center;
            color: var(--white);
        }

        .profile-avatar-big {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: var(--gold);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            margin: 0 auto 1rem;
            border: 4px solid var(--gold-light);
        }

        .profile-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--gold-light);
        }

        .profile-role {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .profile-level {
            background: rgba(196,163,90,0.2);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 0.35rem 1.25rem;
            display: inline-block;
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--gold-light);
        }

        .profile-xp-bar {
            margin: 1rem auto;
            max-width: 260px;
        }

        .profile-xp-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-bottom: 0.35rem;
        }

        .profile-xp-track {
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .profile-xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: 4px;
        }

        .profile-section { padding: 1.25rem; }

        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.9rem 0;
            border-bottom: 1px solid var(--paper-dark);
        }

        .profile-row:last-child { border-bottom: none; }
        .profile-row-label { color: var(--gray); font-size: 0.9rem; }
        .profile-row-value { font-weight: 600; color: var(--primary); }

        .btn-logout {
            width: calc(100% - 2.5rem);
            margin: 0 1.25rem 1.25rem;
            padding: 0.875rem;
            background: var(--red);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover { background: #6b1313; }

        /* ==================== NOTIFICATIONS ==================== */
        .toast-container {
            position: fixed;
            top: 70px; right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 300px;
        }

        .toast {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 0.875rem 1rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            animation: toastIn 0.3s ease-out;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast-icon { font-size: 1.25rem; }
        .toast-title { font-weight: 600; font-size: 0.875rem; color: var(--primary); }
        .toast-body { font-size: 0.8rem; color: var(--gray); }

        /* ==================== UTILITIES ==================== */
        .hidden { display: none !important; }
        
        /* Feed Filters */
        .feed-filter, .feed-filter-cat {
            padding: 0.45rem 1rem;
            border-radius: 20px;
            border: 2px solid var(--gold);
            background: var(--white);
            color: var(--primary);
            font-family: 'Crimson Text', serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .feed-filter:hover, .feed-filter-cat:hover {
            background: var(--paper-dark);
        }
        
        .feed-filter.active, .feed-filter-cat.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }
        
        .feed-filter-cat {
            font-size: 1.1rem;
            padding: 0.4rem 0.8rem;
        }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-state-icon { font-size: 3rem; margin-bottom: 0.75rem; }
        .empty-state-title { font-family: 'Playfair Display', serif; color: var(--primary); margin-bottom: 0.5rem; }
        .empty-state-text { font-size: 0.875rem; color: var(--gray); }

        .alert-strip {
            background: rgba(196,163,90,0.15);
            border: 2px solid var(--gold);
            border-radius: 10px;
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        @media (min-width: 768px) {
            .app-shell { max-width: 480px; margin: 0 auto; box-shadow: 0 0 80px rgba(0,0,0,0.15); }
            html { background: var(--paper-dark); }
        }
    </style>
</head>
<body>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- MODAL: POINT DETAIL -->
<div class="modal-overlay" id="pointDetailModal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <div class="modal-title" id="detailModalTitle">Ponto Hist√≥rico</div>
            <button class="modal-close" onclick="closePointDetail()">√ó</button>
        </div>
        <div class="modal-body">
            <img id="detailModalImage" style="width:100%;height:240px;object-fit:cover;border-radius:12px;margin-bottom:1rem;" src="" alt="">
            
            <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
                <span id="detailModalCategory" style="background:rgba(45,90,61,0.1);color:var(--primary);padding:0.35rem 0.85rem;border-radius:12px;font-size:0.8rem;font-weight:600;"></span>
                <span id="detailModalStatus" style="background:rgba(196,163,90,0.2);color:var(--gold);padding:0.35rem 0.85rem;border-radius:12px;font-size:0.8rem;font-weight:600;"></span>
            </div>
            
            <div style="font-size:0.85rem;color:var(--gray);margin-bottom:1rem;" id="detailModalAuthor"></div>
            
            <div style="margin-bottom:1.5rem;">
                <div style="font-weight:700;color:var(--primary);margin-bottom:0.5rem;font-size:0.875rem;text-transform:uppercase;letter-spacing:0.5px;">üìñ Descri√ß√£o Hist√≥rica</div>
                <div style="line-height:1.7;color:var(--ink);" id="detailModalDescription"></div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem;">
                <button class="btn btn-primary" onclick="closePointDetail()">‚úì Fechar</button>
                <button class="btn btn-secondary" onclick="showToast('üìç', 'Ver no mapa', 'Funcionalidade em breve!')">üó∫Ô∏è Ver no Mapa</button>
            </div>
            
            <button class="btn btn-full" style="background:var(--gradient-cool);background:linear-gradient(135deg,#06B6D4,#7C3AED);color:white;display:flex;align-items:center;justify-content:center;gap:0.5rem;" onclick="sharePoint()">
                üì§ Compartilhar este Ponto
            </button>
        </div>
    </div>
</div>

<!-- MODAL: REGISTER POINT -->
<div class="modal-overlay" id="registerModal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <div class="modal-title">üìç Cadastrar Ponto</div>
            <button class="modal-close" onclick="closeRegisterModal()">√ó</button>
        </div>

        <!-- Wizard Steps -->
        <div style="padding: 1rem 1.5rem 0;">
            <div class="wizard-steps" id="wizardSteps">
                <div class="wizard-step active" id="wstep-0">
                    <div class="wizard-dot">1</div>
                    <div class="wizard-step-label">Info</div>
                </div>
                <div class="wizard-step" id="wstep-1">
                    <div class="wizard-dot">2</div>
                    <div class="wizard-step-label">M√≠dia</div>
                </div>
                <div class="wizard-step" id="wstep-2">
                    <div class="wizard-dot">3</div>
                    <div class="wizard-step-label">Fontes</div>
                </div>
            </div>
        </div>

        <div class="modal-body">
            <!-- Step 1: Info -->
            <div class="wizard-page active" id="wpage-0">
                <div class="location-card" id="locationCard">
                    <div class="location-icon">üì°</div>
                    <div class="location-info">
                        <div class="location-address" id="locationAddress">Obtendo localiza√ß√£o...</div>
                        <div class="location-coords" id="locationCoords">Aguarde...</div>
                    </div>
                    <button onclick="refreshLocation()" style="background: none; border: none; cursor: pointer; font-size: 1.1rem;">üîÑ</button>
                </div>

                <div id="duplicateWarning"></div>

                <div class="form-group">
                    <label class="form-label">Nome do Local *</label>
                    <input type="text" class="form-input" id="pointName" placeholder="Ex: Igreja Matriz S√£o Sebasti√£o">
                </div>

                <div class="form-group">
                    <label class="form-label">Categoria *</label>
                    <select class="form-select" id="pointCategory">
                        <option value="">Selecione...</option>
                        <option value="igreja">‚õ™ Igreja / Capela</option>
                        <option value="praca">üå≥ Pra√ßa / Parque</option>
                        <option value="escola">üè´ Escola / Educa√ß√£o</option>
                        <option value="comercio">üè™ Com√©rcio Hist√≥rico</option>
                        <option value="residencia">üè† Resid√™ncia</option>
                        <option value="patrimonio">üèõÔ∏è Patrim√¥nio Cultural</option>
                        <option value="marco-geo">üóª Marco Geogr√°fico</option>
                        <option value="curiosidade">üí° Curiosidade Local</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Descri√ß√£o Hist√≥rica * <span style="color: var(--gray); font-weight: 400;">(m√≠n. 100 caracteres)</span></label>
                    <textarea class="form-input" id="pointDesc" placeholder="Conte a hist√≥ria deste local: quando foi constru√≠do, quem fundou, o que representou para a cidade..." oninput="updateCharCount()"></textarea>
                    <div class="char-counter"><span id="charCount">0</span>/100 caracteres m√≠nimos</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Per√≠odo Hist√≥rico</label>
                    <select class="form-select" id="pointEra">
                        <option value="antes1960">üìú Antes de 1960</option>
                        <option value="1960-1990">üï∞Ô∏è 1960 - 1990</option>
                        <option value="1990-2010">üì∑ 1990 - 2010</option>
                        <option value="2010+">üì± 2010 em diante</option>
                    </select>
                </div>
            </div>

            <!-- Step 2: Media -->
            <div class="wizard-page" id="wpage-1">
                <p style="font-size: 0.875rem; color: var(--gray); margin-bottom: 1rem;">üì∏ A foto √© obrigat√≥ria. √Åudio e v√≠deo s√£o opcionais mas muito valorizados!</p>

                <label class="form-label">üì∑ Foto Principal *</label>
                <div class="media-upload" id="mainPhotoUpload" onclick="document.getElementById('mainPhotoInput').click()">
                    <div id="mainPhotoPreviewWrap">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∑</div>
                        <div style="font-weight: 600; color: var(--primary);">Tirar foto ou escolher arquivo</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">JPEG, PNG ‚Äî m√°x. 10MB (comprimido automaticamente)</div>
                    </div>
                </div>
                <input type="file" id="mainPhotoInput" accept="image/*" capture="environment" class="hidden" onchange="handlePhoto(this, 'main')">

                <label class="form-label mt-2">üï∞Ô∏è Foto Antiga (opcional)</label>
                <div class="media-upload" onclick="document.getElementById('beforePhotoInput').click()">
                    <div id="beforePhotoPreviewWrap">
                        <div style="font-size: 1.5rem; margin-bottom: 0.35rem;">üñºÔ∏è</div>
                        <div style="font-size: 0.875rem; color: var(--gray);">Foto de como era antes (digitalizada)</div>
                    </div>
                </div>
                <input type="file" id="beforePhotoInput" accept="image/*" class="hidden" onchange="handlePhoto(this, 'before')">

                <label class="form-label mt-2">üéôÔ∏è √Åudio / Entrevista (opcional)</label>
                <div class="media-upload" onclick="document.getElementById('audioInput').click()">
                    <div style="font-size: 1.5rem; margin-bottom: 0.35rem;">üéôÔ∏è</div>
                    <div id="audioLabel" style="font-size: 0.875rem; color: var(--gray);">Grave ou envie entrevista com morador</div>
                </div>
                <input type="file" id="audioInput" accept="audio/*" class="hidden" onchange="handleAudio(this)">
            </div>

            <!-- Step 3: Sources -->
            <div class="wizard-page" id="wpage-2">
                <div class="alert-strip">
                    <span>üìö</span>
                    <div>Informe as fontes que usou na pesquisa ‚Äî livros, entrevistas, sites, documentos hist√≥ricos.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Fontes Bibliogr√°ficas</label>
                    <textarea class="form-input" id="pointSources" placeholder="Ex: Livro 'Hist√≥ria de Presidente Dutra' (1995); Entrevista com Sr. Jos√© (80 anos)..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Nome do Entrevistado (se houver)</label>
                    <input type="text" class="form-input" id="pointInterviewee" placeholder="Ex: Dona Maria da Concei√ß√£o, 75 anos">
                </div>

                <div style="background: var(--paper-dark); border-radius: 10px; padding: 1rem; margin-top: 1rem;">
                    <label style="display: flex; gap: 0.75rem; align-items: flex-start; cursor: pointer;">
                        <input type="checkbox" id="termsCheck" style="width: 18px; height: 18px; margin-top: 3px; accent-color: var(--primary);">
                        <span style="font-size: 0.875rem; color: var(--primary);">
                            Declaro que as informa√ß√µes s√£o verdadeiras, obtidas com responsabilidade, e que tenho autoriza√ß√£o para publicar as m√≠dias enviadas.
                        </span>
                    </label>
                </div>
            </div>
        </div>

        <div class="wizard-footer">
            <button class="btn btn-secondary" id="wizardBackBtn" onclick="wizardPrev()" style="display:none;">‚Üê Voltar</button>
            <button class="btn btn-primary" id="wizardNextBtn" onclick="wizardNext()">Pr√≥ximo ‚Üí</button>
        </div>
    </div>
</div>

<!-- APP SHELL -->
<div class="app-shell" id="appShell" style="display:none;">
    <!-- TOP BAR -->
    <div class="topbar">
        <div class="topbar-logo">üó∫Ô∏è PK Explorer</div>
        <div class="topbar-right">
            <div class="topbar-xp" id="topbarXP">‚≠ê 350 XP</div>
            <div class="topbar-avatar" id="topbarAvatar" onclick="navigateTo('profile')">M</div>
        </div>
    </div>

    <!-- SCREENS -->
    <div class="screens">

        <!-- HOME -->
        <div class="screen active" id="screen-home">
            <div class="screen-content">
                <div class="welcome-banner">
                    <div class="welcome-name" id="welcomeName">Ol√°, Maria! üëã</div>
                    <div class="welcome-sub">Continue explorando a hist√≥ria da cidade</div>
                </div>

                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="statPointsHome">7</div>
                        <div class="quick-stat-label">Pontos</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="statXpHome">350</div>
                        <div class="quick-stat-label">XP Total</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">#4</div>
                        <div class="quick-stat-label">Ranking</div>
                    </div>
                </div>

                <div class="section-label">‚ö° Acesso R√°pido</div>
                <div class="quick-actions">
                    <div class="quick-action" onclick="navigateTo('map')">
                        <div class="quick-action-icon">üó∫Ô∏è</div>
                        <div class="quick-action-label">Ver Mapa</div>
                    </div>
                    <div class="quick-action" onclick="openRegisterModal()">
                        <div class="quick-action-icon">üìç</div>
                        <div class="quick-action-label">Cadastrar Ponto</div>
                    </div>
                    <div class="quick-action" onclick="navigateTo('missions')">
                        <div class="quick-action-icon">üìä</div>
                        <div class="quick-action-label">Progresso</div>
                    </div>
                    <div class="quick-action" onclick="navigateTo('feed')">
                        <div class="quick-action-icon">üì∞</div>
                        <div class="quick-action-label">Descobertas</div>
                    </div>
                </div>

                <div class="section-label">üìä Resumo R√°pido</div>

                <div class="active-mission" onclick="navigateTo('missions')">
                    <div class="mission-icon-wrap">‚úÖ</div>
                    <div class="mission-info">
                        <div class="mission-name">Meu Trabalho</div>
                        <div class="mission-xp">7 pontos ¬∑ 5 aprovados</div>
                        <div class="mission-progress-mini"><div class="mission-progress-fill" style="width:71%"></div></div>
                    </div>
                    <span style="color: var(--gold);">‚Ä∫</span>
                </div>

                <div class="active-mission" onclick="navigateTo('missions')">
                    <div class="mission-icon-wrap">üë•</div>
                    <div class="mission-info">
                        <div class="mission-name">Nossa Turma (6¬∫A)</div>
                        <div class="mission-xp">47 pontos ¬∑ 2¬∫ lugar</div>
                        <div class="mission-progress-mini"><div class="mission-progress-fill" style="width:94%"></div></div>
                    </div>
                    <span style="color: var(--gold);">‚Ä∫</span>
                </div>
            </div>
        </div>

        <!-- MAP -->
        <div class="screen" id="screen-map">
            <div class="map-wrapper">
                <!-- Search Bar -->
                <div class="map-search-bar">
                    <input type="text" id="mapSearch" placeholder="üîç Buscar ponto hist√≥rico..." onkeyup="searchMap(this.value)">
                    <button id="clearSearch" onclick="clearMapSearch()" style="display:none;">√ó</button>
                </div>
                
                <div class="map-filters">
                    <button class="map-filter-btn active" onclick="filterMap('all', this)">üó∫Ô∏è Todos</button>
                    <button class="map-filter-btn" onclick="filterMap('pending', this)">‚è≥ Pendentes</button>
                    <button class="map-filter-btn" onclick="filterMap('approved', this)">‚úÖ Aprovados</button>
                    <button class="map-filter-btn" onclick="filterMap('igreja', this)">‚õ™ Igrejas</button>
                </div>
                <div class="map-offline-banner" id="mapOfflineBanner">‚úàÔ∏è Modo offline ‚Äî tiles do cache</div>
                <div id="map"></div>
                
                <!-- Layer Selector -->
                <button class="map-layer-btn" id="layerToggle" onclick="toggleLayerPanel()" title="Camadas do Mapa">
                    üó∫Ô∏è
                </button>
                
                <div class="map-layer-panel" id="layerPanel" style="display:none;">
                    <div style="font-weight:700;margin-bottom:0.75rem;color:var(--primary);font-size:0.9rem;">üìç Camadas do Mapa</div>
                    <div class="layer-option" onclick="changeMapLayer('streets', this)">
                        <input type="radio" name="layer" checked> 
                        <span>üó∫Ô∏è Mapa de Ruas</span>
                    </div>
                    <div class="layer-option" onclick="changeMapLayer('topo', this)">
                        <input type="radio" name="layer"> 
                        <span>‚õ∞Ô∏è Topogr√°fico</span>
                    </div>
                    <div class="layer-option" onclick="changeMapLayer('satellite', this)">
                        <input type="radio" name="layer"> 
                        <span>üõ∞Ô∏è Sat√©lite</span>
                    </div>
                </div>
                
                <button class="map-fab" onclick="openRegisterModal()" title="Cadastrar novo ponto">üìç</button>
            </div>
        </div>

        <!-- MISSIONS -->
        <!-- PROGRESSO -->
        <div class="screen" id="screen-missions">
            <div class="screen-content">
                <div class="screen-header">
                    <span style="font-size:1.5rem">üìä</span>
                    <div class="screen-title">Meu Progresso</div>
                </div>

                <!-- Meu Trabalho -->
                <div class="card">
                    <div class="card-title" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
                        <span>üìù</span>
                        <span>Meu Trabalho</span>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:1rem;">
                        <div style="background:var(--paper-dark);border-radius:12px;padding:1rem;text-align:center;">
                            <div style="font-size:2rem;font-weight:700;color:var(--primary);font-family:'Playfair Display',serif;">7</div>
                            <div style="font-size:0.8rem;color:var(--gray);">Pontos Cadastrados</div>
                        </div>
                        <div style="background:rgba(16,185,129,0.1);border-radius:12px;padding:1rem;text-align:center;">
                            <div style="font-size:2rem;font-weight:700;color:var(--green);font-family:'Playfair Display',serif;">5</div>
                            <div style="font-size:0.8rem;color:var(--gray);">‚úÖ Aprovados</div>
                        </div>
                        <div style="background:rgba(255,140,0,0.1);border-radius:12px;padding:1rem;text-align:center;">
                            <div style="font-size:2rem;font-weight:700;color:var(--orange);font-family:'Playfair Display',serif;">2</div>
                            <div style="font-size:0.8rem;color:var(--gray);">‚è≥ Em An√°lise</div>
                        </div>
                        <div style="background:rgba(196,163,90,0.1);border-radius:12px;padding:1rem;text-align:center;">
                            <div style="font-size:2rem;font-weight:700;color:var(--gold);font-family:'Playfair Display',serif;">12</div>
                            <div style="font-size:0.8rem;color:var(--gray);">üì∑ Fotos Enviadas</div>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:0.75rem;font-size:0.9rem;">
                        <div style="flex:1;background:var(--paper-dark);padding:0.75rem;border-radius:10px;text-align:center;">
                            üéôÔ∏è <strong>1</strong> entrevista
                        </div>
                        <div style="flex:1;background:var(--paper-dark);padding:0.75rem;border-radius:10px;text-align:center;">
                            üó∫Ô∏è <strong>5</strong> locais visitados
                        </div>
                    </div>
                </div>

                <!-- Nossa Turma -->
                <div class="card" style="background:linear-gradient(135deg,rgba(45,90,61,0.05),rgba(196,163,90,0.05));">
                    <div class="card-title" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
                        <span>üë•</span>
                        <span>Nossa Turma (6¬∫A)</span>
                    </div>
                    
                    <div style="background:var(--white);border-radius:12px;padding:1.25rem;margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
                            <div>
                                <div style="font-size:0.85rem;color:var(--gray);margin-bottom:0.25rem;">Total de pontos</div>
                                <div style="font-size:1.75rem;font-weight:700;color:var(--primary);font-family:'Playfair Display',serif;">47</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.85rem;color:var(--gray);margin-bottom:0.25rem;">Ranking</div>
                                <div style="font-size:1.75rem;font-weight:700;color:var(--gold);font-family:'Playfair Display',serif;">ü•à 2¬∫</div>
                            </div>
                        </div>
                        
                        <div style="font-size:0.85rem;color:var(--gray);margin-bottom:0.5rem;">Meta da semana: 50 pontos</div>
                        <div style="height:10px;background:var(--paper-dark);border-radius:5px;overflow:hidden;">
                            <div style="height:100%;width:94%;background:linear-gradient(90deg,var(--primary),var(--gold));border-radius:5px;transition:width 0.8s;"></div>
                        </div>
                        <div style="text-align:right;font-size:0.8rem;color:var(--primary);font-weight:600;margin-top:0.35rem;">94% ‚Äî Faltam 3 pontos!</div>
                    </div>
                    
                    <div style="display:flex;gap:0.75rem;">
                        <div style="flex:1;background:var(--white);padding:0.875rem;border-radius:10px;text-align:center;">
                            <div style="font-weight:700;color:var(--primary);margin-bottom:0.25rem;">25</div>
                            <div style="font-size:0.75rem;color:var(--gray);">Alunos ativos</div>
                        </div>
                        <div style="flex:1;background:var(--white);padding:0.875rem;border-radius:10px;text-align:center;">
                            <div style="font-weight:700;color:var(--primary);margin-bottom:0.25rem;">8</div>
                            <div style="font-size:0.75rem;color:var(--gray);">Sa√≠das de campo</div>
                        </div>
                    </div>
                </div>

                <!-- Toda a Escola -->
                <div class="card">
                    <div class="card-title" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
                        <span>üè´</span>
                        <span>Toda a Escola</span>
                    </div>
                    
                    <div style="background:linear-gradient(135deg,var(--primary),rgba(45,90,61,0.8));border-radius:12px;padding:1.5rem;color:var(--white);margin-bottom:1rem;">
                        <div style="font-size:0.9rem;opacity:0.9;margin-bottom:0.5rem;">üéØ Meta do M√™s</div>
                        <div style="font-size:1.75rem;font-weight:700;font-family:'Playfair Display',serif;margin-bottom:1rem;">Mapear 100 Pontos Hist√≥ricos</div>
                        
                        <div style="height:12px;background:rgba(255,255,255,0.2);border-radius:6px;overflow:hidden;margin-bottom:0.75rem;">
                            <div style="height:100%;width:78%;background:var(--gold);border-radius:6px;transition:width 0.8s;"></div>
                        </div>
                        
                        <div style="display:flex;justify-content:space-between;font-size:0.9rem;">
                            <span><strong>78</strong> pontos cadastrados</span>
                            <span><strong>22</strong> pontos faltando</span>
                        </div>
                    </div>
                    
                    <div style="font-size:0.85rem;color:var(--gray);margin-bottom:0.75rem;font-weight:600;">üèÜ Destaques desta semana:</div>
                    
                    <div style="display:flex;flex-direction:column;gap:0.65rem;">
                        <div style="background:var(--paper-dark);padding:0.875rem 1rem;border-radius:10px;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:0.9rem;">üë§ <strong>Jo√£o Silva</strong> (7¬∫B)</span>
                            <span style="font-size:0.85rem;color:var(--primary);font-weight:600;">8 pontos</span>
                        </div>
                        <div style="background:rgba(16,185,129,0.1);padding:0.875rem 1rem;border-radius:10px;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:0.9rem;">ü•á <strong>Turma 6¬∫B</strong></span>
                            <span style="font-size:0.85rem;color:var(--green);font-weight:600;">1¬∫ lugar (52 pontos)</span>
                        </div>
                        <div style="background:rgba(196,163,90,0.1);padding:0.875rem 1rem;border-radius:10px;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:0.9rem;">üéôÔ∏è <strong>Melhor entrevista</strong></span>
                            <span style="font-size:0.85rem;color:var(--gold);font-weight:600;">Maria (6¬∫A)</span>
                        </div>
                    </div>
                </div>

                <!-- Pr√≥ximos Eventos -->
                <div class="card" style="background:rgba(196,163,90,0.05);border-color:var(--gold);">
                    <div class="card-title" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
                        <span>üìÖ</span>
                        <span>Pr√≥ximos Eventos</span>
                    </div>
                    
                    <div style="display:flex;flex-direction:column;gap:0.75rem;">
                        <div style="display:flex;gap:1rem;background:var(--white);padding:1rem;border-radius:10px;border-left:4px solid var(--primary);">
                            <div style="text-align:center;min-width:50px;">
                                <div style="font-size:1.5rem;font-weight:700;color:var(--primary);font-family:'Playfair Display',serif;">22</div>
                                <div style="font-size:0.7rem;color:var(--gray);text-transform:uppercase;">Fev</div>
                            </div>
                            <div style="flex:1;">
                                <div style="font-weight:600;color:var(--primary);margin-bottom:0.25rem;">Sa√≠da de Campo ‚Äî Centro Hist√≥rico</div>
                                <div style="font-size:0.85rem;color:var(--gray);">Sexta-feira ‚Ä¢ 14h √†s 16h</div>
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:1rem;background:var(--white);padding:1rem;border-radius:10px;border-left:4px solid var(--gold);">
                            <div style="text-align:center;min-width:50px;">
                                <div style="font-size:1.5rem;font-weight:700;color:var(--gold);font-family:'Playfair Display',serif;">25</div>
                                <div style="font-size:0.7rem;color:var(--gray);text-transform:uppercase;">Fev</div>
                            </div>
                            <div style="flex:1;">
                                <div style="font-weight:600;color:var(--primary);margin-bottom:0.25rem;">Exposi√ß√£o: Fotos Antigas da Cidade</div>
                                <div style="font-size:0.85rem;color:var(--gray);">Segunda-feira ‚Ä¢ Biblioteca da escola</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- FEED -->
        <div class="screen" id="screen-feed">
            <div class="screen-content">
                <div class="screen-header">
                    <span style="font-size:1.5rem">üì∞</span>
                    <div class="screen-title">Descobertas</div>
                </div>
                
                <!-- Feed Filters -->
                <div style="background:var(--white);border:2px solid var(--gold);border-radius:14px;padding:1rem;margin-bottom:1rem;">
                    <div style="font-weight:700;color:var(--primary);margin-bottom:0.75rem;font-size:0.875rem;">üîç Filtrar por:</div>
                    
                    <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.75rem;">
                        <button class="feed-filter active" data-filter="all" onclick="filterFeed('all', this)">
                            Todos
                        </button>
                        <button class="feed-filter" data-filter="minha-turma" onclick="filterFeed('minha-turma', this)">
                            Minha Turma
                        </button>
                    </div>
                    
                    <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
                        <button class="feed-filter-cat" data-category="all" onclick="filterFeedCategory('all', this)">
                            üìç Todas
                        </button>
                        <button class="feed-filter-cat" data-category="igreja" onclick="filterFeedCategory('igreja', this)">
                            ‚õ™
                        </button>
                        <button class="feed-filter-cat" data-category="praca" onclick="filterFeedCategory('praca', this)">
                            üå≥
                        </button>
                        <button class="feed-filter-cat" data-category="patrimonio" onclick="filterFeedCategory('patrimonio', this)">
                            üèõÔ∏è
                        </button>
                        <button class="feed-filter-cat" data-category="comercio" onclick="filterFeedCategory('comercio', this)">
                            üè™
                        </button>
                    </div>
                </div>
                
                <div id="feedContent"></div>
            </div>
        </div>

        <!-- PROFILE -->
        <div class="screen" id="screen-profile">
            <div class="profile-header">
                <div class="profile-avatar-big" id="profileAvatarBig">M</div>
                <div class="profile-name" id="profileName">Maria Santos</div>
                <div class="profile-role" id="profileRole">Aluna ¬∑ Turma 6¬∫A</div>
                <div class="profile-level" id="profileLevel">‚≠ê Exploradora</div>
                <div class="profile-xp-bar">
                    <div class="profile-xp-label">
                        <span>350 XP</span>
                        <span>500 XP</span>
                    </div>
                    <div class="profile-xp-track">
                        <div class="profile-xp-fill" style="width:70%"></div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <div class="profile-row">
                    <div class="profile-row-label">üìç Pontos cadastrados</div>
                    <div class="profile-row-value" id="profileStatPoints">7</div>
                </div>
                <div class="profile-row">
                    <div class="profile-row-label">‚úÖ Aprovados</div>
                    <div class="profile-row-value">5</div>
                </div>
                <div class="profile-row">
                    <div class="profile-row-label">üèÜ Badges conquistados</div>
                    <div class="profile-row-value">3</div>
                </div>
                <div class="profile-row">
                    <div class="profile-row-label">üìä Posi√ß√£o no ranking</div>
                    <div class="profile-row-value">#4 ¬∑ Turma 6¬∫A</div>
                </div>
                <div class="profile-row">
                    <div class="profile-row-label">üéì Turma</div>
                    <div class="profile-row-value" id="profileTurma">6¬∫ Ano A</div>
                </div>
            </div>

            <div style="padding: 0 1.25rem; margin-bottom: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                <button class="btn btn-primary" onclick="navigateTo('missions')">üéØ Miss√µes</button>
                <button class="btn" style="background: var(--paper-dark); color: var(--primary);" onclick="showToast('üî≠', 'Em breve', 'Modo AR dispon√≠vel na Parte 8!')">üî≠ Modo AR</button>
            </div>

            <button class="btn-logout" onclick="logout()">üö™ Sair da conta</button>
        </div>

    </div><!-- /screens -->

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="navigateTo('home')" id="nav-home">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">In√≠cio</div>
        </button>
        <button class="nav-item" onclick="navigateTo('map')" id="nav-map">
            <div class="nav-icon">üó∫Ô∏è</div>
            <div class="nav-label">Mapa</div>
        </button>
        <button class="nav-item" onclick="navigateTo('missions')" id="nav-missions">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Progresso</div>
        </button>
        <button class="nav-item" onclick="navigateTo('feed')" id="nav-feed">
            <div class="nav-icon">üì∞</div>
            <div class="nav-label">Descobertas</div>
        </button>
        <button class="nav-item" onclick="navigateTo('profile')" id="nav-profile">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">Perfil</div>
        </button>
    </nav>
</div>

<!-- AUTH SCREEN -->
<div id="authScreen">
    <div class="screen-content" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1.5rem;">
        <div class="auth-card">
            <div class="auth-logo">
                <span class="auth-logo-icon">üó∫Ô∏è</span>
                <div class="auth-logo-title">PK Explorer</div>
                <div class="auth-logo-sub">‚ú¶ Mem√≥rias de Presidente Dutra ‚ú¶</div>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login', this)">Entrar</button>
                <button class="auth-tab" onclick="switchAuthTab('register', this)">Criar Conta</button>
            </div>

            <!-- LOGIN -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">E-mail</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="loginError" class="form-error hidden"></div>
                <button class="btn-full" onclick="login()">Entrar ‚Üí</button>
                <div class="auth-divider">ou</div>
                <button class="btn-full btn-gold" onclick="quickLogin()">‚ö° Acesso R√°pido (Demo)</button>
            </div>

            <!-- REGISTER -->
            <div id="registerForm" style="display:none;">
                <div class="form-group">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" class="form-input" id="regName" placeholder="Seu nome">
                </div>
                <div class="form-group">
                    <label class="form-label">E-mail</label>
                    <input type="email" class="form-input" id="regEmail" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="regPassword" placeholder="M√≠nimo 6 caracteres">
                </div>
                <div class="form-group">
                    <label class="form-label">Voc√™ √©:</label>
                    <select class="form-select" id="regRole" onchange="toggleTurma()">
                        <option value="aluno">üë®‚Äçüéì Aluno</option>
                        <option value="professor">üë®‚Äçüè´ Professor</option>
                    </select>
                </div>
                <div class="form-group" id="turmaGroup">
                    <label class="form-label">Turma</label>
                    <select class="form-select" id="regTurma">
                        <option value="6ANOA">6¬∫ Ano A</option>
                        <option value="6ANOB">6¬∫ Ano B</option>
                        <option value="7ANOA">7¬∫ Ano A</option>
                        <option value="7ANOB">7¬∫ Ano B</option>
                        <option value="8ANOA">8¬∫ Ano A</option>
                        <option value="8ANOB">8¬∫ Ano B</option>
                        <option value="9ANO">9¬∫ Ano</option>
                    </select>
                </div>
                <div id="regError" class="form-error hidden"></div>
                <button class="btn-full" onclick="register()">Criar Conta ‚Üí</button>
            </div>
        </div>
    </div>
</div>

<script>
'use strict';

// =================================================================
// AUTH SYSTEM
// =================================================================
const Auth = {
    getUsers: () => JSON.parse(localStorage.getItem('pk_users') || '[]'),
    saveUsers: (u) => localStorage.setItem('pk_users', JSON.stringify(u)),
    getCurrent: () => JSON.parse(localStorage.getItem('pk_current_user') || 'null'),
    setCurrent: (u) => localStorage.setItem('pk_current_user', JSON.stringify(u)),
    clear: () => localStorage.removeItem('pk_current_user'),

    login(email, password) {
        const users = this.getUsers();
        const user = users.find(u => u.email === email && u.password === password);
        if (!user) return { error: 'E-mail ou senha incorretos' };
        this.setCurrent(user);
        return { user };
    },

    register(data) {
        const users = this.getUsers();
        if (users.find(u => u.email === data.email)) return { error: 'E-mail j√° cadastrado' };
        const user = { ...data, id: Date.now().toString(), xp: 0, points: 0, badges: [] };
        users.push(user);
        this.saveUsers(users);
        this.setCurrent(user);
        return { user };
    }
};

// =================================================================
// STATE
// =================================================================
let AppState = {
    user: null,
    currentScreen: 'home',
    map: null,
    markers: [],
    wizardStep: 0,
    location: null,
    mainPhoto: null,
    beforePhoto: null
};

// =================================================================
// INIT
// =================================================================
window.addEventListener('load', () => {
    const user = Auth.getCurrent();
    if (user) {
        AppState.user = user;
        showApp();
    } else {
        document.getElementById('authScreen').style.display = 'block';
    }

    // Online/offline
    window.addEventListener('offline', () => {
        document.getElementById('mapOfflineBanner').style.display = 'block';
        showToast('‚úàÔ∏è', 'Modo offline', 'Usando dados do cache');
    });
    window.addEventListener('online', () => {
        document.getElementById('mapOfflineBanner').style.display = 'none';
        showToast('üåê', 'Online', 'Conex√£o restaurada!');
    });
});

// =================================================================
// AUTH FUNCTIONS
// =================================================================
function switchAuthTab(tab, el) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
}

function toggleTurma() {
    const role = document.getElementById('regRole').value;
    document.getElementById('turmaGroup').style.display = role === 'aluno' ? 'block' : 'none';
}

function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errEl = document.getElementById('loginError');

    if (!email || !password) {
        errEl.textContent = 'Preencha e-mail e senha';
        errEl.classList.remove('hidden');
        return;
    }

    const result = Auth.login(email, password);
    if (result.error) {
        errEl.textContent = result.error;
        errEl.classList.remove('hidden');
        return;
    }

    AppState.user = result.user;
    document.getElementById('authScreen').style.display = 'none';
    showApp();
}

function register() {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;
    const role = document.getElementById('regRole').value;
    const turma = role === 'aluno' ? document.getElementById('regTurma').value : null;
    const errEl = document.getElementById('regError');

    if (!name || !email || !password) {
        errEl.textContent = 'Preencha todos os campos';
        errEl.classList.remove('hidden');
        return;
    }

    if (password.length < 6) {
        errEl.textContent = 'Senha deve ter pelo menos 6 caracteres';
        errEl.classList.remove('hidden');
        return;
    }

    const result = Auth.register({ name, email, password, role, turma });
    if (result.error) {
        errEl.textContent = result.error;
        errEl.classList.remove('hidden');
        return;
    }

    AppState.user = result.user;
    document.getElementById('authScreen').style.display = 'none';
    showApp();
    showToast('üéâ', 'Conta criada!', `Bem-vindo ao PK Explorer, ${name}!`);
}

function quickLogin() {
    const users = Auth.getUsers();
    let demo = users.find(u => u.email === 'demo@pkexplorer.com');
    if (!demo) {
        Auth.register({ name: 'Maria Santos', email: 'demo@pkexplorer.com', password: '123456', role: 'aluno', turma: '6ANOA', xp: 350, points: 7 });
        demo = Auth.getCurrent();
    } else {
        Auth.setCurrent(demo);
    }
    AppState.user = demo;
    document.getElementById('authScreen').style.display = 'none';
    showApp();
    showToast('‚ö°', 'Acesso r√°pido!', 'Bem-vindo, Maria Santos');
}

function logout() {
    if (!confirm('Deseja sair da sua conta?')) return;
    Auth.clear();
    AppState.user = null;
    AppState.map = null;
    location.reload();
}

// =================================================================
// APP SHELL
// =================================================================
function showApp() {
    const u = AppState.user;
    document.getElementById('appShell').style.display = 'flex';
    document.getElementById('authScreen').style.display = 'none';

    // Update UI with user data
    const initial = u.name.charAt(0).toUpperCase();
    document.getElementById('topbarAvatar').textContent = initial;
    document.getElementById('topbarXP').textContent = `‚≠ê ${u.xp || 350} XP`;
    document.getElementById('welcomeName').textContent = `Ol√°, ${u.name.split(' ')[0]}! üëã`;
    document.getElementById('profileAvatarBig').textContent = initial;
    document.getElementById('profileName').textContent = u.name;
    document.getElementById('profileRole').textContent = u.role === 'professor' ? 'üë®‚Äçüè´ Professor' : `üë®‚Äçüéì Aluno ¬∑ Turma ${formatTurma(u.turma)}`;
    document.getElementById('profileTurma').textContent = formatTurma(u.turma) || '‚Äî';

    navigateTo('home');

    setTimeout(() => {
        renderFeed();
        initMap();
    }, 100);
}

function formatTurma(t) {
    if (!t) return '';
    const map = { '6ANOA': '6¬∫ Ano A', '6ANOB': '6¬∫ Ano B', '7ANOA': '7¬∫ Ano A', '7ANOB': '7¬∫ Ano B', '8ANOA': '8¬∫ Ano A', '8ANOB': '8¬∫ Ano B', '9ANO': '9¬∫ Ano' };
    return map[t] || t;
}

// =================================================================
// NAVIGATION
// =================================================================
function navigateTo(screen) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    document.getElementById('screen-' + screen)?.classList.add('active');
    document.getElementById('nav-' + screen)?.classList.add('active');

    AppState.currentScreen = screen;

    if (screen === 'map' && AppState.map) {
        setTimeout(() => AppState.map.resize(), 50);
    }
}

// =================================================================
// MAP
// =================================================================
// Map layer styles
const MAP_LAYERS = {
    streets: {
        version: 8,
        sources: { 
            osm: { 
                type: 'raster', 
                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], 
                tileSize: 256,
                attribution: '¬© OpenStreetMap'
            } 
        },
        layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
    },
    topo: {
        version: 8,
        sources: {
            topo: {
                type: 'raster',
                tiles: ['https://a.tile.opentopomap.org/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '¬© OpenTopoMap'
            }
        },
        layers: [{ id: 'topo', type: 'raster', source: 'topo' }]
    },
    satellite: {
        version: 8,
        sources: {
            satellite: {
                type: 'raster',
                tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                tileSize: 256,
                attribution: '¬© Esri'
            }
        },
        layers: [{ id: 'satellite', type: 'raster', source: 'satellite' }]
    }
};

let currentLayer = 'streets';

function initMap() {
    if (AppState.map) return;

    AppState.map = new maplibregl.Map({
        container: 'map',
        style: MAP_LAYERS.streets,
        center: [-44.493456, -5.291234],
        zoom: 14,
        pitch: 0,
        bearing: 0
    });

    AppState.map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
    
    // Enhanced GPS with tracking and rotation
    const geolocate = new maplibregl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true,
            timeout: 6000
        },
        trackUserLocation: true,
        showUserHeading: true,
        showAccuracyCircle: true
    });
    
    AppState.map.addControl(geolocate, 'bottom-right');
    
    // Auto-activate GPS on map load
    AppState.map.on('load', () => {
        geolocate.trigger();
    });

    // Track user orientation on mobile
    if (window.DeviceOrientationEvent && 'ontouchstart' in window) {
        window.addEventListener('deviceorientation', (e) => {
            if (e.alpha !== null && AppState.map) {
                AppState.map.setBearing(-e.alpha);
            }
        });
    }

    const samplePoints = [
        { name: 'Igreja Matriz', lat: -5.291234, lng: -44.493456, status: 'approved', category: 'igreja' },
        { name: 'Pra√ßa Central', lat: -5.292000, lng: -44.494000, status: 'approved', category: 'praca' },
        { name: 'Esta√ß√£o Ferrovi√°ria', lat: -5.290000, lng: -44.495000, status: 'pending', category: 'patrimonio' },
        { name: 'Mercado Municipal', lat: -5.293000, lng: -44.492000, status: 'approved', category: 'comercio' },
        { name: 'Casa da Cultura', lat: -5.291800, lng: -44.492800, status: 'pending', category: 'patrimonio' }
    ];

    samplePoints.forEach(p => addMapMarker(p));
}

function toggleLayerPanel() {
    const panel = document.getElementById('layerPanel');
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
}

function changeMapLayer(layerType, element) {
    if (layerType === currentLayer) return;
    
    // Update radio buttons
    document.querySelectorAll('.layer-option input[type="radio"]').forEach(r => r.checked = false);
    element.querySelector('input[type="radio"]').checked = true;
    
    // Save current view
    const center = AppState.map.getCenter();
    const zoom = AppState.map.getZoom();
    const bearing = AppState.map.getBearing();
    const pitch = AppState.map.getPitch();
    
    // Save markers
    const markers = AppState.markers.slice();
    
    // Change style
    AppState.map.setStyle(MAP_LAYERS[layerType]);
    currentLayer = layerType;
    
    // Restore view and markers after style loads
    AppState.map.once('styledata', () => {
        AppState.map.setCenter(center);
        AppState.map.setZoom(zoom);
        AppState.map.setBearing(bearing);
        AppState.map.setPitch(pitch);
        
        // Re-add markers
        markers.forEach(({ point }) => {
            // Remove old marker
            const oldMarker = AppState.markers.find(m => m.point.name === point.name);
            if (oldMarker) {
                oldMarker.marker.remove();
            }
        });
        
        // Clear markers array
        AppState.markers = [];
        
        // Re-add all markers
        const samplePoints = [
            { name: 'Igreja Matriz', lat: -5.291234, lng: -44.493456, status: 'approved', category: 'igreja' },
            { name: 'Pra√ßa Central', lat: -5.292000, lng: -44.494000, status: 'approved', category: 'praca' },
            { name: 'Esta√ß√£o Ferrovi√°ria', lat: -5.290000, lng: -44.495000, status: 'pending', category: 'patrimonio' },
            { name: 'Mercado Municipal', lat: -5.293000, lng: -44.492000, status: 'approved', category: 'comercio' },
            { name: 'Casa da Cultura', lat: -5.291800, lng: -44.492800, status: 'pending', category: 'patrimonio' }
        ];
        samplePoints.forEach(p => addMapMarker(p));
    });
    
    showToast('üó∫Ô∏è', 'Camada alterada', `Visualizando: ${layerType === 'streets' ? 'Mapa de Ruas' : layerType === 'topo' ? 'Topogr√°fico' : 'Sat√©lite'}`);
    toggleLayerPanel();
}

function addMapMarker(point) {
    const colors = { approved: '#10B981', pending: '#FF8C00', rejected: '#8B1A1A' };
    const icons = { 
        igreja: '‚õ™', 
        praca: 'üå≥', 
        patrimonio: 'üèõÔ∏è', 
        comercio: 'üè™', 
        escola: 'üè´',
        residencia: 'üè†',
        'marco-geo': 'üóª',
        'curiosidade': 'üí°'
    };
    
    // Create custom marker element with icon
    const el = document.createElement('div');
    el.style.cssText = `
        width:36px;
        height:36px;
        border-radius:50%;
        background:${colors[point.status] || '#FF8C00'};
        border:3px solid white;
        box-shadow:0 3px 12px rgba(0,0,0,0.4);
        cursor:pointer;
        transition:all 0.3s;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:18px;
        animation:markerPulse 2s infinite;
    `;
    el.innerHTML = icons[point.category] || 'üìç';
    
    el.onmouseenter = () => {
        el.style.transform = 'scale(1.4)';
        el.style.boxShadow = '0 6px 20px rgba(0,0,0,0.5)';
    };
    el.onmouseleave = () => {
        el.style.transform = 'scale(1)';
        el.style.boxShadow = '0 3px 12px rgba(0,0,0,0.4)';
    };
    
    // Add pulse animation style if not exists
    if (!document.getElementById('markerPulseStyle')) {
        const style = document.createElement('style');
        style.id = 'markerPulseStyle';
        style.textContent = `
            @keyframes markerPulse {
                0%, 100% { box-shadow: 0 3px 12px rgba(0,0,0,0.4); }
                50% { box-shadow: 0 3px 20px rgba(196,163,90,0.6); }
            }
        `;
        document.head.appendChild(style);
    }

    const statusLabel = { approved: '‚úÖ Aprovado', pending: '‚è≥ Pendente', rejected: '‚ùå Rejeitado' };
    
    // Click handler to open detail
    el.onclick = () => {
        // Find point ID from POINT_DETAILS
        const pointId = Object.keys(POINT_DETAILS).find(id => 
            POINT_DETAILS[id].title === point.name || 
            POINT_DETAILS[id].lat === point.lat
        );
        if (pointId) {
            openPointDetail(parseInt(pointId));
        } else {
            showToast('üìç', point.name, statusLabel[point.status]);
        }
    };

    const marker = new maplibregl.Marker({ element: el })
        .setLngLat([point.lng, point.lat])
        .setPopup(new maplibregl.Popup({ offset: 20, closeButton: false }).setHTML(`
            <div style="font-family:'Crimson Text',serif;padding:0.5rem;">
                <strong style="color:#2D5A3D;font-size:0.95rem;">${point.name}</strong><br>
                <span style="font-size:0.8rem;color:#6B7280;">${statusLabel[point.status]}</span><br>
                <span style="font-size:0.75rem;color:#C4A35A;margin-top:0.25rem;display:block;">üëÜ Clique para ver detalhes</span>
            </div>
        `))
        .addTo(AppState.map);

    AppState.markers.push({ marker, point });
}

function filterMap(filter, el) {
    document.querySelectorAll('.map-filter-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    AppState.markers.forEach(({ marker, point }) => {
        const visible = filter === 'all' || point.status === filter || point.category === filter;
        marker.getElement().style.display = visible ? 'block' : 'none';
    });
}

function searchMap(query) {
    const searchBtn = document.getElementById('clearSearch');
    if (query.trim().length > 0) {
        searchBtn.style.display = 'flex';
    } else {
        searchBtn.style.display = 'none';
        // Show all markers
        AppState.markers.forEach(({ marker }) => {
            marker.getElement().style.display = 'block';
        });
        return;
    }
    
    const lowerQuery = query.toLowerCase().trim();
    let foundAny = false;
    
    AppState.markers.forEach(({ marker, point }) => {
        const matches = 
            point.name.toLowerCase().includes(lowerQuery) ||
            point.category?.toLowerCase().includes(lowerQuery) ||
            point.status?.toLowerCase().includes(lowerQuery);
        
        marker.getElement().style.display = matches ? 'block' : 'none';
        
        if (matches && !foundAny) {
            foundAny = true;
            // Center on first match
            AppState.map.flyTo({
                center: [point.lng, point.lat],
                zoom: 16,
                duration: 1000
            });
        }
    });
    
    if (!foundAny) {
        showToast('üîç', 'Nenhum ponto encontrado', `Nenhum resultado para "${query}"`);
    }
}

function clearMapSearch() {
    document.getElementById('mapSearch').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    AppState.markers.forEach(({ marker }) => {
        marker.getElement().style.display = 'block';
    });
    showToast('‚úì', 'Busca limpa', 'Mostrando todos os pontos');
}

// =================================================================
// REGISTER WIZARD
// =================================================================
function openRegisterModal() {
    AppState.wizardStep = 0;
    AppState.mainPhoto = null;
    AppState.beforePhoto = null;
    document.getElementById('pointName').value = '';
    document.getElementById('pointCategory').value = '';
    document.getElementById('pointDesc').value = '';
    document.getElementById('charCount').textContent = '0';
    document.getElementById('termsCheck').checked = false;
    document.getElementById('duplicateWarning').innerHTML = '';
    updateWizardUI();
    getLocation();
    document.getElementById('registerModal').classList.add('active');
}

function closeRegisterModal() {
    document.getElementById('registerModal').classList.remove('active');
}

function wizardNext() {
    if (!validateWizardStep()) return;
    if (AppState.wizardStep < 2) {
        AppState.wizardStep++;
        updateWizardUI();
    } else {
        submitPoint();
    }
}

function wizardPrev() {
    if (AppState.wizardStep > 0) {
        AppState.wizardStep--;
        updateWizardUI();
    }
}

function updateWizardUI() {
    const step = AppState.wizardStep;
    document.querySelectorAll('.wizard-page').forEach((p, i) => p.classList.toggle('active', i === step));
    document.querySelectorAll('.wizard-step').forEach((s, i) => {
        s.className = 'wizard-step' + (i === step ? ' active' : i < step ? ' done' : '');
    });
    document.getElementById('wizardBackBtn').style.display = step > 0 ? 'block' : 'none';
    document.getElementById('wizardNextBtn').textContent = step === 2 ? '‚úì Enviar' : 'Pr√≥ximo ‚Üí';
}

function validateWizardStep() {
    const step = AppState.wizardStep;
    if (step === 0) {
        if (!document.getElementById('pointName').value.trim()) { showToast('‚ö†Ô∏è', 'Campo obrigat√≥rio', 'Digite o nome do local'); return false; }
        if (!document.getElementById('pointCategory').value) { showToast('‚ö†Ô∏è', 'Campo obrigat√≥rio', 'Selecione uma categoria'); return false; }
        if (document.getElementById('pointDesc').value.length < 100) { showToast('‚ö†Ô∏è', 'Descri√ß√£o curta', 'Escreva pelo menos 100 caracteres'); return false; }
    }
    if (step === 1) {
        if (!AppState.mainPhoto) { showToast('üì∑', 'Foto necess√°ria', 'Tire ou selecione uma foto do local'); return false; }
    }
    if (step === 2) {
        if (!document.getElementById('termsCheck').checked) { showToast('‚ö†Ô∏è', 'Aceite os termos', 'Confirme as declara√ß√µes para prosseguir'); return false; }
    }
    return true;
}

async function submitPoint() {
    const point = {
        id: Date.now().toString(),
        name: document.getElementById('pointName').value.trim(),
        category: document.getElementById('pointCategory').value,
        description: document.getElementById('pointDesc').value.trim(),
        era: document.getElementById('pointEra').value,
        sources: document.getElementById('pointSources').value.trim(),
        interviewee: document.getElementById('pointInterviewee').value.trim(),
        lat: AppState.location?.lat || -5.291234,
        lng: AppState.location?.lng || -44.493456,
        authorId: AppState.user?.id,
        turma: AppState.user?.turma,
        status: 'pending',
        createdAt: new Date().toISOString()
    };

    // Save to IndexedDB
    await savePointToDB(point);

    // Add to map
    addMapMarker({ ...point, name: point.name });

    // Award XP
    if (AppState.user) {
        AppState.user.xp = (AppState.user.xp || 0) + 75;
        AppState.user.points = (AppState.user.points || 0) + 1;
        Auth.setCurrent(AppState.user);
        document.getElementById('topbarXP').textContent = `‚≠ê ${AppState.user.xp} XP`;
    }

    closeRegisterModal();
    showToast('üéâ', 'Ponto cadastrado!', `"${point.name}" enviado para aprova√ß√£o. +75 XP!`);
    navigateTo('map');
}

// =================================================================
// INDEXEDDB
// =================================================================
let db = null;

async function getDB() {
    if (db) return db;
    return new Promise((resolve, reject) => {
        const req = indexedDB.open('pk_explorer', 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore('points', { keyPath: 'id' });
        req.onsuccess = e => { db = e.target.result; resolve(db); };
        req.onerror = reject;
    });
}

async function savePointToDB(point) {
    const database = await getDB();
    return new Promise((resolve, reject) => {
        const tx = database.transaction('points', 'readwrite');
        tx.objectStore('points').put(point);
        tx.oncomplete = resolve;
        tx.onerror = reject;
    });
}

// =================================================================
// LOCATION
// =================================================================
function getLocation() {
    if (!navigator.geolocation) {
        document.getElementById('locationAddress').textContent = 'GPS n√£o dispon√≠vel';
        return;
    }
    document.getElementById('locationAddress').textContent = 'Obtendo localiza√ß√£o...';
    navigator.geolocation.getCurrentPosition(pos => {
        AppState.location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        document.getElementById('locationCoords').textContent = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
        document.getElementById('locationAddress').textContent = '‚úÖ Localiza√ß√£o obtida';
    }, () => {
        document.getElementById('locationAddress').textContent = '‚ö†Ô∏è GPS negado ‚Äî usando localiza√ß√£o padr√£o';
    });
}

function refreshLocation() { getLocation(); }

function updateCharCount() {
    const len = document.getElementById('pointDesc').value.length;
    const el = document.getElementById('charCount');
    el.textContent = len;
    el.style.color = len >= 100 ? 'var(--green)' : 'var(--gray)';
}

// =================================================================
// MEDIA UPLOAD
// =================================================================
async function handlePhoto(input, type) {
    const file = input.files[0];
    if (!file) return;

    const wrapId = type === 'main' ? 'mainPhotoPreviewWrap' : 'beforePhotoPreviewWrap';
    const uploadId = type === 'main' ? 'mainPhotoUpload' : null;

    try {
        const options = { maxSizeMB: 1, maxWidthOrHeight: 1920, useWebWorker: true };
        const compressed = await imageCompression(file, options);
        const url = URL.createObjectURL(compressed);
        if (type === 'main') AppState.mainPhoto = compressed;
        else AppState.beforePhoto = compressed;

        // Enhanced preview with remove button
        document.getElementById(wrapId).innerHTML = `
            <div style="position:relative;">
                <img src="${url}" class="media-preview">
                <button onclick="removePhoto('${type}')" style="position:absolute;top:8px;right:8px;width:32px;height:32px;border-radius:50%;background:var(--red);color:white;border:2px solid white;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.3);">√ó</button>
                <div style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.7);color:white;padding:0.35rem 0.75rem;border-radius:12px;font-size:0.75rem;backdrop-filter:blur(4px);">
                    ‚úÖ ${(compressed.size/1024).toFixed(0)}KB
                </div>
            </div>
        `;
        if (uploadId) document.getElementById(uploadId).classList.add('has-file');
        showToast('‚úÖ', 'Foto carregada!', `Comprimida de ${(file.size/1024).toFixed(0)}KB para ${(compressed.size/1024).toFixed(0)}KB`);
    } catch (e) {
        showToast('‚ùå', 'Erro', 'N√£o foi poss√≠vel processar a foto');
    }
}

function removePhoto(type) {
    const wrapId = type === 'main' ? 'mainPhotoPreviewWrap' : 'beforePhotoPreviewWrap';
    const uploadId = type === 'main' ? 'mainPhotoUpload' : null;
    const inputId = type === 'main' ? 'mainPhotoInput' : 'beforePhotoInput';
    
    if (type === 'main') AppState.mainPhoto = null;
    else AppState.beforePhoto = null;
    
    document.getElementById(wrapId).innerHTML = type === 'main' 
        ? '<div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∑</div><div style="font-weight: 600; color: var(--primary);">Tirar foto ou escolher arquivo</div><div style="font-size: 0.8rem; color: var(--gray);">JPEG, PNG ‚Äî m√°x. 10MB</div>'
        : '<div style="font-size: 1.5rem; margin-bottom: 0.35rem;">üñºÔ∏è</div><div style="font-size: 0.875rem; color: var(--gray);">Foto de como era antes (digitalizada)</div>';
    
    if (uploadId) document.getElementById(uploadId).classList.remove('has-file');
    document.getElementById(inputId).value = '';
    
    showToast('üóëÔ∏è', 'Foto removida', 'Escolha outra foto se desejar');
}

function handleAudio(input) {
    const file = input.files[0];
    if (!file) return;
    document.getElementById('audioLabel').textContent = `‚úÖ ${file.name}`;
    showToast('üéôÔ∏è', '√Åudio adicionado!', file.name);
}

// =================================================================
// MISSIONS RENDER
// =================================================================
function renderMissions() {
    const missions = [
        { 
            icon: '‚ö°', 
            name: 'Explorador Di√°rio', 
            description: 'Cadastre 1 ponto hist√≥rico hoje',
            type: 'Di√°ria', 
            xp: 50, 
            progress: 0, 
            total: 1, 
            tag: 'daily' 
        },
        { 
            icon: 'üì∏', 
            name: 'Primeiro Registro', 
            description: 'Cadastre seu primeiro ponto no mapa',
            type: 'Explora√ß√£o', 
            xp: 100, 
            progress: 1, 
            total: 1, 
            tag: 'main', 
            done: true 
        },
        { 
            icon: 'üéôÔ∏è', 
            name: 'Mem√≥rias Vivas', 
            description: 'Grave entrevistas com 3 moradores antigos',
            type: 'Entrevista', 
            xp: 200, 
            progress: 1, 
            total: 3, 
            tag: 'main' 
        },
        { 
            icon: 'üó∫Ô∏è', 
            name: 'Explorador da Semana', 
            description: 'Cadastre 5 pontos diferentes esta semana',
            type: 'Semanal', 
            xp: 300, 
            progress: 2, 
            total: 5, 
            tag: 'weekly' 
        }
    ];

    document.getElementById('missionsContent').innerHTML = missions.map(m => {
        const pct = Math.round((m.progress / m.total) * 100);
        const tagColors = { daily: 'var(--orange)', weekly: 'var(--blue)', main: 'var(--primary)' };
        return `
            <div style="background:var(--white);border:2px solid var(--gold);border-radius:12px;padding:1.25rem;margin-bottom:0.75rem;${m.done ? 'opacity:0.6;' : ''}">
                <div style="display:flex;gap:1rem;align-items:flex-start;margin-bottom:0.75rem;">
                    <div style="font-size:2rem;">${m.icon}</div>
                    <div style="flex:1;">
                        <div style="font-weight:700;color:var(--primary);font-size:1.05rem;margin-bottom:0.25rem;">${m.name}</div>
                        <div style="font-size:0.9rem;color:var(--gray);margin-bottom:0.5rem;">${m.description}</div>
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                            <span style="background:${tagColors[m.tag]}20;color:${tagColors[m.tag]};padding:0.25rem 0.7rem;border-radius:10px;font-size:0.75rem;font-weight:700;">${m.tag === 'daily' ? '‚ö° Di√°ria' : m.tag === 'weekly' ? 'üìÖ Semanal' : 'üéØ Principal'}</span>
                            <span style="background:rgba(196,163,90,0.2);color:var(--gold);padding:0.25rem 0.7rem;border-radius:10px;font-size:0.75rem;font-weight:700;">+${m.xp} XP</span>
                        </div>
                    </div>
                </div>
                <div style="height:8px;background:var(--paper-dark);border-radius:4px;overflow:hidden;margin-bottom:0.65rem;">
                    <div style="height:100%;background:linear-gradient(90deg,var(--primary),var(--gold));border-radius:4px;width:${pct}%;transition:width 0.8s;"></div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.85rem;color:var(--gray);font-weight:600;">${m.progress}/${m.total} completo ${m.done ? '‚úÖ' : ''}</span>
                    ${!m.done ? `<button onclick="completeMission('${m.name}', ${m.xp})" style="padding:0.5rem 1.25rem;background:var(--primary);color:white;border:none;border-radius:20px;cursor:pointer;font-family:'Crimson Text',serif;font-size:0.9rem;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='#1d3d28'" onmouseout="this.style.background='var(--primary)'">Come√ßar ‚Üí</button>` : '<span style="color:var(--green);font-size:0.9rem;font-weight:700;">‚úì Conclu√≠da!</span>'}
                </div>
            </div>
        `;
    }).join('');
}

function completeMission(name, xp) {
    if (AppState.user) {
        AppState.user.xp = (AppState.user.xp || 0) + xp;
        Auth.setCurrent(AppState.user);
        document.getElementById('topbarXP').textContent = `‚≠ê ${AppState.user.xp} XP`;
    }
    showToast('üéâ', 'Miss√£o iniciada!', `${name} ‚Äî Boa sorte! +${xp} XP ao completar`);
}

// =================================================================
// FEED RENDER
// =================================================================
// Global feed data
let ALL_FEED_POINTS = [];
let currentFeedFilter = 'all';
let currentCategoryFilter = 'all';

function renderFeed() {
    ALL_FEED_POINTS = [
        { id: 1, title: 'Igreja Matriz S√£o Sebasti√£o', author: 'Maria S.', turma: '6¬∫A', turmaCode: '6ANOA', category: '‚õ™ Igreja', categoryCode: 'igreja', date: 'Hoje', likes: 24, img: 'https://images.unsplash.com/photo-1548625149-fc4a29cf7092?w=400&h=220&fit=crop', description: 'Igreja cat√≥lica constru√≠da em 1920, representa um dos principais marcos hist√≥ricos da cidade. Sua arquitetura em estilo neog√≥tico apresenta elementos √∫nicos preservados desde sua funda√ß√£o.' },
        { id: 2, title: 'Pra√ßa Central S√£o Sebasti√£o', author: 'Jo√£o P.', turma: '7¬∫A', turmaCode: '7ANOA', category: 'üå≥ Pra√ßa', categoryCode: 'praca', date: 'Hoje', likes: 18, img: 'https://images.unsplash.com/photo-1561731216-c3a4d99437d5?w=400&h=220&fit=crop', description: 'Principal ponto de encontro da popula√ß√£o desde 1945. A pra√ßa foi reformada em 1980 mantendo caracter√≠sticas originais como o coreto central.' },
        { id: 3, title: 'Antiga Esta√ß√£o Ferrovi√°ria', author: 'Ana C.', turma: '8¬∫A', turmaCode: '8ANOA', category: 'üöÇ Patrim√¥nio', categoryCode: 'patrimonio', date: 'Ontem', likes: 31, img: 'https://images.unsplash.com/photo-1474487548417-781cb71495f3?w=400&h=220&fit=crop', description: 'Esta√ß√£o constru√≠da em 1935 que conectava a cidade ao interior do estado. Desativada em 1970 ap√≥s a expans√£o rodovi√°ria, hoje √© tombada como patrim√¥nio hist√≥rico.' },
        { id: 4, title: 'Mercado Municipal', author: 'Carlos R.', turma: '6¬∫A', turmaCode: '6ANOA', category: 'üè™ Com√©rcio', categoryCode: 'comercio', date: 'Ontem', likes: 15, img: 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=220&fit=crop', description: 'Mercado inaugurado em 1978, principal ponto de com√©rcio local.' }
    ];
    
    updateFeedDisplay();
}

function updateFeedDisplay() {
    let filtered = ALL_FEED_POINTS;
    
    // Filter by turma
    if (currentFeedFilter === 'minha-turma' && AppState.user) {
        filtered = filtered.filter(p => p.turmaCode === AppState.user.turma);
    }
    
    // Filter by category
    if (currentCategoryFilter !== 'all') {
        filtered = filtered.filter(p => p.categoryCode === currentCategoryFilter);
    }
    
    if (filtered.length === 0) {
        document.getElementById('feedContent').innerHTML = `
            <div style="text-align:center;padding:3rem 1rem;color:var(--gray);">
                <div style="font-size:3rem;margin-bottom:0.75rem;">üîç</div>
                <div style="font-weight:600;margin-bottom:0.35rem;">Nenhum ponto encontrado</div>
                <div style="font-size:0.85rem;">Tente ajustar os filtros</div>
            </div>
        `;
        return;
    }

    document.getElementById('feedContent').innerHTML = filtered.map((p, i) => `
        <div class="feed-card" data-turma="${p.turmaCode}" data-category="${p.categoryCode}" style="background:var(--white);border:2px solid var(--gold);border-radius:14px;overflow:hidden;margin-bottom:1rem;cursor:pointer;transition:transform 0.2s;" onclick="openPointDetail(${p.id})" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
            <img src="${p.img}" style="width:100%;height:180px;object-fit:cover;" alt="${p.title}">
            <div style="padding:1rem;">
                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                    <span style="background:rgba(45,90,61,0.1);color:var(--primary);padding:0.2rem 0.6rem;border-radius:10px;font-size:0.75rem;font-weight:600;">${p.category}</span>
                    <span style="font-size:0.75rem;color:var(--gold);font-style:italic;">${p.date}</span>
                </div>
                <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--primary);margin-bottom:0.5rem;">${p.title}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;padding-top:0.75rem;border-top:1px solid var(--paper-dark);">
                    <span style="font-size:0.8rem;color:var(--gray);">üë§ ${p.author} ¬∑ Turma ${p.turma}</span>
                    <button onclick="event.stopPropagation();this.textContent=this.textContent.includes('ü§ç')?'‚ù§Ô∏è '+(${p.likes}+1):'ü§ç ${p.likes}'" style="background:none;border:none;cursor:pointer;font-size:0.875rem;color:var(--gray);">ü§ç ${p.likes}</button>
                </div>
            </div>
        </div>
    `).join('');
}

function filterFeed(filter, el) {
    document.querySelectorAll('.feed-filter').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    currentFeedFilter = filter;
    updateFeedDisplay();
}

function filterFeedCategory(category, el) {
    document.querySelectorAll('.feed-filter-cat').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    currentCategoryFilter = category;
    updateFeedDisplay();
}

// Point details data
const POINT_DETAILS = {
    1: { title: 'Igreja Matriz S√£o Sebasti√£o', category: '‚õ™ Igreja', author: 'Maria S.', turma: '6¬∫A', img: 'https://images.unsplash.com/photo-1548625149-fc4a29cf7092?w=800&h=400&fit=crop', description: 'Igreja cat√≥lica constru√≠da em 1920, representa um dos principais marcos hist√≥ricos da cidade. Sua arquitetura em estilo neog√≥tico apresenta elementos √∫nicos preservados desde sua funda√ß√£o. O pr√©dio passou por restaura√ß√£o em 1980 que manteve suas caracter√≠sticas originais. √â local de festas religiosas tradicionais que re√∫nem toda a comunidade.', lat: -5.291234, lng: -44.493456, status: 'approved' },
    2: { title: 'Pra√ßa Central S√£o Sebasti√£o', category: 'üå≥ Pra√ßa', author: 'Jo√£o P.', turma: '7¬∫A', img: 'https://images.unsplash.com/photo-1561731216-c3a4d99437d5?w=800&h=400&fit=crop', description: 'Principal ponto de encontro da popula√ß√£o desde 1945. A pra√ßa foi reformada em 1980 mantendo caracter√≠sticas originais como o coreto central. Aos domingos, a pra√ßa ainda √© palco de apresenta√ß√µes de bandas locais. Em 2010 recebeu o t√≠tulo de Patrim√¥nio Cultural Municipal.', lat: -5.292000, lng: -44.494000, status: 'approved' },
    3: { title: 'Antiga Esta√ß√£o Ferrovi√°ria', category: 'üöÇ Patrim√¥nio', author: 'Ana C.', turma: '8¬∫A', img: 'https://images.unsplash.com/photo-1474487548417-781cb71495f3?w=800&h=400&fit=crop', description: 'Esta√ß√£o constru√≠da em 1935 que conectava a cidade ao interior do estado. Desativada em 1970 ap√≥s a expans√£o rodovi√°ria, hoje √© tombada como patrim√¥nio hist√≥rico municipal. O pr√©dio original de tijolos vermelhos resistiu ao tempo e ainda guarda trilhos e plataformas originais.', lat: -5.290000, lng: -44.495000, status: 'pending' }
};

let currentPointId = null;

function openPointDetail(id) {
    currentPointId = id;
    const point = POINT_DETAILS[id];
    if (!point) return;
    
    // Update modal content
    document.getElementById('detailModalTitle').textContent = point.title;
    document.getElementById('detailModalCategory').textContent = point.category;
    document.getElementById('detailModalAuthor').textContent = `üë§ ${point.author} ¬∑ Turma ${point.turma}`;
    document.getElementById('detailModalStatus').textContent = point.status === 'approved' ? '‚úÖ Aprovado' : '‚è≥ Pendente';
    document.getElementById('detailModalImage').src = point.img;
    document.getElementById('detailModalDescription').textContent = point.description;
    
    // Show modal
    document.getElementById('pointDetailModal').classList.add('active');
}

async function sharePoint() {
    if (!currentPointId) return;
    
    const point = POINT_DETAILS[currentPointId];
    if (!point) return;
    
    const shareData = {
        title: `üìç ${point.title} ‚Äî PK Explorer`,
        text: `Descobri este ponto hist√≥rico: ${point.title}\n\n${point.description.substring(0, 100)}...`,
        url: window.location.origin + `?ponto=${currentPointId}`
    };
    
    try {
        // Try native Web Share API (works on mobile)
        if (navigator.share) {
            await navigator.share(shareData);
            showToast('‚úÖ', 'Compartilhado!', 'Ponto compartilhado com sucesso');
        } else {
            // Fallback: Copy link to clipboard
            const link = shareData.url;
            await navigator.clipboard.writeText(link);
            showToast('üìã', 'Link copiado!', 'Cole o link onde quiser compartilhar');
        }
    } catch (err) {
        if (err.name !== 'AbortError') {
            // Manual fallback
            const link = shareData.url;
            const textArea = document.createElement('textarea');
            textArea.value = link;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('üìã', 'Link copiado!', 'Cole onde quiser compartilhar');
            } catch (e) {
                showToast('‚ùå', 'Erro', 'N√£o foi poss√≠vel compartilhar');
            }
            
            document.body.removeChild(textArea);
        }
    }
}

// =================================================================
// TOAST NOTIFICATIONS
// =================================================================
function showToast(icon, title, body) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div>
            <div class="toast-title">${title}</div>
            <div class="toast-body">${body}</div>
        </div>
    `;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.transition = 'all 0.3s';
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 3500);
}
</script>
</body>
</html>
