<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2D5A3D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="PK Explorer">
    <meta name="description" content="Explore e mapeie a hist√≥ria de Presidente Dutra">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons (fallback to emoji data URI if files don't exist) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
    <link rel="apple-touch-icon" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%232D5A3D' rx='40'/><text y='140' x='96' font-size='120' text-anchor='middle'>üó∫Ô∏è</text></svg>">
    
    <title>PK Explorer ‚Äî Sistema Completo</title>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <style>
        /* ==================== RESET & VARS ==================== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --primary: #2D5A3D;
            --gold: #C4A35A;
            --gold-light: #E8C97A;
            --paper: #F5F1E8;
            --paper-dark: #EAE4D4;
            --ink: #1A1A2E;
            --white: #FFFEF9;
            --red: #8B1A1A;
            --orange: #D4700A;
            --blue: #1A4A6B;
            --green: #10B981;
            --gray: #6B7280;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Crimson Text', serif;
            background: var(--paper);
            color: var(--ink);
            font-size: 17px; /* Aumentado para melhor legibilidade no celular */
        }

        /* ==================== APP SHELL ==================== */
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* ==================== TOP NAVBAR ==================== */
        .topbar {
            background: var(--primary);
            border-bottom: 3px solid var(--gold);
            padding: 0.75rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 50;
        }
        
        .topbar-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .topbar-back {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .topbar-back:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .topbar-back:active {
            transform: scale(0.95);
        }

        .topbar-logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.35rem;
            color: var(--gold);
            letter-spacing: 0.5px;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .topbar-notification {
            position: relative;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .topbar-notification:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--red);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid var(--primary);
            animation: badgePulse 2s infinite;
        }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .topbar-xp {
            background: rgba(196,163,90,0.2);
            border: 1px solid var(--gold);
            color: var(--gold-light);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .topbar-avatar {
            width: 34px; height: 34px;
            border-radius: 50%;
            background: var(--gold);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            border: 2px solid var(--gold-light);
        }

        /* ==================== SCREEN CONTAINER ==================== */
        .screens {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .screen {
            position: absolute;
            inset: 0;
            overflow-y: auto;
            display: none;
            background: var(--paper);
            animation: screenIn 0.25s ease-out;
        }

        .screen.active { display: block; }

        @keyframes screenIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-200px) rotate(360deg); opacity: 0; }
        }
        
        .card {
            animation: slideUp 0.4s ease-out;
        }
        
        .btn:active {
            transform: scale(0.95);
        }

        /* ==================== BOTTOM NAV ==================== */
        .bottom-nav {
            background: var(--white);
            border-top: 3px solid var(--gold);
            display: flex;
            flex-shrink: 0;
            padding-bottom: var(--safe-bottom);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray);
            position: relative;
            border: none;
            background: none;
            font-family: 'Crimson Text', serif;
        }

        .nav-item:hover { color: var(--primary); }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0; left: 15%; right: 15%;
            height: 3px;
            background: var(--gold);
            border-radius: 0 0 4px 4px;
        }

        .nav-icon {
            font-size: 1.4rem;
            margin-bottom: 0.15rem;
            transition: transform 0.2s;
        }

        .nav-item.active .nav-icon { transform: scale(1.1); }

        .nav-label {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .nav-badge {
            position: absolute;
            top: 0.4rem; right: calc(50% - 18px);
            background: var(--red);
            color: var(--white);
            font-size: 0.6rem;
            font-weight: 700;
            width: 16px; height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ==================== AUTH SCREEN ==================== */
        #screen-auth {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            padding: 2rem 1rem;
        }

        .auth-card {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            width: 100%;
            max-width: 440px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo-icon { font-size: 4rem; display: block; margin-bottom: 0.5rem; }

        .auth-logo-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--primary);
        }

        .auth-logo-sub {
            color: var(--gold);
            font-style: italic;
            font-size: 0.9rem;
        }

        .auth-tabs {
            display: flex;
            border: 2px solid var(--gold);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            transition: all 0.2s;
            border: none;
            background: var(--white);
            color: var(--gray);
        }

        .auth-tab.active { background: var(--primary); color: var(--white); }

        .form-group { margin-bottom: 1rem; }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.4rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gold);
            border-radius: 10px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            background: var(--white);
            color: var(--ink);
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-error {
            color: var(--red);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .btn-full {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }

        .btn-full:hover { background: #1d3d28; transform: translateY(-2px); }

        .btn-full.btn-gold { background: var(--gold); color: var(--primary); }
        .btn-full.btn-gold:hover { background: var(--gold-light); }

        .auth-divider {
            text-align: center;
            color: var(--gray);
            font-size: 0.875rem;
            margin: 1rem 0;
            position: relative;
        }

        .auth-divider::before, .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--paper-dark);
        }

        .auth-divider::before { left: 0; }
        .auth-divider::after { right: 0; }

        /* ==================== MAP SCREEN ==================== */
        #map { width: 100%; height: 100%; }

        .map-wrapper { position: relative; height: 100%; }

        .map-fab {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 60px; height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            border: 3px solid var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .map-fab:hover { transform: scale(1.1); background: #1d3d28; }

        .map-layer-btn {
            position: absolute;
            bottom: 1.5rem;
            left: 1.5rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--gold);
            font-size: 1.35rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .map-layer-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .map-layer-panel {
            position: absolute;
            bottom: 5rem;
            left: 1.5rem;
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 15;
            min-width: 200px;
        }

        .layer-option {
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.65rem;
            margin-bottom: 0.35rem;
            font-size: 0.9rem;
        }

        .layer-option:hover {
            background: var(--paper-dark);
        }

        .layer-option input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .map-filters {
            position: absolute;
            top: 4.5rem; left: 1rem; right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .map-search-bar {
            position: absolute;
            top: 1rem; left: 1rem; right: 1rem;
            z-index: 10;
            display: flex;
            gap: 0.5rem;
        }
        
        .map-search-bar input {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 25px;
            border: 2px solid var(--gold);
            background: var(--white);
            font-family: 'Crimson Text', serif;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .map-search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(45,90,61,0.3);
        }
        
        .map-search-bar button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            background: var(--white);
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }
        
        .map-search-bar button:hover {
            background: var(--red);
            color: white;
        }

        .map-filter-btn {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            border: 2px solid var(--gold);
            background: var(--white);
            color: var(--primary);
            font-family: 'Crimson Text', serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .map-filter-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .map-offline-banner {
            position: absolute;
            top: 4rem; left: 1rem; right: 1rem;
            background: var(--orange);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            z-index: 10;
            display: none;
        }

        /* ==================== SECTION SCREENS ==================== */
        .screen-content { padding: 1.25rem; }

        .screen-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gold);
        }

        .screen-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--primary);
        }

        /* ==================== HOME/DASHBOARD ==================== */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary), #1d3d28);
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 1.5rem;
            color: var(--white);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::after {
            content: 'üó∫Ô∏è';
            position: absolute;
            right: 1rem; top: 50%;
            transform: translateY(-50%);
            font-size: 4rem;
            opacity: 0.2;
        }

        .welcome-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.35rem;
            color: var(--gold-light);
            margin-bottom: 0.25rem;
        }

        .welcome-sub { font-size: 0.9rem; opacity: 0.8; }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .quick-stat {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1rem 0.75rem;
            text-align: center;
        }

        .quick-stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .quick-stat-label { font-size: 0.7rem; color: var(--gray); }

        .section-label {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .quick-action {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1.25rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .quick-action:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45,90,61,0.15);
        }

        .quick-action-icon { font-size: 1.75rem; }
        .quick-action-label { font-size: 0.85rem; font-weight: 600; color: var(--primary); text-align: center; }

        .active-mission {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .active-mission:hover { border-color: var(--primary); }

        .mission-icon-wrap {
            width: 44px; height: 44px;
            border-radius: 10px;
            background: rgba(45,90,61,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .mission-info { flex: 1; }
        .mission-name { font-weight: 600; color: var(--primary); font-size: 0.95rem; }
        .mission-xp { font-size: 0.8rem; color: var(--gold); }

        .mission-progress-mini {
            height: 6px;
            background: var(--paper-dark);
            border-radius: 3px;
            margin-top: 0.35rem;
            overflow: hidden;
        }

        .mission-progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--gold)); border-radius: 3px; }

        /* ==================== MODAL ==================== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal-sheet {
            background: var(--white);
            border-radius: 20px 20px 0 0;
            border-top: 3px solid var(--gold);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: sheetUp 0.3s ease-out;
            padding-bottom: var(--safe-bottom);
        }

        @keyframes sheetUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-handle {
            width: 40px; height: 4px;
            background: var(--paper-dark);
            border-radius: 2px;
            margin: 0.75rem auto 0;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--paper-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .modal-close {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--paper-dark);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body { padding: 1.5rem; }

        /* ==================== REGISTRATION WIZARD ==================== */
        .wizard-steps {
            display: flex;
            gap: 0;
            margin-bottom: 1.5rem;
        }

        .wizard-step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            position: relative;
        }

        .wizard-step::after {
            content: '';
            position: absolute;
            top: 16px; left: 50%;
            width: 100%; height: 2px;
            background: var(--paper-dark);
            z-index: 0;
        }

        .wizard-step:last-child::after { display: none; }
        .wizard-step.done::after { background: var(--gold); }

        .wizard-dot {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--paper-dark);
            border: 2px solid var(--paper-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            margin: 0 auto 0.25rem;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .wizard-step.active .wizard-dot { background: var(--primary); color: var(--white); border-color: var(--primary); }
        .wizard-step.done .wizard-dot { background: var(--gold); color: var(--primary); border-color: var(--gold); }

        .wizard-step-label { font-size: 0.65rem; color: var(--gray); }

        .wizard-page { display: none; }
        .wizard-page.active { display: block; }

        .location-card {
            background: var(--paper);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .location-icon { font-size: 1.5rem; }

        .location-info { flex: 1; }
        .location-coords { font-size: 0.8rem; color: var(--gray); }
        .location-address { font-weight: 600; color: var(--primary); font-size: 0.9rem; }

        .char-counter { font-size: 0.75rem; color: var(--gray); text-align: right; margin-top: 0.25rem; }

        .media-upload {
            border: 2px dashed var(--gold);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.75rem;
        }

        .media-upload:hover { border-color: var(--primary); background: rgba(45,90,61,0.03); }
        .media-upload.has-file { border-style: solid; border-color: var(--green); background: rgba(16,185,129,0.05); }

        .media-preview { max-width: 100%; max-height: 160px; border-radius: 8px; }

        textarea.form-input { min-height: 100px; resize: vertical; }

        .wizard-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 2px solid var(--paper-dark);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary); color: var(--white); flex: 1; }
        .btn-primary:hover { background: #1d3d28; }
        .btn-secondary { background: var(--paper-dark); color: var(--primary); }
        .btn-secondary:hover { background: var(--paper); }

        /* ==================== PROFILE SCREEN ==================== */
        .profile-header {
            background: linear-gradient(135deg, var(--primary), #1d3d28);
            padding: 2rem 1.25rem;
            text-align: center;
            color: var(--white);
        }

        .profile-avatar-big {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: var(--gold);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            margin: 0 auto 1rem;
            border: 4px solid var(--gold-light);
        }

        .profile-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--gold-light);
        }

        .profile-role {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .profile-level {
            background: rgba(196,163,90,0.2);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 0.35rem 1.25rem;
            display: inline-block;
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--gold-light);
        }

        .profile-xp-bar {
            margin: 1rem auto;
            max-width: 260px;
        }

        .profile-xp-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-bottom: 0.35rem;
        }

        .profile-xp-track {
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .profile-xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: 4px;
        }

        .profile-section { padding: 1.25rem; }

        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.9rem 0;
            border-bottom: 1px solid var(--paper-dark);
        }

        .profile-row:last-child { border-bottom: none; }
        .profile-row-label { color: var(--gray); font-size: 0.9rem; }
        .profile-row-value { font-weight: 600; color: var(--primary); }

        .btn-logout {
            width: calc(100% - 2.5rem);
            margin: 0 1.25rem 1.25rem;
            padding: 0.875rem;
            background: var(--red);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover { background: #6b1313; }

        /* ==================== NEW PROFILE DESIGN ==================== */
        .profile-header-new {
            background: linear-gradient(135deg, #1e3d28 0%, #2d5a3d 100%);
            padding: 1.5rem 1rem 1rem;
            color: white;
        }
        
        .profile-avatar-container {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .profile-avatar-frame {
            position: relative;
            display: inline-block;
        }
        
        .profile-avatar-big-new {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: var(--gold);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            border: 4px solid var(--gold-light);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3), 0 0 0 8px rgba(196,163,90,0.1);
        }
        
        .profile-camera-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: 3px solid white;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        
        .profile-camera-btn:active {
            transform: scale(0.95);
        }
        
        .profile-info-new {
            text-align: center;
        }
        
        .profile-name-new {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            margin: 0 0 0.25rem 0;
            color: white;
        }
        
        .profile-title-new {
            font-size: 0.95rem;
            color: var(--gold-light);
            margin-bottom: 1rem;
        }
        
        .profile-stats-inline {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-inline {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
        }
        
        .stat-icon {
            font-size: 1.1rem;
        }
        
        .profile-progress-new {
            max-width: 280px;
            margin: 0 auto 1rem;
        }
        
        .progress-track-new {
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-fill-new {
            height: 100%;
            background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%);
            border-radius: 5px;
            transition: width 0.3s;
        }
        
        .progress-label-new {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
            text-align: center;
        }
        
        .btn-explore-now {
            width: calc(100% - 2rem);
            margin: 0 auto;
            padding: 1rem;
            background: var(--gold);
            color: var(--primary);
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 16px rgba(196,163,90,0.4);
            transition: all 0.2s;
        }
        
        .btn-explore-now:active {
            transform: scale(0.98);
        }
        
        /* Missions Card */
        .missions-card {
            background: white;
            margin: 1rem;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .card-header-new {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .card-icon {
            font-size: 1.3rem;
        }
        
        .card-title {
            flex: 1;
        }
        
        .card-menu {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray);
            cursor: pointer;
            padding: 0.25rem;
        }
        
        .missions-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .mission-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--paper);
            border-radius: 10px;
        }
        
        .mission-item.completed {
            background: rgba(45,90,61,0.1);
        }
        
        .mission-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .mission-text {
            flex: 1;
            font-size: 0.9rem;
            color: var(--primary);
        }
        
        .mission-badge {
            background: var(--green);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .mission-progress-inline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .progress-mini {
            width: 60px;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-mini-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 3px;
        }
        
        .progress-text-mini {
            font-size: 0.75rem;
            color: var(--gray);
            white-space: nowrap;
        }
        
        .mission-reward {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(196,163,90,0.1);
            border-radius: 10px;
            margin-bottom: 0.75rem;
        }
        
        .reward-icon {
            font-size: 1.5rem;
        }
        
        .reward-text {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .mission-overall-progress {
            margin-top: 0.75rem;
        }
        
        .progress-track-mission {
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill-mission {
            height: 100%;
            background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%);
            border-radius: 3px;
        }
        
        /* Stats Card */
        .stats-card {
            background: white;
            margin: 1rem;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .ranking-badge {
            background: rgba(196,163,90,0.15);
            color: var(--gold);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 1rem 0;
        }
        
        .stat-box {
            background: var(--paper);
            padding: 0.75rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .stat-icon-big {
            font-size: 2rem;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--gray);
            margin-bottom: 0.25rem;
        }
        
        .stat-number {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .mini-map-container {
            margin-top: 1rem;
        }
        
        .mini-map {
            position: relative;
            height: 100px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }
        
        .mini-map::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.1) 10px,
                rgba(255,255,255,0.1) 20px
            );
        }
        
        .map-pin {
            position: absolute;
            font-size: 1.5rem;
            animation: pinBounce 2s infinite;
        }
        
        @keyframes pinBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .btn-view-map {
            width: 100%;
            padding: 0.75rem;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-view-map:active {
            transform: scale(0.98);
        }
        
        /* Achievement Card */
        .achievement-card {
            background: white;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .achievement-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .achievement-icon {
            font-size: 1.3rem;
        }
        
        .achievement-title {
            flex: 1;
        }
        
        .achievement-item {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: var(--paper);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .achievement-badge {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .achievement-info {
            flex: 1;
        }
        
        .achievement-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.35rem;
        }
        
        .achievement-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        
        .progress-badge {
            flex: 1;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-badge-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 3px;
        }
        
        .achievement-list-compact {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .achievement-mini {
            font-size: 0.85rem;
            color: var(--gray);
            padding: 0.5rem;
            background: var(--paper);
            border-radius: 8px;
        }
        
        .achievement-mini-map {
            display: flex;
            gap: 0.75rem;
            font-size: 1.25rem;
            padding: 0.5rem;
            background: var(--paper);
            border-radius: 8px;
            justify-content: center;
        }
        
        /* Personalization Card */
        .personalization-card {
            background: white;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .personalization-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        
        .personalization-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .avatar-preview, .map-preview {
            display: flex;
            gap: 0.5rem;
        }
        
        .avatar-option {
            width: 50px;
            height: 50px;
            background: var(--paper);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
        }
        
        .map-option {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .map-option:hover {
            transform: scale(1.05);
        }
        
        /* Motivation Footer */
        .motivation-footer {
            text-align: center;
            padding: 1rem;
            color: var(--gray);
            font-size: 0.9rem;
            font-style: italic;
        }

        /* ==================== FEEDBACK SCREEN ==================== */
        .feedback-header {
            background: linear-gradient(135deg, #1e3d28 0%, #2d5a3d 100%);
            padding: 2rem 1rem 1.5rem;
            text-align: center;
            color: white;
        }
        
        .feedback-icon {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            animation: pulse 2s infinite;
        }
        
        .feedback-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            margin: 0;
            color: var(--gold-light);
        }
        
        .feedback-content {
            padding: 1.5rem 1rem;
        }
        
        .feedback-question {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .feedback-question p {
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 600;
            margin: 0;
        }
        
        .feedback-textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 2px solid var(--paper-dark);
            border-radius: 12px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 1.5rem;
            background: var(--paper);
            color: var(--primary);
        }
        
        .feedback-textarea:focus {
            outline: none;
            border-color: var(--gold);
            background: white;
        }
        
        .feedback-textarea::placeholder {
            color: var(--gray);
            opacity: 0.6;
        }
        
        .feedback-section-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .feedback-categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .feedback-category {
            background: var(--paper);
            border: 2px solid transparent;
            padding: 1rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Crimson Text', serif;
        }
        
        .feedback-category:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .feedback-category.selected {
            background: white;
            border-color: var(--gold);
            box-shadow: 0 4px 16px rgba(196,163,90,0.3);
        }
        
        .category-icon {
            font-size: 1.75rem;
        }
        
        .category-text {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            text-align: left;
        }
        
        .feedback-rating {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .star-btn {
            background: none;
            border: none;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.2s;
            filter: grayscale(100%);
            opacity: 0.4;
        }
        
        .star-btn.active {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.1);
        }
        
        .star-btn:hover {
            transform: scale(1.15);
        }
        
        .btn-submit-feedback {
            width: 100%;
            padding: 1.25rem;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            box-shadow: 0 6px 20px rgba(45,90,61,0.3);
            transition: all 0.2s;
            font-family: 'Crimson Text', serif;
        }
        
        .btn-submit-feedback:active {
            transform: scale(0.98);
        }
        
        .btn-icon {
            font-size: 1.5rem;
        }
        
        .feedback-thanks {
            text-align: center;
            padding: 2rem 1rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 1.5rem;
        }
        
        .thanks-avatar {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
        }
        
        .thanks-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .thanks-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 0.5rem 0;
        }
        
        .thanks-text {
            font-size: 0.95rem;
            color: var(--gray);
            margin: 0;
        }

        /* ==================== TEACHER PANEL ==================== */
        .teacher-header{background:linear-gradient(135deg,#0F3D2E,#1a5c44);padding:1.5rem 1rem;color:#fff;position:relative;overflow:hidden}
        .teacher-header::before{content:'';position:absolute;top:-50%;right:-10%;width:300px;height:300px;background:radial-gradient(circle,rgba(212,175,55,.1),transparent 70%);border-radius:50%}
        .teacher-top-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;position:relative;z-index:2}
        .teacher-logo{display:flex;align-items:center;gap:.5rem}
        .teacher-logo-icon{font-size:2rem}
        .teacher-logo-text h1{margin:0;font-size:1.25rem;font-family:'Playfair Display',serif;color:#D4AF37}
        .teacher-logo-text p{margin:0;font-size:.75rem;opacity:.9}
        .teacher-actions{display:flex;gap:.5rem}
        .teacher-notif-btn{position:relative;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.15);border:none;color:#fff;font-size:1.25rem;display:flex;align-items:center;justify-content:center;cursor:pointer}
        .notif-badge{position:absolute;top:-2px;right:-2px;background:#e74c3c;color:#fff;border-radius:10px;padding:.15rem .4rem;font-size:.7rem;font-weight:700}
        .teacher-welcome{position:relative;z-index:2;margin-top:.5rem}
        .teacher-welcome h3{margin:0 0 .25rem;font-size:1.5rem;font-family:'Playfair Display',serif}
        .teacher-welcome p{margin:0;font-size:.9rem;opacity:.9}
        .teacher-stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;padding:1rem;margin-top:-2rem;position:relative;z-index:3}
        .stat-card{background:#fff;border-radius:12px;padding:1rem .75rem;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .stat-icon{font-size:1.75rem;margin-bottom:.5rem}
        .stat-value{font-size:1.5rem;font-weight:700;color:#0F3D2E;margin-bottom:.25rem}
        .stat-label{font-size:.75rem;color:#666}
        .section-header{display:flex;justify-content:space-between;align-items:center;padding:1rem;margin-top:.5rem}
        .section-title{display:flex;align-items:center;gap:.5rem;font-size:1.1rem;font-weight:700;color:#0F3D2E}
        .section-title-icon{font-size:1.5rem}
        .approval-list{padding:0 1rem 1rem;display:flex;flex-direction:column;gap:.75rem}
        .approval-card{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.08);display:flex;align-items:center;gap:1rem}
        .student-avatar{width:50px;height:50px;border-radius:50%;flex-shrink:0}
        .approval-info{flex:1}
        .approval-student-name{font-weight:700;color:#0F3D2E;margin-bottom:.25rem}
        .approval-details{font-size:.85rem;color:#666}
        .approval-location{font-weight:600;color:#0F3D2E}
        .approval-actions{display:flex;flex-direction:column;gap:.5rem}
        .btn-approve{background:#27ae60;color:#fff;border:none;padding:.5rem 1rem;border-radius:8px;font-weight:600;font-size:.85rem;cursor:pointer}
        .turma-list{padding:0 1rem 1rem;display:flex;flex-direction:column;gap:.75rem}
        .turma-card{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.08);display:flex;align-items:center;gap:1rem}
        .turma-icon{width:50px;height:50px;background:linear-gradient(135deg,#3498db,#2980b9);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.75rem}
        .turma-info{flex:1}
        .turma-name{font-size:1.1rem;font-weight:700;color:#0F3D2E;margin-bottom:.25rem}
        .turma-stats{font-size:.85rem;color:#666;margin-bottom:.5rem}
        .turma-progress{height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden;margin-bottom:.25rem}
        .turma-progress-fill{height:100%;background:linear-gradient(90deg,#D4AF37,#f1c40f);border-radius:3px}
        .turma-xp{font-size:.75rem;color:#D4AF37;font-weight:600}
        .turma-arrow{font-size:1.5rem;color:#D4AF37}
        .management-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;padding:0 1rem 1rem}
        .management-btn{background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:1.25rem 1rem;display:flex;flex-direction:column;align-items:center;gap:.5rem;cursor:pointer}
        .management-icon{font-size:2.5rem}
        .management-label{font-size:.9rem;font-weight:600;color:#0F3D2E;text-align:center}
        .ranking-list{padding:0 1rem 1rem}
        .ranking-item{background:#fff;border-radius:12px;padding:1rem;margin-bottom:.75rem;display:flex;align-items:center;gap:1rem;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .ranking-medal{font-size:2rem}
        .ranking-info{flex:1}
        .ranking-turma{font-size:1.1rem;font-weight:700;color:#0F3D2E}
        .ranking-xp{font-size:1.25rem;font-weight:700;color:#D4AF37}
        .motivational-footer{text-align:center;padding:1.5rem 1rem;background:linear-gradient(135deg,#fff9e6,#fffef5);margin:1rem;border-radius:12px;color:#0F3D2E;display:flex;align-items:center;justify-content:center;gap:.75rem}
        .footer-icon{font-size:2rem}

        /* ==================== MEM√ìRIAS DO BAIRRO ==================== */
        .memories-header{background:linear-gradient(135deg,#1a5c44,#0F3D2E);color:#fff;padding:1.5rem 1rem;text-align:center}
        .memories-title{font-size:1.5rem;font-weight:700;margin-bottom:0.5rem;font-family:'Playfair Display',serif}
        .memories-subtitle{font-size:0.9rem;opacity:0.9}
        .memories-progress{margin-top:1rem;background:rgba(255,255,255,0.2);border-radius:10px;height:8px;overflow:hidden}
        .memories-progress-fill{background:#D4AF37;height:100%;transition:width 0.3s}
        .memories-stats{display:flex;justify-content:space-around;margin-top:1rem;font-size:0.9rem}
        .memories-filters{padding:1rem;display:flex;gap:0.5rem;overflow-x:auto;-webkit-overflow-scrolling:touch}
        .filter-btn{background:#fff;border:2px solid #0F3D2E;color:#0F3D2E;padding:0.5rem 1rem;border-radius:20px;font-size:0.85rem;font-weight:600;white-space:nowrap;cursor:pointer}
        .filter-btn.active{background:#0F3D2E;color:#fff}
        .photo-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;padding:1rem}
        .photo-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);cursor:pointer;position:relative;transition:transform 0.2s}
        .photo-card:hover{transform:translateY(-4px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .photo-card img{width:100%;height:180px;object-fit:cover}
        .photo-card-info{padding:0.75rem}
        .photo-card-year{color:#D4AF37;font-weight:700;font-size:0.85rem}
        .photo-card-title{font-size:0.9rem;font-weight:600;color:#0F3D2E;margin:0.25rem 0}
        .photo-card-location{font-size:0.75rem;color:#666}
        .photo-locked{opacity:0.5;filter:grayscale(100%)}
        .photo-lock-icon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.5)}
        .photo-badge{position:absolute;top:8px;right:8px;background:#27ae60;color:#fff;padding:0.25rem 0.5rem;border-radius:12px;font-size:0.7rem;font-weight:700}
        
        .photo-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:1000;overflow-y:auto}
        .photo-modal-content{max-width:900px;margin:2rem auto;padding:1rem}
        .photo-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .photo-modal-close{background:none;border:none;color:#fff;font-size:2rem;cursor:pointer}
        .photo-modal-image-container{position:relative;background:#000;border-radius:12px;overflow:hidden;margin-bottom:1rem}
        .photo-modal-image{width:100%;display:block;cursor:zoom-in}
        .photo-modal-tabs{display:flex;gap:0.5rem;margin-bottom:1rem;border-bottom:2px solid #333}
        .photo-tab{background:none;border:none;color:#999;padding:1rem;font-size:0.9rem;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s}
        .photo-tab.active{color:#fff;border-bottom-color:#D4AF37}
        .photo-tab-content{display:none;background:rgba(255,255,255,0.1);border-radius:12px;padding:1.5rem;color:#fff}
        .photo-tab-content.active{display:block}
        
        .compare-slider-container{position:relative;width:100%;overflow:hidden;border-radius:12px}
        .compare-slider{position:relative;overflow:hidden;cursor:ew-resize}
        .compare-before,.compare-after{display:block;width:100%}
        .compare-overlay{position:absolute;top:0;left:0;width:50%;height:100%;overflow:hidden;border-right:3px solid #D4AF37}
        .compare-handle{position:absolute;top:50%;left:50%;width:60px;height:60px;background:#D4AF37;border-radius:50%;transform:translate(-50%,-50%);cursor:ew-resize;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;color:#000;font-size:1.5rem;font-weight:700}
        
        .quiz-container{color:#fff}
        .quiz-question{font-size:1.1rem;font-weight:600;margin-bottom:1.5rem}
        .quiz-options{display:flex;flex-direction:column;gap:0.75rem}
        .quiz-option{background:rgba(255,255,255,0.1);border:2px solid transparent;padding:1rem;border-radius:8px;cursor:pointer;transition:all 0.2s}
        .quiz-option:hover{background:rgba(255,255,255,0.2);border-color:#D4AF37}
        .quiz-option.correct{background:#27ae60;border-color:#27ae60}
        .quiz-option.wrong{background:#e74c3c;border-color:#e74c3c}
        .quiz-feedback{margin-top:1rem;padding:1rem;border-radius:8px;font-weight:600}
        .quiz-feedback.correct{background:rgba(39,174,96,0.2);color:#4ade80}
        .quiz-feedback.wrong{background:rgba(231,76,60,0.2);color:#f87171}
        
        .contribution-item{background:rgba(255,255,255,0.05);border-left:3px solid #D4AF37;padding:1rem;margin-bottom:1rem;border-radius:4px}
        .contribution-author{color:#D4AF37;font-weight:700;font-size:0.9rem;margin-bottom:0.5rem}
        .contribution-date{color:#999;font-size:0.75rem;margin-left:0.5rem}
        .contribution-text{color:#fff;line-height:1.6}
        .contribution-success{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#27ae60;color:#fff;padding:2rem 3rem;border-radius:12px;font-size:1.2rem;font-weight:700;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:fadeInOut 3s}
        @keyframes fadeInOut{0%{opacity:0;transform:translate(-50%,-50%) scale(0.8)}20%{opacity:1;transform:translate(-50%,-50%) scale(1)}80%{opacity:1}100%{opacity:0}}
        
        /* ==================== GEOGRAFIA ==================== */
        .geo-header{background:linear-gradient(135deg,#2563eb,#1e40af);color:#fff;padding:1.5rem 1rem;text-align:center}
        .geo-title{font-size:1.5rem;font-weight:700;margin-bottom:0.5rem}
        .geo-subtitle{font-size:0.9rem;opacity:0.9}
        .geo-stats{display:flex;justify-content:space-around;margin-top:1rem;font-size:0.9rem}
        .geo-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;padding:1rem}
        .geo-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);cursor:pointer;position:relative;transition:transform 0.2s}
        .geo-card:hover{transform:translateY(-4px)}
        .geo-card img{width:100%;height:180px;object-fit:cover}
        .geo-card-info{padding:0.75rem}
        .geo-card-title{font-size:0.9rem;font-weight:600;color:#1e40af;margin:0.25rem 0}
        .geo-badge-container{position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:4px}
        .geo-mini-badge{background:#fff;padding:0.25rem 0.5rem;border-radius:8px;font-size:0.7rem;font-weight:700;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
        .geo-mini-badge.complete{background:#27ae60;color:#fff}
        .geo-mini-badge.partial{background:#f39c12;color:#fff}
        .geo-mini-badge.none{background:#95a5a6;color:#fff}
        .geo-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:1000;overflow-y:auto}
        .geo-modal-content{max-width:900px;margin:2rem auto;padding:1rem}
        .geo-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;color:#fff}
        .geo-modal-close{background:none;border:none;color:#fff;font-size:2rem;cursor:pointer}
        .geo-layers{margin-top:1rem}
        .geo-layer{background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:1rem;overflow:hidden}
        .geo-layer-header{padding:1rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;color:#fff;transition:background 0.2s}
        .geo-layer-header:hover{background:rgba(255,255,255,0.1)}
        .geo-layer-icon{font-size:1.5rem;margin-right:0.5rem}
        .geo-layer-info{flex:1}
        .geo-layer-title{font-weight:700;font-size:1.1rem;margin-bottom:0.25rem}
        .geo-layer-status{font-size:0.85rem;opacity:0.8}
        .geo-layer-xp{background:#2563eb;color:#fff;padding:0.25rem 0.75rem;border-radius:12px;font-weight:700;font-size:0.85rem}
        .geo-layer-content{display:none;padding:1.5rem;background:rgba(0,0,0,0.3);color:#fff}
        .geo-layer-content.active{display:block}
        .geo-layer.locked{opacity:0.5;cursor:not-allowed}
        .geo-layer.locked .geo-layer-header{cursor:not-allowed}
        .geo-form-group{margin-bottom:1.5rem}
        .geo-form-label{display:block;font-weight:600;margin-bottom:0.5rem;color:#60a5fa}
        .geo-radio-group{display:flex;flex-direction:column;gap:0.75rem}
        .geo-radio-option{background:rgba(255,255,255,0.05);border:2px solid transparent;padding:1rem;border-radius:8px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:0.75rem}
        .geo-radio-option:hover{background:rgba(255,255,255,0.1);border-color:#2563eb}
        .geo-radio-option input[type="radio"]{width:20px;height:20px;cursor:pointer}
        .geo-radio-option.selected{border-color:#2563eb;background:rgba(37,99,235,0.2)}
        .geo-textarea{width:100%;min-height:100px;padding:1rem;border-radius:8px;border:2px solid rgba(96,165,250,0.3);background:rgba(0,0,0,0.3);color:#fff;font-size:1rem;font-family:inherit;resize:vertical}
        .geo-char-counter{text-align:right;font-size:0.85rem;opacity:0.7;margin-top:0.25rem}
        .geo-buttons{display:flex;gap:1rem;margin-top:1.5rem}
        .geo-btn-save{flex:1;background:#2563eb;color:#fff;border:none;padding:1rem;border-radius:8px;font-weight:700;font-size:1rem;cursor:pointer}
        .geo-btn-cancel{background:rgba(255,255,255,0.1);color:#fff;border:none;padding:1rem;border-radius:8px;font-weight:700;font-size:1rem;cursor:pointer}
        .geo-analysis-saved{background:rgba(39,174,96,0.2);border:2px solid #27ae60;padding:1rem;border-radius:8px;margin-top:1rem}
        .geo-analysis-saved-title{color:#4ade80;font-weight:700;margin-bottom:0.5rem}
        .geo-success-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#27ae60;color:#fff;padding:2rem 3rem;border-radius:12px;font-size:1.2rem;font-weight:700;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:fadeInOut 3s}
        
        /* ==================== PROFESSOR ==================== */
        .teacher-header{background:linear-gradient(135deg,#8e44ad,#6c3483);color:#fff;padding:1.5rem 1rem;text-align:center}
        .teacher-title{font-size:1.5rem;font-weight:700;margin-bottom:0.5rem}
        .teacher-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;padding:1rem;margin-bottom:1rem}
        .teacher-stat{background:#fff;padding:1rem;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .teacher-stat-value{font-size:2rem;font-weight:700;color:#8e44ad}
        .teacher-stat-label{font-size:0.85rem;color:#666;margin-top:0.25rem}
        .teacher-section{background:#fff;margin:1rem;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .teacher-section-header{padding:1rem;background:#f8f9fa;border-bottom:1px solid #dee2e6;font-weight:700;color:#6c3483;display:flex;justify-content:space-between;align-items:center}
        .teacher-pending-item{padding:1rem;border-bottom:1px solid #eee}
        .teacher-pending-item:last-child{border-bottom:none}
        .teacher-pending-photo{font-weight:600;color:#2c3e50;margin-bottom:0.25rem;font-size:0.95rem}
        .teacher-pending-author{font-size:0.85rem;color:#666;margin-bottom:0.5rem}
        .teacher-pending-text{background:#f8f9fa;padding:0.75rem;border-radius:6px;font-size:0.9rem;color:#555;margin-bottom:0.75rem;line-height:1.4}
        .teacher-actions{display:flex;gap:0.5rem}
        .teacher-btn{flex:1;padding:0.5rem;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:0.9rem;display:flex;align-items:center;justify-content:center;gap:0.5rem}
        .teacher-btn-approve{background:#27ae60;color:#fff}
        .teacher-btn-reject{background:#e74c3c;color:#fff}
        .teacher-ranking-item{padding:1rem;display:flex;align-items:center;gap:1rem;border-bottom:1px solid #eee}
        .teacher-ranking-item:last-child{border-bottom:none}
        .teacher-ranking-pos{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem}
        .teacher-ranking-pos.gold{background:gold;color:#333}
        .teacher-ranking-pos.silver{background:silver;color:#333}
        .teacher-ranking-pos.bronze{background:#cd7f32;color:#fff}
        .teacher-ranking-pos.other{background:#e9ecef;color:#6c757d}
        .teacher-ranking-info{flex:1}
        .teacher-ranking-name{font-weight:600;color:#2c3e50;font-size:0.95rem}
        .teacher-ranking-xp{color:#8e44ad;font-size:1.1rem;font-weight:700}
        .teacher-empty{padding:2rem;text-align:center;color:#999}

        /* ==================== NOTIFICATIONS ==================== */
        .toast-container {
            position: fixed;
            top: 70px; right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 300px;
        }

        .toast {
            background: var(--white);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 0.875rem 1rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            animation: toastIn 0.3s ease-out;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast-icon { font-size: 1.25rem; }
        .toast-title { font-weight: 600; font-size: 0.875rem; color: var(--primary); }
        .toast-body { font-size: 0.8rem; color: var(--gray); }

        /* ==================== UTILITIES ==================== */
        .hidden { display: none !important; }
        
        /* Feed Filters */
        .feed-filter, .feed-filter-cat {
            padding: 0.45rem 1rem;
            border-radius: 20px;
            border: 2px solid var(--gold);
            background: var(--white);
            color: var(--primary);
            font-family: 'Crimson Text', serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .feed-filter:hover, .feed-filter-cat:hover {
            background: var(--paper-dark);
        }
        
        .feed-filter.active, .feed-filter-cat.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }
        
        .feed-filter-cat {
            font-size: 1.1rem;
            padding: 0.4rem 0.8rem;
        }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-state-icon { font-size: 3rem; margin-bottom: 0.75rem; }
        .empty-state-title { font-family: 'Playfair Display', serif; color: var(--primary); margin-bottom: 0.5rem; }
        .empty-state-text { font-size: 0.875rem; color: var(--gray); }

        .alert-strip {
            background: rgba(196,163,90,0.15);
            border: 2px solid var(--gold);
            border-radius: 10px;
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        @media (min-width: 768px) {
            .app-shell { max-width: 480px; margin: 0 auto; box-shadow: 0 0 80px rgba(0,0,0,0.15); }
            html { background: var(--paper-dark); }
        }
        /* ========================================
           AR MODE STYLES
           ======================================== */
        
        .ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 10000;
        }
        
        .ar-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 10;
        }
        
        .ar-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            font-size: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .ar-close:active {
            transform: scale(0.95);
        }
        
        .ar-title {
            color: white;
            font-size: 18px;
            font-weight: 700;
        }
        
        #arCamera {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #arCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .ar-photo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        #arHistoricalPhoto {
            max-width: 90%;
            max-height: 60%;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            transition: opacity 0.3s;
            object-fit: contain;
        }
        
        .ar-slider-container {
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 400px;
            background: rgba(0,0,0,0.8);
            padding: 1rem;
            border-radius: 16px;
            pointer-events: all;
        }
        
        .ar-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.3);
            outline: none;
            -webkit-appearance: none;
        }
        
        .ar-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .ar-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .ar-slider-label {
            text-align: center;
            color: white;
            font-size: 14px;
            margin-top: 0.5rem;
        }
        
        .ar-info {
            position: absolute;
            bottom: 20px;
            left: 1rem;
            right: 1rem;
            background: rgba(0,0,0,0.9);
            padding: 1rem;
            border-radius: 16px;
            display: flex;
            gap: 1rem;
            align-items: center;
            pointer-events: all;
        }
        
        .ar-info-icon {
            font-size: 40px;
        }
        
        .ar-info-content {
            flex: 1;
        }
        
        .ar-info-title {
            color: white;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .ar-info-year {
            color: var(--gold);
            font-size: 14px;
            margin-bottom: 0.25rem;
        }
        
        .ar-info-distance {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
        }
        
        .ar-searching {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }
        
        .ar-searching-icon {
            font-size: 64px;
            margin-bottom: 1rem;
            animation: arPulse 2s infinite;
        }
        
        @keyframes arPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        
        .ar-searching-text {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .ar-searching-hint {
            font-size: 14px;
            opacity: 0.7;
        }
        
        .ar-counter {
            position: absolute;
            top: 70px;
            right: 1rem;
            background: rgba(196,163,90,0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- MODAL: POINT DETAIL -->
<div class="modal-overlay" id="pointDetailModal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <div class="modal-title" id="detailModalTitle">Ponto Hist√≥rico</div>
            <button class="modal-close" onclick="closePointDetail()">√ó</button>
        </div>
        <div class="modal-body">
            <img id="detailModalImage" style="width:100%;height:240px;object-fit:cover;border-radius:12px;margin-bottom:1rem;" src="" alt="">
            
            <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
                <span id="detailModalCategory" style="background:rgba(45,90,61,0.1);color:var(--primary);padding:0.35rem 0.85rem;border-radius:12px;font-size:0.8rem;font-weight:600;"></span>
                <span id="detailModalStatus" style="background:rgba(196,163,90,0.2);color:var(--gold);padding:0.35rem 0.85rem;border-radius:12px;font-size:0.8rem;font-weight:600;"></span>
            </div>
            
            <div style="font-size:0.85rem;color:var(--gray);margin-bottom:1rem;" id="detailModalAuthor"></div>
            
            <div style="margin-bottom:1.5rem;">
                <div style="font-weight:700;color:var(--primary);margin-bottom:0.5rem;font-size:0.875rem;text-transform:uppercase;letter-spacing:0.5px;">üìñ Descri√ß√£o Hist√≥rica</div>
                <div style="line-height:1.7;color:var(--ink);" id="detailModalDescription"></div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem;">
                <button class="btn btn-primary" onclick="closePointDetail()">‚úì Fechar</button>
                <button class="btn btn-secondary" onclick="viewPointOnMapFromDetail()">üó∫Ô∏è Ver no Mapa</button>
            </div>
            
            <button class="btn btn-full" style="background:var(--gradient-cool);background:linear-gradient(135deg,#06B6D4,#7C3AED);color:white;display:flex;align-items:center;justify-content:center;gap:0.5rem;" onclick="sharePoint()">
                üì§ Compartilhar este Ponto
            </button>
        </div>
    </div>
</div>

<!-- MODAL: REGISTER POINT -->
<div class="modal-overlay" id="registerModal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <div class="modal-title">üìç Cadastrar Ponto</div>
            <button class="modal-close" onclick="closeRegisterModal()">√ó</button>
        </div>

        <!-- Wizard Steps -->
        <div style="padding: 1rem 1.5rem 0;">
            <div class="wizard-steps" id="wizardSteps">
                <div class="wizard-step active" id="wstep-0">
                    <div class="wizard-dot">1</div>
                    <div class="wizard-step-label">Info</div>
                </div>
                <div class="wizard-step" id="wstep-1">
                    <div class="wizard-dot">2</div>
                    <div class="wizard-step-label">M√≠dia</div>
                </div>
                <div class="wizard-step" id="wstep-2">
                    <div class="wizard-dot">3</div>
                    <div class="wizard-step-label">Fontes</div>
                </div>
            </div>
        </div>

        <div class="modal-body">
            <!-- Step 1: Info -->
            <div class="wizard-page active" id="wpage-0">
                <div class="location-card" id="locationCard">
                    <div class="location-icon">üì°</div>
                    <div class="location-info">
                        <div class="location-address" id="locationAddress">Obtendo localiza√ß√£o...</div>
                        <div class="location-coords" id="locationCoords">Aguarde...</div>
                    </div>
                    <button onclick="refreshLocation()" style="background: none; border: none; cursor: pointer; font-size: 1.1rem;">üîÑ</button>
                </div>

                <div id="duplicateWarning"></div>

                <div class="form-group">
                    <label class="form-label">Nome do Local *</label>
                    <input type="text" class="form-input" id="pointName" placeholder="Ex: Igreja Matriz S√£o Sebasti√£o">
                </div>

                <div class="form-group">
                    <label class="form-label">Categoria *</label>
                    <select class="form-select" id="pointCategory">
                        <option value="">Selecione...</option>
                        <option value="igreja">‚õ™ Igreja / Capela</option>
                        <option value="praca">üå≥ Pra√ßa / Parque</option>
                        <option value="escola">üè´ Escola / Educa√ß√£o</option>
                        <option value="comercio">üè™ Com√©rcio Hist√≥rico</option>
                        <option value="residencia">üè† Resid√™ncia</option>
                        <option value="patrimonio">üèõÔ∏è Patrim√¥nio Cultural</option>
                        <option value="marco-geo">üóª Marco Geogr√°fico</option>
                        <option value="curiosidade">üí° Curiosidade Local</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Descri√ß√£o Hist√≥rica * <span style="color: var(--gray); font-weight: 400;">(m√≠n. 100 caracteres)</span></label>
                    <textarea class="form-input" id="pointDesc" placeholder="Conte a hist√≥ria deste local: quando foi constru√≠do, quem fundou, o que representou para a cidade..." oninput="updateCharCount()"></textarea>
                    <div class="char-counter"><span id="charCount">0</span>/100 caracteres m√≠nimos</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Per√≠odo Hist√≥rico</label>
                    <select class="form-select" id="pointEra">
                        <option value="antes1960">üìú Antes de 1960</option>
                        <option value="1960-1990">üï∞Ô∏è 1960 - 1990</option>
                        <option value="1990-2010">üì∑ 1990 - 2010</option>
                        <option value="2010+">üì± 2010 em diante</option>
                    </select>
                </div>
            </div>

            <!-- Step 2: Media -->
            <div class="wizard-page" id="wpage-1">
                <p style="font-size: 0.875rem; color: var(--gray); margin-bottom: 1rem;">üì∏ A foto √© obrigat√≥ria. √Åudio e v√≠deo s√£o opcionais mas muito valorizados!</p>

                <label class="form-label">üì∑ Foto Principal *</label>
                <div class="media-upload" id="mainPhotoUpload" onclick="document.getElementById('mainPhotoInput').click()">
                    <div id="mainPhotoPreviewWrap">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∑</div>
                        <div style="font-weight: 600; color: var(--primary);">Tirar foto ou escolher arquivo</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">JPEG, PNG ‚Äî m√°x. 10MB (comprimido automaticamente)</div>
                    </div>
                </div>
                <input type="file" id="mainPhotoInput" accept="image/*" capture="environment" class="hidden" onchange="handlePhoto(this, 'main')">

                <label class="form-label mt-2">üï∞Ô∏è Foto Antiga (opcional)</label>
                <div class="media-upload" onclick="document.getElementById('beforePhotoInput').click()">
                    <div id="beforePhotoPreviewWrap">
                        <div style="font-size: 1.5rem; margin-bottom: 0.35rem;">üñºÔ∏è</div>
                        <div style="font-size: 0.875rem; color: var(--gray);">Foto de como era antes (digitalizada)</div>
                    </div>
                </div>
                <input type="file" id="beforePhotoInput" accept="image/*" class="hidden" onchange="handlePhoto(this, 'before')">

                <label class="form-label mt-2">üéôÔ∏è √Åudio / Entrevista (opcional)</label>
                <div class="media-upload" onclick="document.getElementById('audioInput').click()">
                    <div style="font-size: 1.5rem; margin-bottom: 0.35rem;">üéôÔ∏è</div>
                    <div id="audioLabel" style="font-size: 0.875rem; color: var(--gray);">Grave ou envie entrevista com morador</div>
                </div>
                <input type="file" id="audioInput" accept="audio/*" class="hidden" onchange="handleAudio(this)">
            </div>

            <!-- Step 3: Sources -->
            <div class="wizard-page" id="wpage-2">
                <div class="alert-strip">
                    <span>üìö</span>
                    <div>Informe as fontes que usou na pesquisa ‚Äî livros, entrevistas, sites, documentos hist√≥ricos.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Fontes Bibliogr√°ficas</label>
                    <textarea class="form-input" id="pointSources" placeholder="Ex: Livro 'Hist√≥ria de Presidente Dutra' (1995); Entrevista com Sr. Jos√© (80 anos)..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Nome do Entrevistado (se houver)</label>
                    <input type="text" class="form-input" id="pointInterviewee" placeholder="Ex: Dona Maria da Concei√ß√£o, 75 anos">
                </div>

                <div style="background: var(--paper-dark); border-radius: 10px; padding: 1rem; margin-top: 1rem;">
                    <label style="display: flex; gap: 0.75rem; align-items: flex-start; cursor: pointer;">
                        <input type="checkbox" id="termsCheck" style="width: 18px; height: 18px; margin-top: 3px; accent-color: var(--primary);">
                        <span style="font-size: 0.875rem; color: var(--primary);">
                            Declaro que as informa√ß√µes s√£o verdadeiras, obtidas com responsabilidade, e que tenho autoriza√ß√£o para publicar as m√≠dias enviadas.
                        </span>
                    </label>
                </div>
            </div>
        </div>

        <div class="wizard-footer">
            <button class="btn btn-secondary" id="wizardBackBtn" onclick="wizardPrev()" style="display:none;">‚Üê Voltar</button>
            <button class="btn btn-primary" id="wizardNextBtn" onclick="wizardNext()">Pr√≥ximo ‚Üí</button>
        </div>
    </div>
</div>

<!-- APP SHELL -->
<div class="app-shell" id="appShell" style="display:none;">
    <!-- TOP BAR -->
    <div class="topbar">
        <div class="topbar-left">
            <button class="topbar-back" id="topbarBack" onclick="goBack()" style="display:none;">
                ‚Üê 
            </button>
            <div class="topbar-logo" id="topbarLogo">üó∫Ô∏è PK Explorer</div>
        </div>
        <div class="topbar-right">
            <button class="topbar-notification" id="topbarNotification" onclick="openNotifications()" style="display:none;">
                üîî
                <span class="notification-badge" id="notificationBadge">0</span>
            </button>
            <div class="topbar-xp" id="topbarXP">‚≠ê 350 XP</div>
            <div class="topbar-avatar" id="topbarAvatar" onclick="navigateTo('profile')">M</div>
        </div>
    </div>

    <!-- SCREENS -->
    <div class="screens">

        <!-- HOME -->
        <div class="screen active" id="screen-home">
            <div class="screen-content">
                <div class="welcome-banner">
                    <div class="welcome-name" id="welcomeName">Ol√°, Maria! üëã</div>
                    <div class="welcome-sub">Continue explorando a hist√≥ria da cidade</div>
                </div>

                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="statPointsHome">7</div>
                        <div class="quick-stat-label">Pontos</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="statXpHome">350</div>
                        <div class="quick-stat-label">XP Total</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">#4</div>
                        <div class="quick-stat-label">Ranking</div>
                    </div>
                </div>

                <div class="section-label">‚ö° Acesso R√°pido</div>
                <div class="quick-actions">
                    <div class="quick-action" onclick="navigateTo('map')">
                        <div class="quick-action-icon">üó∫Ô∏è</div>
                        <div class="quick-action-label">Ver Mapa</div>
                    </div>
                    <div class="quick-action" onclick="openRegisterModal()">
                        <div class="quick-action-icon">üìç</div>
                        <div class="quick-action-label">Cadastrar Ponto</div>
                    </div>
                    <div class="quick-action" onclick="toggleARMode()" id="arModeButton" style="background:var(--primary);">
                        <div class="quick-action-icon">üì±</div>
                        <div class="quick-action-label">Modo AR</div>
                    </div>
                    <div class="quick-action" onclick="navigateTo('feedback')" style="background:var(--gold);color:var(--primary);">
                        <div class="quick-action-icon">üí°</div>
                        <div class="quick-action-label">Sugest√µes</div>
                    </div>
                </div>

                <div class="section-label">üìä Resumo R√°pido</div>

                <div class="active-mission" onclick="navigateTo('missions')">
                    <div class="mission-icon-wrap">‚úÖ</div>
                    <div class="mission-info">
                        <div class="mission-name">Meu Trabalho</div>
                        <div class="mission-xp">7 pontos ¬∑ 5 aprovados</div>
                        <div class="mission-progress-mini"><div class="mission-progress-fill" style="width:71%"></div></div>
                    </div>
                    <span style="color: var(--gold);">‚Ä∫</span>
                </div>

                <div class="active-mission" onclick="navigateTo('missions')">
                    <div class="mission-icon-wrap">üë•</div>
                    <div class="mission-info">
                        <div class="mission-name">Nossa Turma (6¬∫A)</div>
                        <div class="mission-xp">47 pontos ¬∑ 2¬∫ lugar</div>
                        <div class="mission-progress-mini"><div class="mission-progress-fill" style="width:94%"></div></div>
                    </div>
                    <span style="color: var(--gold);">‚Ä∫</span>
                </div>
            </div>
        </div>

        <!-- MAP -->
        <div class="screen" id="screen-map">
            <div class="map-wrapper">
                <!-- Search Bar -->
                <div class="map-search-bar">
                    <input type="text" id="mapSearch" placeholder="üîç Buscar ponto hist√≥rico..." onkeyup="searchMap(this.value)">
                    <button id="clearSearch" onclick="clearMapSearch()" style="display:none;">√ó</button>
                </div>
                
                <div class="map-filters">
                    <button class="map-filter-btn active" onclick="filterMap('all', this)">üó∫Ô∏è Todos</button>
                    <button class="map-filter-btn" onclick="filterMap('pending', this)">‚è≥ Pendentes</button>
                    <button class="map-filter-btn" onclick="filterMap('approved', this)">‚úÖ Aprovados</button>
                    <button class="map-filter-btn" onclick="filterMap('igreja', this)">‚õ™ Igrejas</button>
                </div>
                <div class="map-offline-banner" id="mapOfflineBanner">‚úàÔ∏è Modo offline ‚Äî tiles do cache</div>
                <div id="map"></div>
                
                <!-- Layer Selector -->
                <button class="map-layer-btn" id="layerToggle" onclick="toggleLayerPanel()" title="Camadas do Mapa">
                    üó∫Ô∏è
                </button>
                
                <div class="map-layer-panel" id="layerPanel" style="display:none;">
                    <div style="font-weight:700;margin-bottom:0.75rem;color:var(--primary);font-size:0.9rem;">üìç Camadas do Mapa</div>
                    <div class="layer-option" onclick="changeMapLayer('streets', this)">
                        <input type="radio" name="layer" checked> 
                        <span>üó∫Ô∏è Mapa de Ruas</span>
                    </div>
                    <div class="layer-option" onclick="changeMapLayer('topo', this)">
                        <input type="radio" name="layer"> 
                        <span>‚õ∞Ô∏è Topogr√°fico</span>
                    </div>
                    <div class="layer-option" onclick="changeMapLayer('satellite', this)">
                        <input type="radio" name="layer"> 
                        <span>üõ∞Ô∏è Sat√©lite</span>
                    </div>
                </div>
                
                <button class="map-fab" onclick="openRegisterModal()" title="Cadastrar novo ponto">üìç</button>
            </div>
        </div>

        <!-- MISSIONS -->
        <!-- PROGRESSO -->
        <!-- PROGRESSO / PAINEL -->
        <div class="screen" id="screen-missions">
            
            <!-- VERS√ÉO ALUNO -->
            <div class="screen-content" id="studentProgress">
                <div class="screen-header">
                    <span style="font-size:1.5rem">üìä</span>
                    <div class="screen-title">Meu Progresso</div>
                </div>
                
                <div class="card">
                    <div style="font-weight:700;color:var(--primary);margin-bottom:1rem;">üìù Meu Trabalho</div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;">
                        <div style="background:var(--paper-dark);padding:1rem;border-radius:10px;text-align:center;">
                            <div style="font-size:2rem;font-weight:700;color:var(--primary);">7</div>
                            <div style="font-size:0.8rem;color:var(--gray);">Pontos Cadastrados</div>
                        </div>
                        <div style="background:rgba(16,185,129,0.1);padding:1rem;border-radius:10px;text-align:center;">
                            <div style="font-size:2rem;font-weight:700;color:var(--green);">5</div>
                            <div style="font-size:0.8rem;color:var(--gray);">‚úÖ Aprovados</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- VERS√ÉO PROFESSOR -->
        </div>

        <!-- FEED -->
        <div class="screen" id="screen-feed">
            <div class="screen-content">
                <div class="screen-header">
                    <span style="font-size:1.5rem">üì∞</span>
                    <div class="screen-title">Descobertas</div>
                </div>
                
                <!-- Feed Filters -->
                <div style="background:var(--white);border:2px solid var(--gold);border-radius:14px;padding:1rem;margin-bottom:1rem;">
                    <div style="font-weight:700;color:var(--primary);margin-bottom:0.75rem;font-size:0.875rem;">üîç Filtrar por:</div>
                    
                    <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.75rem;">
                        <button class="feed-filter active" data-filter="all" onclick="filterFeed('all', this)">
                            Todos
                        </button>
                        <button class="feed-filter" data-filter="minha-turma" onclick="filterFeed('minha-turma', this)">
                            Minha Turma
                        </button>
                    </div>
                    
                    <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
                        <button class="feed-filter-cat" data-category="all" onclick="filterFeedCategory('all', this)">
                            üìç Todas
                        </button>
                        <button class="feed-filter-cat" data-category="igreja" onclick="filterFeedCategory('igreja', this)">
                            ‚õ™
                        </button>
                        <button class="feed-filter-cat" data-category="praca" onclick="filterFeedCategory('praca', this)">
                            üå≥
                        </button>
                        <button class="feed-filter-cat" data-category="patrimonio" onclick="filterFeedCategory('patrimonio', this)">
                            üèõÔ∏è
                        </button>
                        <button class="feed-filter-cat" data-category="comercio" onclick="filterFeedCategory('comercio', this)">
                            üè™
                        </button>
                    </div>
                </div>
                
                <div id="feedContent"></div>
            </div>
        </div>

        <!-- NOTIFICATIONS -->
        <div class="screen" id="screen-notifications" style="display:none;">
            <div class="screen-content">
                <div class="screen-header">
                    <span style="font-size:1.5rem">üîî</span>
                    <div class="screen-title">Notifica√ß√µes</div>
                </div>
                <div id="notificationsContent">
                    <!-- Notifications rendered by JS -->
                </div>
            </div>
        </div>

        <!-- PROFILE -->
        <!-- MEM√ìRIAS DO BAIRRO -->
        <div class="screen" id="screen-memories">
            <div class="memories-header">
                <div class="memories-title">üì∏ Mem√≥rias do Bairro</div>
                <div class="memories-subtitle">Explore a hist√≥ria de Presidente Dutra</div>
                <div class="memories-progress">
                    <div class="memories-progress-fill" id="memoriesProgressBar" style="width:15%"></div>
                </div>
                <div class="memories-stats">
                    <div><strong id="memoriesCompleted">3</strong>/20 Descobertas</div>
                    <div>üèÜ <strong id="memoriesXP">150</strong> XP</div>
                </div>
            </div>
            
            <div class="memories-filters">
                <button class="filter-btn active" onclick="filterMemories('all')">Todas</button>
                <button class="filter-btn" onclick="filterMemories('1920')">Anos 20</button>
                <button class="filter-btn" onclick="filterMemories('1940')">Anos 40</button>
                <button class="filter-btn" onclick="filterMemories('1960')">Anos 60</button>
                <button class="filter-btn" onclick="filterMemories('1970')">Anos 70</button>
                <button class="filter-btn" onclick="filterMemories('religiosa')">Igrejas</button>
                <button class="filter-btn" onclick="filterMemories('comercio')">Com√©rcio</button>
            </div>
            
            <div class="photo-grid" id="photoGrid">
                <!-- Photos will be loaded by JavaScript -->
            </div>
        </div>
        
        <!-- MODAL DE FOTO -->
        <div class="photo-modal" id="photoModal">
            <div class="photo-modal-content">
                <div class="photo-modal-header">
                    <div style="color:#fff">
                        <div style="font-size:1.5rem;font-weight:700" id="modalTitle"></div>
                        <div style="opacity:0.8" id="modalLocation"></div>
                    </div>
                    <button class="photo-modal-close" onclick="closePhotoModal()">√ó</button>
                </div>
                
                <div class="photo-modal-tabs">
                    <button class="photo-tab active" onclick="switchPhotoTab('info')">üì∑ Foto</button>
                    <button class="photo-tab" onclick="switchPhotoTab('compare')">‚öñÔ∏è Comparar</button>
                    <button class="photo-tab" onclick="switchPhotoTab('quiz')">üß© Desafio</button>
                    <button class="photo-tab" onclick="switchPhotoTab('story')">üìñ Hist√≥ria</button>
                </div>
                
                <div class="photo-tab-content active" id="tab-info">
                    <div class="photo-modal-image-container">
                        <img class="photo-modal-image" id="modalImage" src="" alt="">
                    </div>
                    <div style="margin-top:1rem">
                        <div style="color:#D4AF37;font-weight:700;margin-bottom:0.5rem" id="modalYear"></div>
                        <div style="line-height:1.6" id="modalDescription"></div>
                    </div>
                </div>
                
                <div class="photo-tab-content" id="tab-compare">
                    <div class="compare-slider-container">
                        <div class="compare-slider" id="compareSlider">
                            <img class="compare-after" id="compareAfter" src="">
                            <div class="compare-overlay" id="compareOverlay">
                                <img class="compare-before" id="compareBefore" src="">
                            </div>
                            <div class="compare-handle" id="compareHandle">‚ü∑</div>
                        </div>
                    </div>
                    <div style="text-align:center;margin-top:1rem;color:#D4AF37;font-weight:600">
                        ‚Üê Arraste para comparar ‚Üí
                    </div>
                </div>
                
                <div class="photo-tab-content" id="tab-quiz">
                    <div class="quiz-container">
                        <div class="quiz-question" id="quizQuestion"></div>
                        <div class="quiz-options" id="quizOptions"></div>
                        <div class="quiz-feedback" id="quizFeedback" style="display:none"></div>
                    </div>
                </div>
                
                <div class="photo-tab-content" id="tab-story">
                    <div style="color:#fff;line-height:1.8">
                        <h3 style="color:#D4AF37;margin-bottom:1rem">üìñ Hist√≥ria Original</h3>
                        <div id="storyOriginal" style="background:rgba(255,255,255,0.05);padding:1rem;border-radius:8px;margin-bottom:2rem">
                            <p>Carregando hist√≥ria...</p>
                        </div>
                        
                        <h3 style="color:#D4AF37;margin-bottom:1rem">‚úçÔ∏è Contribui√ß√µes dos Alunos</h3>
                        <div id="storyContributions" style="margin-bottom:2rem">
                            <!-- Contributions will be loaded here -->
                        </div>
                        
                        <div style="background:rgba(212,175,55,0.1);border:2px solid #D4AF37;border-radius:12px;padding:1.5rem">
                            <h4 style="color:#D4AF37;margin-bottom:1rem">üí° Adicione sua contribui√ß√£o!</h4>
                            <p style="font-size:0.9rem;opacity:0.8;margin-bottom:1rem">
                                O que voc√™ sabe sobre esta foto? Adicione informa√ß√µes, curiosidades ou hist√≥rias que voc√™ conhece!
                            </p>
                            <textarea id="contributionText" 
                                      placeholder="Digite aqui sua contribui√ß√£o sobre esta foto hist√≥rica..."
                                      style="width:100%;min-height:120px;padding:1rem;border-radius:8px;border:2px solid rgba(212,175,55,0.3);background:rgba(0,0,0,0.3);color:#fff;font-size:1rem;font-family:inherit;resize:vertical"></textarea>
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem">
                                <div style="font-size:0.85rem;opacity:0.7" id="contributionCounter">0/500 caracteres</div>
                                <button onclick="submitContribution()" 
                                        style="background:#D4AF37;color:#000;border:none;padding:0.75rem 2rem;border-radius:8px;font-weight:700;cursor:pointer;font-size:1rem">
                                    üì§ Enviar Contribui√ß√£o
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- GEOGRAFIA -->
        <div class="screen" id="screen-geography">
            <div class="geo-header">
                <div class="geo-title">üåç Laborat√≥rio Geogr√°fico</div>
                <div class="geo-subtitle">An√°lise espacial de Presidente Dutra</div>
                <div class="geo-stats">
                    <div><strong id="geoCompleted">0</strong>/20 Analisadas</div>
                    <div>üèÜ <strong id="geoXP">0</strong> XP</div>
                </div>
            </div>
            <div class="geo-grid" id="geoGrid"></div>
        </div>
        
        <!-- GEO MODAL -->
        <div class="geo-modal" id="geoModal">
            <div class="geo-modal-content">
                <div class="geo-modal-header">
                    <div>
                        <div style="font-size:1.5rem;font-weight:700" id="geoModalTitle"></div>
                        <div style="opacity:0.8;font-size:0.9rem" id="geoModalLocation"></div>
                    </div>
                    <button class="geo-modal-close" onclick="closeGeoModal()">√ó</button>
                </div>
                <div style="margin-bottom:1rem"><img id="geoModalImage" src="" style="width:100%;border-radius:12px"></div>
                <div class="geo-layers" id="geoLayers"></div>
            </div>
        </div>
        <!-- PROFESSOR -->
        <div class="screen" id="screen-teacher">
            <div class="teacher-header">
                <div class="teacher-title">üë®‚Äçüè´ Painel do Professor</div>
                <div style="font-size:0.9rem;opacity:0.9">Gest√£o Pedag√≥gica Completa</div>
            </div>
            
            <div class="teacher-stats">
                <div class="teacher-stat">
                    <div class="teacher-stat-value" id="teacherPendingCount">0</div>
                    <div class="teacher-stat-label">Pendentes</div>
                </div>
                <div class="teacher-stat">
                    <div class="teacher-stat-value" id="teacherApprovedCount">0</div>
                    <div class="teacher-stat-label">Aprovadas</div>
                </div>
                <div class="teacher-stat">
                    <div class="teacher-stat-value" id="teacherTotalStudents">0</div>
                    <div class="teacher-stat-label">Alunos</div>
                </div>
                <div class="teacher-stat">
                    <div class="teacher-stat-value" id="teacherTotalGeo">0</div>
                    <div class="teacher-stat-label">An√°lises Geo</div>
                </div>
            </div>
            
            <div class="teacher-section">
                <div class="teacher-section-header">
                    <span>‚è≥ Pendentes de Aprova√ß√£o</span>
                    <span id="teacherPendingBadge" style="background:#e74c3c;color:#fff;padding:0.25rem 0.5rem;border-radius:12px;font-size:0.8rem">0</span>
                </div>
                <div id="teacherPendingList"></div>
            </div>
            
            <div class="teacher-section">
                <div class="teacher-section-header">
                    <span>üìÑ Relat√≥rios em PDF</span>
                </div>
                <div style="padding:1rem;display:flex;flex-direction:column;gap:0.75rem">
                    <button onclick="generateCompletePDF()" style="background:#8e44ad;color:#fff;border:none;padding:1rem;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.5rem">
                        üì• Relat√≥rio Completo (Todas Contribui√ß√µes)
                    </button>
                    <button onclick="generateStudentsPDF()" style="background:#2563eb;color:#fff;border:none;padding:1rem;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.5rem">
                        üë• Relat√≥rio de Alunos (Ranking)
                    </button>
                    <button onclick="generateGeoPDF()" style="background:#16a34a;color:#fff;border:none;padding:1rem;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.5rem">
                        üåç Relat√≥rio Geografia (An√°lises)
                    </button>
                </div>
            </div>
            
            <div class="teacher-section">
                <div class="teacher-section-header">üèÜ Ranking de Alunos por XP</div>
                <div id="teacherRankingList"></div>
            </div>
        </div>
        <div class="screen" id="screen-profile">
            <!-- Header do Perfil -->
            <div class="profile-header-new">
                <div class="profile-avatar-container">
                    <div class="profile-avatar-frame">
                        <div class="profile-avatar-big-new" id="profileAvatarBig">M</div>
                        <button class="profile-camera-btn" onclick="document.getElementById('profilePhotoInput').click()">üì∑</button>
                        <input type="file" id="profilePhotoInput" accept="image/*" style="display:none;" onchange="updateProfilePhoto(this)">
                    </div>
                </div>
                
                <div class="profile-info-new">
                    <h1 class="profile-name-new" id="profileName">Maria Santos</h1>
                    <div class="profile-title-new" id="profileTitle">üèÜ Exploradora N√≠vel 1</div>
                    
                    <div class="profile-stats-inline">
                        <div class="stat-inline">
                            <span class="stat-icon">‚≠ê</span>
                            <span class="stat-value" id="profileXPValue">350 XP</span>
                        </div>
                        <div class="stat-inline">
                            <span class="stat-icon">üî•</span>
                            <span class="stat-value" id="profileStreak">Sequ√™ncia: 5 dias</span>
                        </div>
                    </div>
                    
                    <div class="profile-progress-new">
                        <div class="progress-track-new">
                            <div class="progress-fill-new" id="profileProgressBar" style="width:70%"></div>
                        </div>
                        <div class="progress-label-new" id="profileProgressText">Faltam 150 XP para Investigadora</div>
                    </div>
                </div>
                
                <button class="btn-explore-now" onclick="navigateTo('map')">
                    <span class="btn-explore-icon">üó∫Ô∏è</span>
                    <span class="btn-explore-text">Explorar agora</span>
                </button>
            </div>

            <!-- Miss√µes da Semana -->
            <div class="missions-card">
                <div class="card-header-new">
                    <span class="card-icon">üì¶</span>
                    <span class="card-title">Miss√µes da Semana</span>
                    <button class="card-menu">‚ãØ</button>
                </div>
                
                <div class="missions-list">
                    <div class="mission-item completed">
                        <input type="checkbox" checked disabled>
                        <span class="mission-text">Cadastrar 1 ponto hist√≥rico</span>
                        <span class="mission-badge">‚úì 7</span>
                    </div>
                    <div class="mission-item">
                        <input type="checkbox" disabled>
                        <span class="mission-text">Visitar 2 locais no mapa</span>
                        <div class="mission-progress-inline">
                            <div class="progress-mini">
                                <div class="progress-mini-fill" style="width:50%"></div>
                            </div>
                            <span class="progress-text-mini">1/2</span>
                        </div>
                    </div>
                    <div class="mission-item">
                        <input type="checkbox" disabled>
                        <span class="mission-text">Ganhar 100 XP</span>
                        <div class="mission-progress-inline">
                            <div class="progress-mini">
                                <div class="progress-mini-fill" style="width:50%"></div>
                            </div>
                            <span class="progress-text-mini">50/100 XP</span>
                        </div>
                    </div>
                </div>
                
                <div class="mission-reward">
                    <span class="reward-icon">üèÜ</span>
                    <span class="reward-text">Recompensa: Badge "Explorador Ativo"</span>
                </div>
                
                <div class="mission-overall-progress">
                    <div class="progress-track-mission">
                        <div class="progress-fill-mission" style="width:33%"></div>
                    </div>
                </div>
            </div>

            <!-- Estat√≠sticas do Explorador -->
            <div class="stats-card">
                <div class="card-header-new">
                    <span class="card-icon">üìä</span>
                    <span class="card-title">Estat√≠sticas do Explorador</span>
                    <span class="ranking-badge">#4 na turma</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-icon-big">üìç</div>
                        <div class="stat-content">
                            <div class="stat-label">Pontos cadastrados</div>
                            <div class="stat-number">‚úì 7</div>
                        </div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-icon-big">üì±</div>
                        <div class="stat-content">
                            <div class="stat-label">Territ√≥rios descobertos</div>
                            <div class="stat-number">üó∫Ô∏è 3</div>
                        </div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-icon-big">üòä</div>
                        <div class="stat-content">
                            <div class="stat-label">Aprovados</div>
                            <div class="stat-number">‚úì 5</div>
                        </div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-icon-big">üìä</div>
                        <div class="stat-content">
                            <div class="stat-label">Badges</div>
                            <div class="stat-number">3</div>
                        </div>
                    </div>
                </div>
                
                <div class="mini-map-container">
                    <div class="mini-map">
                        <div class="map-pin" style="left:25%;top:30%">üìç</div>
                        <div class="map-pin" style="left:60%;top:45%">üìç</div>
                        <div class="map-pin" style="left:40%;top:70%">üìç</div>
                    </div>
                    <button class="btn-view-map" onclick="navigateTo('map')">
                        Ver meu mapa completo
                    </button>
                </div>
            </div>

            <!-- Conquistas e Personaliza√ß√£o -->
            <div style="display:grid;grid-template-columns:1fr;gap:1rem;padding:0 1rem;margin-bottom:1rem;">
                <div class="achievement-card">
                    <div class="achievement-header">
                        <span class="achievement-icon">üèÖ</span>
                        <span class="achievement-title">Voc√™ est√° em #4</span>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-badge">
                            <span style="font-size:2rem">üèÜ</span>
                        </div>
                        <div class="achievement-info">
                            <div class="achievement-name">Explorador Urbano</div>
                            <div class="achievement-progress">
                                <div class="progress-badge">
                                    <div class="progress-badge-fill" style="width:50%"></div>
                                </div>
                                <span>‚≠ê 50 XP</span>
                            </div>
                        </div>
                    </div>
                    <div class="achievement-list-compact">
                        <div class="achievement-mini">üìç Pra√ßa Central cadastrada</div>
                        <div class="achievement-mini">‚≠ê +50 XP ganho</div>
                        <div class="achievement-mini-map">
                            üó∫Ô∏è <span style="opacity:0.7">XP</span>
                            üé® 
                            üì±
                        </div>
                    </div>
                </div>
                
                <div class="personalization-card">
                    <div class="personalization-header">
                        <span>üé®</span>
                        <span>Personalizar perfil</span>
                    </div>
                    <div class="personalization-preview">
                        <div class="avatar-preview">
                            <div class="avatar-option">üë®‚Äçüéì</div>
                            <div class="avatar-option">üë©‚Äçüéì</div>
                        </div>
                        <div class="map-preview">
                            <div class="map-option"></div>
                            <div class="map-option"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Motiva√ß√£o -->
            <div class="motivation-footer">
                <p>Cada lugar que voc√™ descobre conta uma hist√≥ria.</p>
                <p style="opacity:0.8;margin-top:0.25rem">Continue explorando.</p>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div style="padding:0 1rem;margin-bottom:1rem;display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
                <button class="btn btn-primary" onclick="navigateTo('missions')">üéØ Miss√µes</button>
                <button class="btn" style="background:var(--primary);color:white;" onclick="toggleARMode()">üì± Modo AR</button>
            </div>
            
            <div style="padding:0 1rem;margin-bottom:1rem;">
                <button class="btn" style="background:var(--gold);color:var(--primary);width:100%;" onclick="navigateTo('feedback')">
                    üí° Dar sua opini√£o
                </button>
            </div>

            <button class="btn-logout" onclick="logout()">üö™ Sair da conta</button>
        </div>

        <!-- FEEDBACK SCREEN -->
        <div class="screen" id="screen-feedback">
            <div class="feedback-header">
                <div class="feedback-icon">üí°</div>
                <h1 class="feedback-title">Sugest√µes dos Exploradores</h1>
            </div>
            
            <div class="feedback-content">
                <div class="feedback-question">
                    <p>Como podemos melhorar o PK Explorer?</p>
                </div>
                
                <textarea 
                    id="feedbackText" 
                    class="feedback-textarea" 
                    placeholder="Escreva sua ideia..."
                    maxlength="500"></textarea>
                
                <div class="feedback-section-title">Selecione o tema da sua ideia:</div>
                
                <div class="feedback-categories">
                    <button class="feedback-category" data-category="jogos" onclick="selectFeedbackCategory('jogos')">
                        <span class="category-icon">üéÆ</span>
                        <span class="category-text">Jogos e desafios</span>
                    </button>
                    
                    <button class="feedback-category" data-category="mapa" onclick="selectFeedbackCategory('mapa')">
                        <span class="category-icon">üó∫Ô∏è</span>
                        <span class="category-text">Melhorar o mapa</span>
                    </button>
                    
                    <button class="feedback-category" data-category="pontos" onclick="selectFeedbackCategory('pontos')">
                        <span class="category-icon">üèÜ</span>
                        <span class="category-text">Pontos e ranking</span>
                    </button>
                    
                    <button class="feedback-category" data-category="visual" onclick="selectFeedbackCategory('visual')">
                        <span class="category-icon">üé®</span>
                        <span class="category-text">Visual do app</span>
                    </button>
                    
                    <button class="feedback-category" data-category="aprendizagem" onclick="selectFeedbackCategory('aprendizagem')">
                        <span class="category-icon">üìö</span>
                        <span class="category-text">Aprendizagem</span>
                    </button>
                    
                    <button class="feedback-category" data-category="problemas" onclick="selectFeedbackCategory('problemas')">
                        <span class="category-icon">üêû</span>
                        <span class="category-text">Problemas/erros</span>
                    </button>
                </div>
                
                <div class="feedback-section-title">O quanto voc√™ gosta do app?</div>
                
                <div class="feedback-rating">
                    <button class="star-btn" data-rating="1" onclick="setFeedbackRating(1)">‚≠ê</button>
                    <button class="star-btn" data-rating="2" onclick="setFeedbackRating(2)">‚≠ê</button>
                    <button class="star-btn" data-rating="3" onclick="setFeedbackRating(3)">‚≠ê</button>
                    <button class="star-btn" data-rating="4" onclick="setFeedbackRating(4)">‚≠ê</button>
                    <button class="star-btn" data-rating="5" onclick="setFeedbackRating(5)">‚≠ê</button>
                </div>
                
                <button class="btn-submit-feedback" onclick="submitFeedback()">
                    <span class="btn-icon">üöÄ</span>
                    <span class="btn-text">Enviar sugest√£o</span>
                </button>
                
                <div class="feedback-thanks" id="feedbackThanks" style="display:none;">
                    <div class="thanks-avatar">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23c4a35a'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='%232d5a3d'%3Eüòä%3C/text%3E%3C/svg%3E" alt="Explorador">
                    </div>
                    <p class="thanks-title">Obrigado, explorador!</p>
                    <p class="thanks-text">Sua ideia pode aparecer na pr√≥xima atualiza√ß√£o.</p>
                </div>
            </div>
        </div>

    </div><!-- /screens -->

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="navigateTo('home')" id="nav-home">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">In√≠cio</div>
        </button>
        <button class="nav-item" onclick="navigateTo('map')" id="nav-map">
            <div class="nav-icon">üó∫Ô∏è</div>
            <div class="nav-label">Mapa</div>
        </button>
        <button class="nav-item" onclick="navigateTo('missions')" id="nav-missions">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Progresso</div>
        </button>
        <button class="nav-item" onclick="navigateTo('feed')" id="nav-feed">
            <div class="nav-icon">üì∞</div>
            <div class="nav-label">Descobertas</div>
        </button>
        <button class="nav-item" onclick="navigateTo('teacher')" id="nav-teacher" style="display:none;">
            <div class="nav-icon">üë®‚Äçüè´</div>
            <div class="nav-label">Professor</div>
        </button>
        <button class="nav-item" onclick="navigateTo('memories')" id="nav-memories">
            <div class="nav-icon">üì∏</div>
            <div class="nav-label">Mem√≥rias</div>
        </button>
        <button class="nav-item" onclick="navigateTo('geography')" id="nav-geography">
            <div class="nav-icon">üåç</div>
            <div class="nav-label">Geografia</div>
        </button>
        <button class="nav-item" onclick="navigateTo('profile')" id="nav-profile">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">Perfil</div>
        </button>
    </nav>
</div>

<!-- AUTH SCREEN -->
    <!-- AR CAMERA OVERLAY -->
    <div class="ar-overlay" id="arOverlay" style="display:none;">
        <div class="ar-header">
            <button class="ar-close" onclick="closeAR()">√ó</button>
            <div class="ar-title" id="arTitle">üì± Modo AR</div>
        </div>
        
        <!-- Video da c√¢mera -->
        <video id="arCamera" autoplay playsinline muted></video>
        
        <!-- Canvas para overlay -->
        <canvas id="arCanvas"></canvas>
        
        <!-- Foto hist√≥rica sobreposta -->
        <div class="ar-photo-overlay" id="arPhotoOverlay" style="display:none;">
            <img id="arHistoricalPhoto" src="" alt="Foto Hist√≥rica">
            <div class="ar-slider-container">
                <input type="range" min="0" max="100" value="50" class="ar-slider" id="arSlider">
                <div class="ar-slider-label">üëà Deslize para comparar üëâ</div>
            </div>
        </div>
        
        <!-- Info do local -->
        <div class="ar-info" id="arInfo" style="display:none;">
            <div class="ar-info-icon">üìç</div>
            <div class="ar-info-content">
                <div class="ar-info-title" id="arInfoTitle">Local Hist√≥rico</div>
                <div class="ar-info-year" id="arInfoYear">Ano</div>
                <div class="ar-info-distance" id="arInfoDistance">Dist√¢ncia</div>
            </div>
        </div>
        
        <!-- Estado de busca -->
        <div class="ar-searching" id="arSearching">
            <div class="ar-searching-icon">üîç</div>
            <div class="ar-searching-text">Procurando locais hist√≥ricos...</div>
            <div class="ar-searching-hint">Aproxime-se de um ponto hist√≥rico</div>
        </div>
        
        <!-- Contador de descobertas -->
        <div class="ar-counter" id="arCounter">
            <span id="arCounterText">0/22 descobertos</span>
        </div>
    </div>

<div id="authScreen">
    <div class="screen-content" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1.5rem;">
        <div class="auth-card">
            <div class="auth-logo">
                <span class="auth-logo-icon">üó∫Ô∏è</span>
                <div class="auth-logo-title">PK Explorer</div>
                <div class="auth-logo-sub">‚ú¶ Mem√≥rias de Presidente Dutra ‚ú¶</div>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login', this)">Entrar</button>
                <button class="auth-tab" onclick="switchAuthTab('register', this)">Criar Conta</button>
            </div>

            <!-- LOGIN -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">E-mail</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="loginError" class="form-error hidden"></div>
                <button class="btn-full" onclick="login()">Entrar ‚Üí</button>
                <div class="auth-divider">ou</div>
                <button class="btn-full btn-gold" onclick="quickLogin()">‚ö° Acesso R√°pido (Demo)</button>
            </div>

            <!-- REGISTER -->
            <div id="registerForm" style="display:none;">
                <div class="form-group">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" class="form-input" id="regName" placeholder="Seu nome">
                </div>
                <div class="form-group">
                    <label class="form-label">E-mail</label>
                    <input type="email" class="form-input" id="regEmail" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="regPassword" placeholder="M√≠nimo 6 caracteres">
                </div>
                <div class="form-group">
                    <label class="form-label">Voc√™ √©:</label>
                    <select class="form-select" id="regRole" onchange="toggleTurma()">
                        <option value="aluno">üë®‚Äçüéì Aluno</option>
                        <option value="professor">üë®‚Äçüè´ Professor</option>
                    </select>
                </div>
                <div class="form-group" id="turmaGroup">
                    <label class="form-label">Turma</label>
                    <select class="form-select" id="regTurma">
                        <option value="6ANOA">6¬∫ Ano A</option>
                        <option value="6ANOB">6¬∫ Ano B</option>
                        <option value="7ANOA">7¬∫ Ano A</option>
                        <option value="7ANOB">7¬∫ Ano B</option>
                        <option value="8ANOA">8¬∫ Ano A</option>
                        <option value="8ANOB">8¬∫ Ano B</option>
                        <option value="9ANO">9¬∫ Ano</option>
                    </select>
                </div>
                <div id="regError" class="form-error hidden"></div>
                <button class="btn-full" onclick="register()">Criar Conta ‚Üí</button>
            </div>
        </div>
    </div>
</div>

<script>
'use strict';

// =================================================================
// BANCO DE DADOS DE FOTOS HIST√ìRICAS
// =================================================================
const HISTORICAL_PHOTOS = [
    {id:'hist_001',title:'Popula√ß√£o do Curador ajuda a construir a Capela de S√£o Sebasti√£o',description:'Registro hist√≥rico da comunidade do Curador participando da constru√ß√£o da primeira Capela de S√£o Sebasti√£o, marco inicial da forma√ß√£o religiosa e urbana de Presidente Dutra.',year:'1929',decade:'Anos 20',category:'religiosa',sector:'setor_01',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1GYfuA_ZuppaEPzcMtdkJGvYjIXD7toXD&sz=w2000-h2000',radius:50},
    {id:'hist_002',title:'Capela de S√£o Sebasti√£o sendo erguida',description:'Imagem do processo de edifica√ß√£o da Capela de S√£o Sebasti√£o, s√≠mbolo do crescimento religioso e da organiza√ß√£o comunit√°ria local.',year:'1930',decade:'Anos 30',category:'religiosa',sector:'setor_01',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1cUyKWc5OFFuPLzS_TtUVqCqnLygjZgth&sz=w2000-h2000',radius:50},
    {id:'hist_003',title:'Igreja de S√£o Sebasti√£o substitui a capela',description:'Registro da nova Igreja de S√£o Sebasti√£o constru√≠da para substituir a antiga capela, demonstrando a expans√£o populacional e estrutural da cidade.',year:'1940',decade:'Anos 40',category:'religiosa',sector:'setor_01',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1QAv-tU7ZrZiPCdlTn8MU0gSuJQqZyP-j&sz=w2000-h2000',radius:50},
    {id:'hist_004',title:'Igreja de S√£o Sebasti√£o no in√≠cio dos anos 60',description:'Vista da igreja com a pra√ßa ainda sem cal√ßamento, evidenciando o est√°gio inicial da urbaniza√ß√£o do centro da cidade.',year:'1960',decade:'Anos 60',category:'religiosa',sector:'setor_01',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1xKAVB0VmQegOFy1GakT9zWKjCLYNi7GM&sz=w2000-h2000',radius:50},
    {id:'hist_005',title:'Esquina do Armaz√©m Porto Seguro',description:'Registro da esquina do tradicional Armaz√©m Porto Seguro, importante ponto comercial da cidade durante a d√©cada de 1960.',year:'1960',decade:'Anos 60',category:'comercio',sector:'setor_02',coordinates:{lat:-5.2903,lng:-44.4896},photo_url:'https://drive.google.com/thumbnail?id=1xYfCrbWYeABf8lnP9fwm4Kkxc9nSiVv-&sz=w2000-h2000',radius:30},
    {id:'hist_006',title:'Armaz√©m Porto Seguro ‚Äì Propriedade de JCOT',description:'Imagem do Armaz√©m Porto Seguro pertencente a Jos√© da Cruz de Oliveira Torres (JCOT), refer√™ncia comercial importante no desenvolvimento econ√¥mico local.',year:'1960',decade:'Anos 60',category:'comercio',sector:'setor_02',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1F09jo77K8Vr2wREtzh10WgNIVfy3VqZI&sz=w2000-h2000',radius:30},
    {id:'hist_007',title:'Armaz√©m Porto Seguro na Travessa Doca Sereno',description:'Vista do armaz√©m j√° localizado na esquina da Travessa Doca Sereno com a Pra√ßa S√£o Sebasti√£o, consolidando-se como polo comercial.',year:'1960',decade:'Anos 60',category:'comercio',sector:'setor_02',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1brJszuuwRpZ8rEiqu8ft669AG1iCc0Mq&sz=w2000-h2000',radius:30},
    {id:'hist_008',title:'Presidente Dutra no in√≠cio dos anos 60',description:'Panorama urbano da cidade no come√ßo da d√©cada de 1960, evidenciando ruas simples e estrutura em expans√£o.',year:'1960',decade:'Anos 60',category:'urbanismo',sector:'setor_03',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1HVRTmjbfpaZJu9Q1Uep43XRgUkRJwgNq&sz=w2000-h2000',radius:100},
    {id:'hist_009',title:'Rua Magalh√£es de Almeida anos depois',description:'Registro do mesmo trecho da rua em per√≠odo posterior, permitindo compara√ß√£o entre diferentes fases de urbaniza√ß√£o.',year:'1970',decade:'Anos 70',category:'urbanismo',sector:'setor_03',coordinates:{lat:-5.2831462,lng:-44.4929264},photo_url:'https://drive.google.com/thumbnail?id=1ye0Uw01kiaks7W9DoXietCagyG52wUom&sz=w2000-h2000',radius:80},
    {id:'hist_010',title:'Travessa Ant√¥nio Macedo',description:'Imagem da Travessa Ant√¥nio Macedo, importante via de circula√ß√£o no desenvolvimento urbano do munic√≠pio.',year:'1960',decade:'Anos 60',category:'urbanismo',sector:'setor_03',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=10Vt6O6I5cDmqtwRPne0XuJ5THj5VLi6h&sz=w2000-h2000',radius:50},
    {id:'hist_011',title:'Prolongamento da BR-226',description:'Registro do trecho que integra a BR-226, fundamental para a liga√ß√£o regional entre o Rio Parna√≠ba e o Tocantins, impulsionando o crescimento econ√¥mico.',year:'1970',decade:'Anos 70',category:'urbanismo',sector:'setor_03',coordinates:{lat:-5.286,lng:-44.505},photo_url:'https://drive.google.com/thumbnail?id=1hZ1wdpCAPxO34-xi7Ag5xhfSIT_xAe8O&sz=w2000-h2000',radius:100},
    {id:'hist_012',title:'Avenida Tancredo Neves',description:'Vista da Avenida Tancredo Neves, s√≠mbolo da expans√£o urbana e moderniza√ß√£o da infraestrutura municipal.',year:'1980',decade:'Anos 80',category:'urbanismo',sector:'setor_03',coordinates:{lat:-5.2875,lng:-44.5020},photo_url:'https://drive.google.com/thumbnail?id=1_WcCvSGvZ-8FG9FLnOzmhEF_0r3luCmA&sz=w2000-h2000',radius:100},
    {id:'hist_013',title:'Matriz S√£o Sebasti√£o',description:'Catedral iniciada em 1945 e conclu√≠da em 1949, constru√≠da em homenagem a S√£o Sebasti√£o, consolidando a identidade religiosa da cidade.',year:'1949',decade:'Anos 40',category:'religiosa',sector:'setor_01',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1OPjUnwYsKH3ysIJKB3induLq9YLghO8s&sz=w2000-h2000',radius:50},
    {id:'hist_014',title:'Igreja Batista',description:'Templo inaugurado em 1979, tendo como primeiro pastor Gessi Camilo de Sousa, representando a diversidade religiosa no munic√≠pio.',year:'1979',decade:'Anos 70',category:'religiosa',sector:'setor_01',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1oqe0h4EzSNyKsHv9bblxk_aN4UyTJD0N&sz=w2000-h2000',radius:50},
    {id:'hist_015',title:'Igreja Crist√£ Evang√©lica',description:'Registro da Igreja Crist√£ Evang√©lica fundada em 1947, importante marco da presen√ßa evang√©lica na cidade.',year:'1947',decade:'Anos 40',category:'religiosa',sector:'setor_01',coordinates:{lat:-5.2831462,lng:-44.4929264},photo_url:'https://drive.google.com/thumbnail?id=16fpUwXFYfYUF7DLJrzpiAHvp3sB-bJJc&sz=w2000-h2000',radius:50},
    {id:'hist_016',title:'Assembleia de Deus',description:'Imagem da Assembleia de Deus em 1974, demonstrando a consolida√ß√£o do movimento pentecostal em Presidente Dutra.',year:'1974',decade:'Anos 70',category:'religiosa',sector:'setor_01',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1qZiOqbK60B78bZEqDFf526FsVf0e9O0v&sz=w2000-h2000',radius:50},
    {id:'hist_017',title:'CHESF ‚Äì In√≠cio das obras da Eletronorte',description:'Registro do in√≠cio das obras relacionadas √† Eletronorte, marcando avan√ßo energ√©tico e estrutural na regi√£o.',year:'1970',decade:'Anos 70',category:'predio_publico',sector:'setor_03',coordinates:{lat:-5.2831462,lng:-44.4929264},photo_url:'https://drive.google.com/thumbnail?id=1qSHp1NF2tqG9YEPDCQqQIXxwd4p9pB6E&sz=w2000-h2000',radius:80},
    {id:'hist_018',title:'Eletronorte ‚Äì Dias atuais',description:'Imagem recente da Eletronorte (foto IBGE), demonstrando a moderniza√ß√£o da infraestrutura energ√©tica local.',year:'2020',decade:'Anos 2020',category:'predio_publico',sector:'setor_03',coordinates:{lat:-5.2831462,lng:-44.4929264},photo_url:'https://drive.google.com/thumbnail?id=1sEhqQlSGa7joBIdunZVMKY27fpVx2vIo&sz=w2000-h2000',radius:80},
    {id:'hist_019',title:'Armaz√©m Porto Seguro ‚Äì Com√©rcio em expans√£o',description:'Registro do armaz√©m ampliando seu mix de produtos, evidenciando o fortalecimento do com√©rcio local.',year:'1960',decade:'Anos 60',category:'comercio',sector:'setor_02',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1MRWRvn6r8zsSrsAWfWd49QOc4T5bA2HH&sz=w2000-h2000',radius:30},
    {id:'hist_020',title:'Pra√ßa S√£o Sebasti√£o',description:'Pra√ßa S√£o Sebasti√£o em uma manh√£ de final de inverno de 2007, mostrando o centro urbano j√° consolidado.',year:'2007',decade:'Anos 2000',category:'praca',sector:'setor_01',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=13nuISfe6T96GZOFSa67a4epqy-z23odz&sz=w2000-h2000',radius:50},
    {id:'hist_021',title:'Rua com Gado',description:'Cotidiano rural - Documento √∫nico da vida urbana com gado nas ruas de Presidente Dutra.',year:'1960',decade:'Anos 60',category:'historia_rural',sector:'setor_03',coordinates:{lat:-5.2902343,lng:-44.4895682},photo_url:'https://drive.google.com/thumbnail?id=1HVRTmjbfpaZJu9Q1Uep43XRgUkRJwgNq&sz=w2000-h2000',radius:100}
];

function calculateDistance(lat1,lon1,lat2,lon2){const R=6371e3;const œÜ1=lat1*Math.PI/180;const œÜ2=lat2*Math.PI/180;const ŒîœÜ=(lat2-lat1)*Math.PI/180;const ŒîŒª=(lon2-lon1)*Math.PI/180;const a=Math.sin(ŒîœÜ/2)*Math.sin(ŒîœÜ/2)+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)*Math.sin(ŒîŒª/2);const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c;}
function getNearbyHistoricalPhotos(lat,lng,max=100){return HISTORICAL_PHOTOS.filter(p=>p.coordinates&&calculateDistance(lat,lng,p.coordinates.lat,p.coordinates.lng)<=(p.radius||max)).sort((a,b)=>calculateDistance(lat,lng,a.coordinates.lat,a.coordinates.lng)-calculateDistance(lat,lng,b.coordinates.lat,b.coordinates.lng));}
function getClosestHistoricalPhoto(lat,lng){const n=getNearbyHistoricalPhotos(lat,lng,200);return n.length>0?n[0]:null;}
function countDiscoveredPhotos(){const d=localStorage.getItem('ar_discovered');return d?JSON.parse(d).length:0;}
function markPhotoAsDiscovered(id){let d=localStorage.getItem('ar_discovered');d=d?JSON.parse(d):[];if(!d.includes(id)){d.push(id);localStorage.setItem('ar_discovered',JSON.stringify(d));return true;}return false;}

// =================================================================
// AUTH SYSTEM
// =================================================================
const Auth = {
    getUsers: () => JSON.parse(localStorage.getItem('pk_users') || '[]'),
    saveUsers: (u) => localStorage.setItem('pk_users', JSON.stringify(u)),
    getCurrent: () => JSON.parse(localStorage.getItem('pk_current_user') || 'null'),
    setCurrent: (u) => localStorage.setItem('pk_current_user', JSON.stringify(u)),
    clear: () => localStorage.removeItem('pk_current_user'),

    login(email, password) {
        const users = this.getUsers();
        const user = users.find(u => u.email === email && u.password === password);
        if (!user) return { error: 'E-mail ou senha incorretos' };
        this.setCurrent(user);
        return { user };
    },

    register(data) {
        const users = this.getUsers();
        if (users.find(u => u.email === data.email)) return { error: 'E-mail j√° cadastrado' };
        
        // Criar usu√°rio com role expl√≠cito
        const user = { 
            id: Date.now().toString(),
            name: data.name,
            email: data.email,
            password: data.password,
            role: data.role,
            turma: data.turma,
            xp: 0, 
            points: 0, 
            badges: [] 
        };
        
        users.push(user);
        this.saveUsers(users);
        this.setCurrent(user);
        return { user };
    }
};

// =================================================================
// STATE
// =================================================================
let AppState = {
    user: null,
    currentScreen: 'home',
    map: null,
    markers: [],
    wizardStep: 0,
    location: null,
    mainPhoto: null,
    beforePhoto: null
};

// =================================================================
// INIT
// =================================================================
window.addEventListener('load', () => {
    const user = Auth.getCurrent();
    if (user) {
        AppState.user = user;
        showApp();
    } else {
        document.getElementById('authScreen').style.display = 'block';
    }

    // Online/offline
    window.addEventListener('offline', () => {
        document.getElementById('mapOfflineBanner').style.display = 'block';
        showToast('‚úàÔ∏è', 'Modo offline', 'Usando dados do cache');
    });
    window.addEventListener('online', () => {
        document.getElementById('mapOfflineBanner').style.display = 'none';
        showToast('üåê', 'Online', 'Conex√£o restaurada!');
    });
});

// =================================================================
// AUTH FUNCTIONS
// =================================================================
function switchAuthTab(tab, el) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
}

function toggleTurma() {
    const role = document.getElementById('regRole').value;
    document.getElementById('turmaGroup').style.display = role === 'aluno' ? 'block' : 'none';
}

function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errEl = document.getElementById('loginError');

    if (!email || !password) {
        errEl.textContent = 'Preencha e-mail e senha';
        errEl.classList.remove('hidden');
        return;
    }

    const result = Auth.login(email, password);
    if (result.error) {
        errEl.textContent = result.error;
        errEl.classList.remove('hidden');
        return;
    }

    AppState.user = result.user;
    document.getElementById('authScreen').style.display = 'none';
    showApp();
}

function register() {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;
    const role = document.getElementById('regRole').value;
    const turma = role === 'aluno' ? document.getElementById('regTurma').value : null;
    const errEl = document.getElementById('regError');

    if (!name || !email || !password) {
        errEl.textContent = 'Preencha todos os campos';
        errEl.classList.remove('hidden');
        return;
    }

    if (password.length < 6) {
        errEl.textContent = 'Senha deve ter pelo menos 6 caracteres';
        errEl.classList.remove('hidden');
        return;
    }

    const result = Auth.register({ name, email, password, role, turma });
    if (result.error) {
        errEl.textContent = result.error;
        errEl.classList.remove('hidden');
        return;
    }

    AppState.user = result.user;
    document.getElementById('authScreen').style.display = 'none';
    showApp();
    showToast('üéâ', 'Conta criada!', `Bem-vindo ao PK Explorer, ${name}!`);
}

function quickLogin() {
    const users = Auth.getUsers();
    let demo = users.find(u => u.email === 'demo@pkexplorer.com');
    if (!demo) {
        Auth.register({ name: 'Maria Santos', email: 'demo@pkexplorer.com', password: '123456', role: 'aluno', turma: '6ANOA', xp: 350, points: 7 });
        demo = Auth.getCurrent();
    } else {
        Auth.setCurrent(demo);
    }
    AppState.user = demo;
    document.getElementById('authScreen').style.display = 'none';
    showApp();
    showToast('‚ö°', 'Acesso r√°pido!', 'Bem-vindo, Maria Santos');
}

function logout() {
    if (!confirm('Deseja sair da sua conta?')) return;
    Auth.clear();
    AppState.user = null;
    AppState.map = null;
    location.reload();
}

// Profile photo update
async function updateProfilePhoto(input) {
    const file = input.files[0];
    if (!file) return;
    
    try {
        // Compress image
        const options = { maxSizeMB: 0.5, maxWidthOrHeight: 400, useWebWorker: true };
        const compressed = await imageCompression(file, options);
        
        // Convert to base64
        const reader = new FileReader();
        reader.onload = function(e) {
            const photoUrl = e.target.result;
            
            // Update avatar displays
            document.getElementById('profileAvatarBig').style.backgroundImage = `url(${photoUrl})`;
            document.getElementById('profileAvatarBig').style.backgroundSize = 'cover';
            document.getElementById('profileAvatarBig').style.backgroundPosition = 'center';
            document.getElementById('profileAvatarBig').textContent = '';
            
            document.getElementById('topbarAvatar').style.backgroundImage = `url(${photoUrl})`;
            document.getElementById('topbarAvatar').style.backgroundSize = 'cover';
            document.getElementById('topbarAvatar').style.backgroundPosition = 'center';
            document.getElementById('topbarAvatar').textContent = '';
            
            // Save to localStorage
            if (AppState.user) {
                AppState.user.photo = photoUrl;
                Auth.setCurrent(AppState.user);
            }
            
            showToast('‚úÖ', 'Foto atualizada!', 'Sua foto de perfil foi alterada');
        };
        reader.readAsDataURL(compressed);
    } catch (e) {
        showToast('‚ùå', 'Erro', 'N√£o foi poss√≠vel processar a foto');
    }
}

// =================================================================
// AR MODE - REALIDADE AUMENTADA
// =================================================================
let arActive=false;
let arStream=null;
let arWatchId=null;
let currentHistoricalPhoto=null;

async function toggleARMode(){
    if(!arActive){await openARMode();}
    else{closeAR();}
}

async function openARMode(){
    try{
        arStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        document.getElementById('arOverlay').style.display='block';
        document.getElementById('appShell').style.display='none';
        const video=document.getElementById('arCamera');
        video.srcObject=arStream;
        updateARCounter();
        startARDetection();
        arActive=true;
        showToast('üì±','AR Ativado','Procurando locais hist√≥ricos...');
    }catch(e){
        console.error('Erro c√¢mera:',e);
        showToast('‚ùå','Erro','N√£o foi poss√≠vel acessar a c√¢mera');
    }
}

function closeAR(){
    if(arStream){arStream.getTracks().forEach(t=>t.stop());arStream=null;}
    if(arWatchId){navigator.geolocation.clearWatch(arWatchId);arWatchId=null;}
    document.getElementById('arOverlay').style.display='none';
    document.getElementById('appShell').style.display='flex';
    arActive=false;
}

function startARDetection(){
    if(!navigator.geolocation){showToast('‚ùå','GPS indispon√≠vel','');return;}
    arWatchId=navigator.geolocation.watchPosition(pos=>{
        checkNearbyHistoricalPhotos(pos.coords.latitude,pos.coords.longitude);
    },err=>console.error('GPS:',err),{enableHighAccuracy:true,timeout:5000,maximumAge:0});
}

function checkNearbyHistoricalPhotos(lat,lng){
    const closest=getClosestHistoricalPhoto(lat,lng);
    if(closest){
        const dist=calculateDistance(lat,lng,closest.coordinates.lat,closest.coordinates.lng);
        if(dist<=closest.radius){showHistoricalPhoto(closest,dist);}
        else{hideHistoricalPhoto();}
    }else{hideHistoricalPhoto();}
}

function showHistoricalPhoto(photo,dist){
    currentHistoricalPhoto=photo;
    document.getElementById('arSearching').style.display='none';
    const overlay=document.getElementById('arPhotoOverlay');
    const img=document.getElementById('arHistoricalPhoto');
    const info=document.getElementById('arInfo');
    
    // Mostrar loading
    const loadingMsg = document.createElement('div');
    loadingMsg.id = 'photoLoading';
    loadingMsg.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:12px;font-size:18px;z-index:999;';
    loadingMsg.textContent = '‚è≥ Carregando foto...';
    overlay.appendChild(loadingMsg);
    
    // SOLU√á√ÉO: Usar proxy CORS com timeout maior para mobile
    const proxies = [
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url='
    ];
    
    let currentProxyIndex = 0;
    let loadTimeout;
    
    function tryLoadImage() {
        // Limpar timeout anterior
        if (loadTimeout) clearTimeout(loadTimeout);
        
        img.crossOrigin = "anonymous";
        
        // Tentar com proxy
        const proxyUrl = proxies[currentProxyIndex];
        const finalUrl = proxyUrl + encodeURIComponent(photo.photo_url);
        
        console.log(`üì± Tentando carregar (mobile) com proxy ${currentProxyIndex + 1}:`, finalUrl);
        
        // Timeout de 10 segundos para mobile
        loadTimeout = setTimeout(() => {
            console.error(`‚è±Ô∏è Timeout com proxy ${currentProxyIndex + 1}`);
            currentProxyIndex++;
            
            if (currentProxyIndex < proxies.length) {
                tryLoadImage();
            } else {
                // Remover loading
                const loading = document.getElementById('photoLoading');
                if (loading) loading.remove();
                showToast('‚ùå', 'Foto n√£o carregou', 'Verifique sua conex√£o');
            }
        }, 10000);
        
        img.onload = function() {
            clearTimeout(loadTimeout);
            const loading = document.getElementById('photoLoading');
            if (loading) loading.remove();
            console.log('‚úÖ Foto carregada:', photo.title);
        };
        
        img.onerror = function() {
            clearTimeout(loadTimeout);
            console.error(`‚ùå Erro com proxy ${currentProxyIndex + 1}`);
            currentProxyIndex++;
            
            if (currentProxyIndex < proxies.length) {
                setTimeout(tryLoadImage, 1000);
            } else {
                const loading = document.getElementById('photoLoading');
                if (loading) loading.remove();
                showToast('‚ùå', 'Erro ao carregar', 'Tente novamente');
            }
        };
        
        img.src = finalUrl;
    }
    
    tryLoadImage();
    
    overlay.style.display='flex';
    info.style.display='flex';
    document.getElementById('arInfoTitle').textContent=photo.title;
    document.getElementById('arInfoYear').textContent=photo.year;
    document.getElementById('arInfoDistance').textContent=`üìè ${Math.round(dist)}m de voc√™`;
    const slider=document.getElementById('arSlider');
    slider.oninput=function(){img.style.opacity=this.value/100;};
    const isNew=markPhotoAsDiscovered(photo.id);
    if(isNew){
        if(AppState.user){
            AppState.user.xp=(AppState.user.xp||0)+50;
            Auth.setCurrent(AppState.user);
            document.getElementById('topbarXP').textContent=`‚≠ê ${AppState.user.xp} XP`;
        }
        updateARCounter();
        createConfetti();
        showToast('üéâ','Nova Descoberta!',`+50 XP - ${photo.title}`);
        if(navigator.vibrate){navigator.vibrate([200,100,200]);}
    }
}

function hideHistoricalPhoto(){
    document.getElementById('arPhotoOverlay').style.display='none';
    document.getElementById('arInfo').style.display='none';
    document.getElementById('arSearching').style.display='block';
    currentHistoricalPhoto=null;
}

function updateARCounter(){
    const count=countDiscoveredPhotos();
    document.getElementById('arCounterText').textContent=`${count}/22 descobertos`;
}

// =================================================================
// PROFILE LEVEL & PROGRESS SYSTEM
// =================================================================
function calculateLevel(xp){
    if(xp<500)return{level:1,name:'Exploradora',next:500};
    if(xp<1000)return{level:2,name:'Investigadora',next:1000};
    if(xp<2000)return{level:3,name:'Historiadora',next:2000};
    if(xp<4000)return{level:4,name:'Mestre Exploradora',next:4000};
    return{level:5,name:'Guardi√£ da Mem√≥ria',next:5000};
}

function updateProfileDisplay(){
    if(!AppState.user)return;
    
    const xp=AppState.user.xp||0;
    const level=calculateLevel(xp);
    const progress=(xp/level.next)*100;
    const remaining=level.next-xp;
    
    // Update name and title
    document.getElementById('profileName').textContent=AppState.user.name;
    document.getElementById('profileTitle').textContent=`üèÜ ${level.name} N√≠vel ${level.level}`;
    
    // Update XP
    document.getElementById('profileXPValue').textContent=`${xp} XP`;
    
    // Update progress bar
    const bar=document.getElementById('profileProgressBar');
    if(bar){
        bar.style.width=`${Math.min(progress,100)}%`;
    }
    
    // Update progress text
    const nextLevelName=level.level<5?calculateLevel(level.next).name:'M√°ximo';
    document.getElementById('profileProgressText').textContent=
        level.level<5?`Faltam ${remaining} XP para ${nextLevelName}`:'N√≠vel M√°ximo Alcan√ßado!';
    
    // Update streak (example - would be calculated from real data)
    const streak=calculateStreak();
    document.getElementById('profileStreak').textContent=`Sequ√™ncia: ${streak} dias`;
    
    // Update avatar
    const initial=AppState.user.name?AppState.user.name.charAt(0).toUpperCase():'U';
    document.getElementById('profileAvatarBig').textContent=initial;
    
    // Update photo if exists
    if(AppState.user.photo){
        const avatarEl=document.getElementById('profileAvatarBig');
        avatarEl.style.backgroundImage=`url(${AppState.user.photo})`;
        avatarEl.style.backgroundSize='cover';
        avatarEl.style.backgroundPosition='center';
        avatarEl.textContent='';
    }
}

function calculateStreak(){
    // Simple example - in production would check daily login data
    const lastLogin=localStorage.getItem('last_login_date');
    const today=new Date().toDateString();
    const streak=parseInt(localStorage.getItem('login_streak')||'1');
    
    if(lastLogin===today){
        return streak;
    }else{
        const yesterday=new Date();
        yesterday.setDate(yesterday.getDate()-1);
        if(lastLogin===yesterday.toDateString()){
            const newStreak=streak+1;
            localStorage.setItem('login_streak',newStreak.toString());
            localStorage.setItem('last_login_date',today);
            return newStreak;
        }else{
            localStorage.setItem('login_streak','1');
            localStorage.setItem('last_login_date',today);
            return 1;
        }
    }
}

function startARMode(){toggleARMode();}
function stopARMode(){closeAR();}

// =================================================================
// FEEDBACK SYSTEM
// =================================================================
let feedbackData={category:null,rating:0};

function selectFeedbackCategory(category){
    feedbackData.category=category;
    document.querySelectorAll('.feedback-category').forEach(btn=>{
        btn.classList.remove('selected');
    });
    const selected=document.querySelector(`[data-category="${category}"]`);
    if(selected){
        selected.classList.add('selected');
    }
}

function setFeedbackRating(rating){
    feedbackData.rating=rating;
    document.querySelectorAll('.star-btn').forEach((btn,idx)=>{
        if(idx<rating){
            btn.classList.add('active');
        }else{
            btn.classList.remove('active');
        }
    });
}

function submitFeedback(){
    const text=document.getElementById('feedbackText').value.trim();
    
    if(!text){
        showToast('‚ö†Ô∏è','Campo vazio','Por favor, escreva sua sugest√£o');
        return;
    }
    
    if(!feedbackData.category){
        showToast('‚ö†Ô∏è','Selecione um tema','Escolha uma categoria para sua sugest√£o');
        return;
    }
    
    if(feedbackData.rating===0){
        showToast('‚ö†Ô∏è','Avalie o app','D√™ uma nota de 1 a 5 estrelas');
        return;
    }
    
    const feedback={
        id:Date.now(),
        user:AppState.user?AppState.user.name:'An√¥nimo',
        userEmail:AppState.user?AppState.user.email:'',
        text:text,
        category:feedbackData.category,
        rating:feedbackData.rating,
        timestamp:new Date().toISOString(),
        date:new Date().toLocaleString('pt-BR')
    };
    
    let allFeedback=localStorage.getItem('pk_feedback');
    allFeedback=allFeedback?JSON.parse(allFeedback):[];
    allFeedback.push(feedback);
    localStorage.setItem('pk_feedback',JSON.stringify(allFeedback));
    
    document.getElementById('feedbackText').value='';
    feedbackData={category:null,rating:0};
    document.querySelectorAll('.feedback-category').forEach(btn=>btn.classList.remove('selected'));
    document.querySelectorAll('.star-btn').forEach(btn=>btn.classList.remove('active'));
    
    document.querySelector('.feedback-content > *:not(#feedbackThanks)').forEach(el=>{
        if(el.id!=='feedbackThanks'){
            el.style.display='none';
        }
    });
    document.getElementById('feedbackThanks').style.display='block';
    
    setTimeout(()=>{
        document.querySelectorAll('.feedback-content > *').forEach(el=>el.style.display='');
        document.getElementById('feedbackThanks').style.display='none';
        navigateTo('home');
    },3000);
    
    showToast('‚úÖ','Enviado!','Obrigado pela sua sugest√£o');
    
    if(AppState.user){
        AppState.user.xp=(AppState.user.xp||0)+10;
        Auth.setCurrent(AppState.user);
        document.getElementById('topbarXP').textContent=`‚≠ê ${AppState.user.xp} XP`;
    }
}

function exportFeedbackData(){
    const feedback=localStorage.getItem('pk_feedback');
    if(!feedback||JSON.parse(feedback).length===0){
        alert('Nenhuma sugest√£o recebida ainda!');
        return;
    }
    
    const data=JSON.parse(feedback);
    let csv='Data,Usu√°rio,Email,Categoria,Avalia√ß√£o,Sugest√£o\n';
    
    data.forEach(item=>{
        const text=item.text.replace(/"/g,'""').replace(/\n/g,' ');
        csv+=`"${item.date}","${item.user}","${item.userEmail}","${item.category}",${item.rating},"${text}"\n`;
    });
    
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download=`pk-explorer-feedback-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showToast('üìä','Exportado!',`${data.length} sugest√µes exportadas`);
}

function viewAllFeedback(){
    const feedback=localStorage.getItem('pk_feedback');
    if(!feedback){
        alert('Nenhuma sugest√£o ainda!');
        return;
    }
    
    const data=JSON.parse(feedback);
    let html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>Sugest√µes PK Explorer</title>';
    html+='<style>body{font-family:Arial;padding:2rem;background:#f5f5f5;}';
    html+='.feedback{background:white;padding:1.5rem;margin-bottom:1rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}';
    html+='.header{display:flex;justify-content:space-between;margin-bottom:1rem;}';
    html+='.user{font-weight:bold;color:#2d5a3d;}';
    html+='.date{color:#666;font-size:0.9rem;}';
    html+='.category{display:inline-block;background:#c4a35a;color:white;padding:0.25rem 0.75rem;border-radius:12px;font-size:0.85rem;margin-bottom:0.5rem;}';
    html+='.rating{color:#c4a35a;margin-bottom:0.5rem;}';
    html+='.text{color:#333;line-height:1.6;}</style></head><body>';
    html+=`<h1>üìä Sugest√µes dos Exploradores (${data.length})</h1>`;
    html+=`<button onclick="window.print()" style="padding:0.75rem 1.5rem;background:#2d5a3d;color:white;border:none;border-radius:8px;cursor:pointer;margin-bottom:1rem">üñ®Ô∏è Imprimir</button>`;
    
    data.reverse().forEach(item=>{
        const stars='‚≠ê'.repeat(item.rating);
        html+=`<div class="feedback">`;
        html+=`<div class="header"><span class="user">${item.user}</span><span class="date">${item.date}</span></div>`;
        html+=`<div class="category">${item.category}</div>`;
        html+=`<div class="rating">${stars} (${item.rating}/5)</div>`;
        html+=`<div class="text">${item.text}</div>`;
        html+=`</div>`;
    });
    
    html+='</body></html>';
    
    const win=window.open('','_blank');
    win.document.write(html);
    win.document.close();
}

function stopARMode(){closeAR();}

// =================================================================
// APP SHELL
// =================================================================
function showApp() {
    const u = AppState.user;
    const appShell = document.getElementById('appShell');
    const authScreen = document.getElementById('authScreen');
    
    if (appShell) appShell.style.display = 'flex';
    if (authScreen) authScreen.style.display = 'none';

    // Update UI with user data - with safety checks
    const initial = u.name ? u.name.charAt(0).toUpperCase() : 'U';
    
    const topbarAvatar = document.getElementById('topbarAvatar');
    if (topbarAvatar) topbarAvatar.textContent = initial;
    
    const topbarXP = document.getElementById('topbarXP');
    if (topbarXP) topbarXP.textContent = `‚≠ê ${u.xp || 350} XP`;
    
    const welcomeName = document.getElementById('welcomeName');
    if (welcomeName) welcomeName.textContent = `Ol√°, ${u.name ? u.name.split(' ')[0] : 'Usu√°rio'}! üëã`;
    
    const profileAvatarBig = document.getElementById('profileAvatarBig');
    if (profileAvatarBig) profileAvatarBig.textContent = initial;
    
    const profileName = document.getElementById('profileName');
    if (profileName) profileName.textContent = u.name || 'Usu√°rio';
    
    const profileRole = document.getElementById('profileRole');
    if (profileRole) profileRole.textContent = u.role === 'professor' ? 'üë®‚Äçüè´ Professor' : `üë®‚Äçüéì Aluno ¬∑ Turma ${formatTurma(u.turma)}`;
    
    const profileTurma = document.getElementById('profileTurma');
    if (profileTurma) profileTurma.textContent = formatTurma(u.turma) || '‚Äî';

    // Toggle student/teacher screens
    const isProfessor = u.role && String(u.role).toLowerCase() === 'professor';
    console.log('DEBUG: User role =', u.role);
    console.log('DEBUG: Is professor?', isProfessor);
    
    if (isProfessor) {
        console.log('DEBUG: Activating teacher panel');
        
        const studentProgress = document.getElementById('studentProgress');
        if (studentProgress) studentProgress.style.display = 'none';
        
        // Hide missions/progresso nav for professor
        const navMissions = document.getElementById('nav-missions');
        if (navMissions) navMissions.style.display = 'none';
        
        // Show teacher nav button
        const navTeacher = document.getElementById('nav-teacher');
        if (navTeacher) navTeacher.style.display = 'block';
        
        setTimeout(function() {
            var nameEl = document.getElementById('teacherName');
            if (nameEl && u.name) nameEl.textContent = u.name.split(' ')[0];
        }, 100);
    } else {
        console.log('DEBUG: Activating student panel');
        
        const studentProgress = document.getElementById('studentProgress');
        if (studentProgress) studentProgress.style.display = 'block';
        
        // Show missions/progresso nav for students
        const navMissions = document.getElementById('nav-missions');
        if (navMissions) navMissions.style.display = 'block';
        
        // Hide teacher nav button
        const navTeacher = document.getElementById('nav-teacher');
        if (navTeacher) navTeacher.style.display = 'none';
    }
    
    // Update notification badge
    updateNotificationBadge();

    navigateTo('home');

    setTimeout(() => {
        renderFeed();
        initMap();
    }, 100);
}

function formatTurma(t) {
    if (!t) return '';
    const map = { '6ANOA': '6¬∫ Ano A', '6ANOB': '6¬∫ Ano B', '7ANOA': '7¬∫ Ano A', '7ANOB': '7¬∫ Ano B', '8ANOA': '8¬∫ Ano A', '8ANOB': '8¬∫ Ano B', '9ANO': '9¬∫ Ano' };
    return map[t] || t;
}

// =================================================================
// NAVIGATION
// =================================================================
// Navigation history
let navigationHistory = [];

// =================================================================
// MEM√ìRIAS DO BAIRRO - JAVASCRIPT
// =================================================================

let currentPhotoData = null;
let memoriesDiscovered = [];
let currentFilter = 'all';

function loadMemoriesFromLocalStorage() {
    const saved = localStorage.getItem('pk_memories_discovered');
    if (saved) {
        memoriesDiscovered = JSON.parse(saved);
    }
    updateMemoriesProgress();
}

function saveMemoriesToLocalStorage() {
    localStorage.setItem('pk_memories_discovered', JSON.stringify(memoriesDiscovered));
}

function markPhotoAsDiscovered(photoId) {
    if (!memoriesDiscovered.includes(photoId)) {
        memoriesDiscovered.push(photoId);
        saveMemoriesToLocalStorage();
        updateMemoriesProgress();
        return true;
    }
    return false;
}

function updateMemoriesProgress() {
    const total = HISTORICAL_PHOTOS.length;
    const completed = memoriesDiscovered.length;
    const percentage = (completed / total) * 100;
    
    const progressBar = document.getElementById('memoriesProgressBar');
    const completedEl = document.getElementById('memoriesCompleted');
    const xpEl = document.getElementById('memoriesXP');
    
    if (progressBar) progressBar.style.width = percentage + '%';
    if (completedEl) completedEl.textContent = completed;
    if (xpEl) xpEl.textContent = completed * 50;
}

function renderPhotoGrid() {
    const grid = document.getElementById('photoGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    HISTORICAL_PHOTOS.forEach((photo, index) => {
        // Apply filter
        if (currentFilter !== 'all') {
            if (currentFilter.startsWith('19') || currentFilter.startsWith('20')) {
                if (!photo.decade || !photo.decade.includes(currentFilter.substring(2,4))) return;
            } else {
                if (photo.category !== currentFilter) return;
            }
        }
        
        const isLocked = false; // Todas as fotos desbloqueadas!
        const isCompleted = memoriesDiscovered.includes(photo.id);
        
        const card = document.createElement('div');
        card.className = 'photo-card' + (isLocked ? ' photo-locked' : '');
        card.onclick = () => {
            if (!isLocked) openPhotoModal(photo);
        };
        
        card.innerHTML = `
            ${isLocked ? '<div class="photo-lock-icon">üîí</div>' : ''}
            ${isCompleted ? '<div class="photo-badge">‚úì Completo</div>' : ''}
            <img src="${photo.photo_url}" alt="${photo.title}" loading="lazy">
            <div class="photo-card-info">
                <div class="photo-card-year">${photo.year}</div>
                <div class="photo-card-title">${photo.title}</div>
                <div class="photo-card-location">${photo.description.substring(0,50)}...</div>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

function filterMemories(filter) {
    currentFilter = filter;
    
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderPhotoGrid();
}

function openPhotoModal(photo) {
    currentPhotoData = photo;
    
    // Mark as discovered
    const isNew = markPhotoAsDiscovered(photo.id);
    if (isNew && AppState.user) {
        AppState.user.xp = (AppState.user.xp || 0) + 50;
        Auth.setCurrent(AppState.user);
        const topbarXP = document.getElementById('topbarXP');
        if (topbarXP) topbarXP.textContent = `‚≠ê ${AppState.user.xp} XP`;
        showToast('üéâ', '+50 XP', 'Nova mem√≥ria descoberta!');
    }
    
    // Populate modal
    document.getElementById('modalTitle').textContent = photo.title;
    document.getElementById('modalLocation').textContent = photo.description;
    document.getElementById('modalYear').textContent = photo.year + ' - ' + photo.decade;
    document.getElementById('modalDescription').textContent = photo.description;
    document.getElementById('modalImage').src = photo.photo_url;
    
    // Setup compare slider
    document.getElementById('compareBefore').src = photo.photo_url;
    document.getElementById('compareAfter').src = photo.photo_url; // Would be current photo
    
    // Setup quiz if available
    setupQuiz(photo);
    
    // Load story and contributions
    document.getElementById('storyOriginal').innerHTML = `<p>${photo.description}</p>`;
    renderContributions(photo.id);
    
    // Show modal
    document.getElementById('photoModal').style.display = 'block';
    
    // Switch to first tab
    switchPhotoTab('info');
}

function closePhotoModal() {
    document.getElementById('photoModal').style.display = 'none';
    currentPhotoData = null;
}

function switchPhotoTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.photo-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.photo-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Initialize compare slider if switching to compare tab
    if (tabName === 'compare') {
        initCompareSlider();
    }
}

function initCompareSlider() {
    const slider = document.getElementById('compareSlider');
    const overlay = document.getElementById('compareOverlay');
    const handle = document.getElementById('compareHandle');
    
    let isDragging = false;
    
    function updateSlider(clientX) {
        const rect = slider.getBoundingClientRect();
        const x = clientX - rect.left;
        const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
        
        overlay.style.width = percentage + '%';
        handle.style.left = percentage + '%';
    }
    
    handle.addEventListener('mousedown', () => isDragging = true);
    handle.addEventListener('touchstart', () => isDragging = true);
    
    document.addEventListener('mousemove', (e) => {
        if (isDragging) updateSlider(e.clientX);
    });
    
    document.addEventListener('touchmove', (e) => {
        if (isDragging) updateSlider(e.touches[0].clientX);
    });
    
    document.addEventListener('mouseup', () => isDragging = false);
    document.addEventListener('touchend', () => isDragging = false);
    
    slider.addEventListener('click', (e) => updateSlider(e.clientX));
}

function loadContributions(photoId) {
    const contributionsKey = 'pk_contributions_' + photoId;
    const saved = localStorage.getItem(contributionsKey);
    return saved ? JSON.parse(saved) : [];
}

function saveContribution(photoId, contribution) {
    const contributionsKey = 'pk_contributions_' + photoId;
    const contributions = loadContributions(photoId);
    contributions.push(contribution);
    localStorage.setItem(contributionsKey, JSON.stringify(contributions));
}

function renderContributions(photoId) {
    const container = document.getElementById('storyContributions');
    if (!container) return;
    
    const contributions = loadContributions(photoId);
    
    if (contributions.length === 0) {
        container.innerHTML = '<div style="color:#999;font-style:italic;padding:1rem;text-align:center">Nenhuma contribui√ß√£o ainda. Seja o primeiro a adicionar!</div>';
        return;
    }
    
    container.innerHTML = '';
    contributions.forEach(contrib => {
        const div = document.createElement('div');
        div.className = 'contribution-item';
        div.innerHTML = `
            <div class="contribution-author">
                üë§ ${contrib.author}
                <span class="contribution-date">${contrib.date}</span>
            </div>
            <div class="contribution-text">${contrib.text}</div>
        `;
        container.appendChild(div);
    });
}

function submitContribution() {
    if (!currentPhotoData) return;
    
    const textarea = document.getElementById('contributionText');
    const text = textarea.value.trim();
    
    if (!text) {
        showToast('‚ö†Ô∏è', 'Campo vazio', 'Digite algo antes de enviar!');
        return;
    }
    
    if (text.length > 500) {
        showToast('‚ö†Ô∏è', 'Texto muito longo', 'M√°ximo 500 caracteres!');
        return;
    }
    
    const userName = AppState.user ? AppState.user.name : 'Aluno';
    const now = new Date();
    const dateStr = now.toLocaleDateString('pt-BR') + ' √†s ' + now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    
    const contribution = {
        author: userName,
        text: text,
        date: dateStr,
        timestamp: now.getTime()
    };
    
    saveContribution(currentPhotoData.id, contribution);
    
    // Clear textarea
    textarea.value = '';
    document.getElementById('contributionCounter').textContent = '0/500 caracteres';
    
    // Show success message
    const successMsg = document.createElement('div');
    successMsg.className = 'contribution-success';
    successMsg.textContent = '‚úÖ Sua contribui√ß√£o foi aceita!';
    document.body.appendChild(successMsg);
    setTimeout(() => successMsg.remove(), 3000);
    
    // Reload contributions
    renderContributions(currentPhotoData.id);
    
    // Add XP
    if (AppState.user) {
        AppState.user.xp = (AppState.user.xp || 0) + 30;
        Auth.setCurrent(AppState.user);
        const topbarXP = document.getElementById('topbarXP');
        if (topbarXP) topbarXP.textContent = `‚≠ê ${AppState.user.xp} XP`;
    }
    
    showToast('üéâ', '+30 XP', 'Obrigado pela contribui√ß√£o!');
}

// Character counter for contribution textarea
document.addEventListener('DOMContentLoaded', function() {
    const checkTextarea = setInterval(() => {
        const textarea = document.getElementById('contributionText');
        if (textarea) {
            textarea.addEventListener('input', function() {
                const counter = document.getElementById('contributionCounter');
                const length = this.value.length;
                counter.textContent = length + '/500 caracteres';
                if (length > 500) {
                    counter.style.color = '#e74c3c';
                } else {
                    counter.style.color = '';
                }
            });
            clearInterval(checkTextarea);
        }
    }, 100);
});

function setupQuiz(photo) {
    // Simple quiz example - can be enhanced
    const questions = [
        {
            question: `Em que ano foi registrada esta foto de ${photo.title}?`,
            options: [
                String(photo.year),
                String(photo.year - 10),
                String(photo.year + 10),
                String(photo.year + 20)
            ],
            correct: 0
        }
    ];
    
    const quiz = questions[0];
    
    document.getElementById('quizQuestion').textContent = quiz.question;
    
    const optionsContainer = document.getElementById('quizOptions');
    optionsContainer.innerHTML = '';
    
    quiz.options.forEach((option, index) => {
        const btn = document.createElement('div');
        btn.className = 'quiz-option';
        btn.textContent = option;
        btn.onclick = () => checkQuizAnswer(index, quiz.correct);
        optionsContainer.appendChild(btn);
    });
    
    document.getElementById('quizFeedback').style.display = 'none';
}

function checkQuizAnswer(selected, correct) {
    const options = document.querySelectorAll('.quiz-option');
    const feedback = document.getElementById('quizFeedback');
    
    options.forEach((opt, idx) => {
        opt.onclick = null;
        if (idx === correct) {
            opt.classList.add('correct');
        } else if (idx === selected && idx !== correct) {
            opt.classList.add('wrong');
        }
    });
    
    if (selected === correct) {
        feedback.className = 'quiz-feedback correct';
        feedback.textContent = '‚úÖ Correto! +20 XP';
        
        if (AppState.user) {
            AppState.user.xp = (AppState.user.xp || 0) + 20;
            Auth.setCurrent(AppState.user);
            const topbarXP = document.getElementById('topbarXP');
            if (topbarXP) topbarXP.textContent = `‚≠ê ${AppState.user.xp} XP`;
        }
    } else {
        feedback.className = 'quiz-feedback wrong';
        feedback.textContent = '‚ùå Ops! A resposta correta √©: ' + options[correct].textContent;
    }
    
    feedback.style.display = 'block';
}

function navigateTo(screen) {
    const currentScreen = AppState.currentScreen;
    
    // Add to history if not going back
    if (currentScreen && currentScreen !== screen) {
        navigationHistory.push(currentScreen);
    }
    
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    document.getElementById('screen-' + screen)?.classList.add('active');
    document.getElementById('nav-' + screen)?.classList.add('active');

    AppState.currentScreen = screen;
    
    // Render progress content based on user role when navigating to missions
    if (screen === 'missions') {
        // Panel is already in HTML (studentProgress for students)
        // showApp() already handles visibility based on role
        // No need to render anything here
    }
    
    // Update profile display when navigating to profile
    if (screen === 'profile') {
        updateProfileDisplay();
    }
    
    // Render memories grid when navigating to memories
    if (screen === 'memories') {
        renderPhotoGrid();
    }
    
    // Render geography grid when navigating to geography
    if (screen === 'geography') {
        renderGeoGrid();
    }
    
    // Render teacher panel when navigating to teacher
    if (screen === 'teacher') {
        loadTeacherData();
    }
    
    // Show/hide back button
    const backBtn = document.getElementById('topbarBack');
    const logo = document.getElementById('topbarLogo');
    if (screen === 'home') {
        backBtn.style.display = 'none';
        logo.style.display = 'block';
        navigationHistory = []; // Clear history when home
    } else {
        backBtn.style.display = 'flex';
        logo.style.display = 'none';
    }

    if (screen === 'map') {
        if (!AppState.map) {
            setTimeout(() => initMap(), 100);
        } else {
            setTimeout(() => AppState.map.resize(), 50);
        }
    }
}

function goBack() {
    if (navigationHistory.length > 0) {
        const previousScreen = navigationHistory.pop();
        navigateToWithoutHistory(previousScreen);
    } else {
        navigateToWithoutHistory('home');
    }
}

function navigateToWithoutHistory(screen) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    document.getElementById('screen-' + screen)?.classList.add('active');
    document.getElementById('nav-' + screen)?.classList.add('active');

    AppState.currentScreen = screen;
    
    // Update back button visibility
    const backBtn = document.getElementById('topbarBack');
    const logo = document.getElementById('topbarLogo');
    if (screen === 'home') {
        backBtn.style.display = 'none';
        logo.style.display = 'block';
    } else {
        backBtn.style.display = 'flex';
        logo.style.display = 'none';
    }
    
    if (screen === 'map' && AppState.map) {
        setTimeout(() => AppState.map.resize(), 50);
    }
}

// =================================================================
// MAP
// =================================================================
// Map layer styles
const MAP_LAYERS = {
    streets: {
        version: 8,
        sources: { 
            osm: { 
                type: 'raster', 
                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], 
                tileSize: 256,
                minzoom: 0,
                maxzoom: 19,
                attribution: '¬© OpenStreetMap'
            } 
        },
        layers: [{ id: 'osm', type: 'raster', source: 'osm', minzoom: 0, maxzoom: 22 }]
    },
    topo: {
        version: 8,
        sources: {
            topo: {
                type: 'raster',
                tiles: ['https://a.tile.opentopomap.org/{z}/{x}/{y}.png'],
                tileSize: 256,
                minzoom: 0,
                maxzoom: 17,
                attribution: '¬© OpenTopoMap'
            }
        },
        layers: [{ id: 'topo', type: 'raster', source: 'topo', minzoom: 0, maxzoom: 22 }]
    },
    satellite: {
        version: 8,
        sources: {
            satellite: {
                type: 'raster',
                tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                tileSize: 256,
                minzoom: 0,
                maxzoom: 19,
                attribution: '¬© Esri'
            }
        },
        layers: [{ id: 'satellite', type: 'raster', source: 'satellite', minzoom: 0, maxzoom: 22 }]
    }
};

let currentLayer = 'streets';

function initMap() {
    if (AppState.map) return;

    AppState.map = new maplibregl.Map({
        container: 'map',
        style: MAP_LAYERS.streets,
        center: [-44.493456, -5.291234],
        zoom: 14,
        minZoom: 3,
        maxZoom: 22,
        pitch: 0,
        bearing: 0
    });

    AppState.map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
    
    // Enhanced GPS with tracking and rotation
    const geolocate = new maplibregl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true,
            timeout: 6000
        },
        trackUserLocation: true,
        showUserHeading: true,
        showAccuracyCircle: true
    });
    
    AppState.map.addControl(geolocate, 'bottom-right');
    
    // Auto-activate GPS on map load
    AppState.map.on('load', () => {
        geolocate.trigger();
    });

    // Track user orientation on mobile
    if (window.DeviceOrientationEvent && 'ontouchstart' in window) {
        window.addEventListener('deviceorientation', (e) => {
            if (e.alpha !== null && AppState.map) {
                AppState.map.setBearing(-e.alpha);
            }
        });
    }

    const samplePoints = [
        { name: 'Igreja Matriz', lat: -5.291234, lng: -44.493456, status: 'approved', category: 'igreja' },
        { name: 'Pra√ßa Central', lat: -5.292000, lng: -44.494000, status: 'approved', category: 'praca' },
        { name: 'Esta√ß√£o Ferrovi√°ria', lat: -5.290000, lng: -44.495000, status: 'pending', category: 'patrimonio' },
        { name: 'Mercado Municipal', lat: -5.293000, lng: -44.492000, status: 'approved', category: 'comercio' },
        { name: 'Casa da Cultura', lat: -5.291800, lng: -44.492800, status: 'pending', category: 'patrimonio' }
    ];

    samplePoints.forEach(p => addMapMarker(p));
}

function toggleLayerPanel() {
    const panel = document.getElementById('layerPanel');
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
}

function changeMapLayer(layerType, element) {
    if (layerType === currentLayer) return;
    
    // Update radio buttons
    document.querySelectorAll('.layer-option input[type="radio"]').forEach(r => r.checked = false);
    element.querySelector('input[type="radio"]').checked = true;
    
    // Save current view
    const center = AppState.map.getCenter();
    const zoom = AppState.map.getZoom();
    const bearing = AppState.map.getBearing();
    const pitch = AppState.map.getPitch();
    
    // Save markers
    const markers = AppState.markers.slice();
    
    // Change style
    AppState.map.setStyle(MAP_LAYERS[layerType]);
    currentLayer = layerType;
    
    // Restore view and markers after style loads
    AppState.map.once('styledata', () => {
        AppState.map.setCenter(center);
        AppState.map.setZoom(zoom);
        AppState.map.setBearing(bearing);
        AppState.map.setPitch(pitch);
        
        // Re-add markers
        markers.forEach(({ point }) => {
            // Remove old marker
            const oldMarker = AppState.markers.find(m => m.point.name === point.name);
            if (oldMarker) {
                oldMarker.marker.remove();
            }
        });
        
        // Clear markers array
        AppState.markers = [];
        
        // Re-add all markers
        const samplePoints = [
            { name: 'Igreja Matriz', lat: -5.291234, lng: -44.493456, status: 'approved', category: 'igreja' },
            { name: 'Pra√ßa Central', lat: -5.292000, lng: -44.494000, status: 'approved', category: 'praca' },
            { name: 'Esta√ß√£o Ferrovi√°ria', lat: -5.290000, lng: -44.495000, status: 'pending', category: 'patrimonio' },
            { name: 'Mercado Municipal', lat: -5.293000, lng: -44.492000, status: 'approved', category: 'comercio' },
            { name: 'Casa da Cultura', lat: -5.291800, lng: -44.492800, status: 'pending', category: 'patrimonio' }
        ];
        samplePoints.forEach(p => addMapMarker(p));
    });
    
    showToast('üó∫Ô∏è', 'Camada alterada', `Visualizando: ${layerType === 'streets' ? 'Mapa de Ruas' : layerType === 'topo' ? 'Topogr√°fico' : 'Sat√©lite'}`);
    toggleLayerPanel();
}

function addMapMarker(point) {
    const colors = { approved: '#10B981', pending: '#FF8C00', rejected: '#8B1A1A' };
    const icons = { 
        igreja: '‚õ™', 
        praca: 'üå≥', 
        patrimonio: 'üèõÔ∏è', 
        comercio: 'üè™', 
        escola: 'üè´',
        residencia: 'üè†',
        'marco-geo': 'üóª',
        'curiosidade': 'üí°'
    };
    
    // Create custom marker element with icon
    const el = document.createElement('div');
    el.style.cssText = `
        width:36px;
        height:36px;
        border-radius:50%;
        background:${colors[point.status] || '#FF8C00'};
        border:3px solid white;
        box-shadow:0 3px 12px rgba(0,0,0,0.4);
        cursor:pointer;
        transition:all 0.3s;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:18px;
        animation:markerPulse 2s infinite;
    `;
    el.innerHTML = icons[point.category] || 'üìç';
    
    el.onmouseenter = () => {
        el.style.transform = 'scale(1.4)';
        el.style.boxShadow = '0 6px 20px rgba(0,0,0,0.5)';
    };
    el.onmouseleave = () => {
        el.style.transform = 'scale(1)';
        el.style.boxShadow = '0 3px 12px rgba(0,0,0,0.4)';
    };
    
    // Add pulse animation style if not exists
    if (!document.getElementById('markerPulseStyle')) {
        const style = document.createElement('style');
        style.id = 'markerPulseStyle';
        style.textContent = `
            @keyframes markerPulse {
                0%, 100% { box-shadow: 0 3px 12px rgba(0,0,0,0.4); }
                50% { box-shadow: 0 3px 20px rgba(196,163,90,0.6); }
            }
        `;
        document.head.appendChild(style);
    }

    const statusLabel = { approved: '‚úÖ Aprovado', pending: '‚è≥ Pendente', rejected: '‚ùå Rejeitado' };
    
    // Click handler to open detail
    el.onclick = () => {
        // Find point ID from POINT_DETAILS
        const pointId = Object.keys(POINT_DETAILS).find(id => 
            POINT_DETAILS[id].title === point.name || 
            POINT_DETAILS[id].lat === point.lat
        );
        if (pointId) {
            openPointDetail(parseInt(pointId));
        } else {
            showToast('üìç', point.name, statusLabel[point.status]);
        }
    };

    const marker = new maplibregl.Marker({ element: el })
        .setLngLat([point.lng, point.lat])
        .setPopup(new maplibregl.Popup({ offset: 20, closeButton: false }).setHTML(`
            <div style="font-family:'Crimson Text',serif;padding:0.5rem;">
                <strong style="color:#2D5A3D;font-size:0.95rem;">${point.name}</strong><br>
                <span style="font-size:0.8rem;color:#6B7280;">${statusLabel[point.status]}</span><br>
                <span style="font-size:0.75rem;color:#C4A35A;margin-top:0.25rem;display:block;">üëÜ Clique para ver detalhes</span>
            </div>
        `))
        .addTo(AppState.map);

    AppState.markers.push({ marker, point });
}

function filterMap(filter, el) {
    document.querySelectorAll('.map-filter-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    AppState.markers.forEach(({ marker, point }) => {
        const visible = filter === 'all' || point.status === filter || point.category === filter;
        marker.getElement().style.display = visible ? 'block' : 'none';
    });
}

function searchMap(query) {
    const searchBtn = document.getElementById('clearSearch');
    if (query.trim().length > 0) {
        searchBtn.style.display = 'flex';
    } else {
        searchBtn.style.display = 'none';
        // Show all markers
        AppState.markers.forEach(({ marker }) => {
            marker.getElement().style.display = 'block';
        });
        return;
    }
    
    const lowerQuery = query.toLowerCase().trim();
    let foundAny = false;
    
    AppState.markers.forEach(({ marker, point }) => {
        const matches = 
            point.name.toLowerCase().includes(lowerQuery) ||
            point.category?.toLowerCase().includes(lowerQuery) ||
            point.status?.toLowerCase().includes(lowerQuery);
        
        marker.getElement().style.display = matches ? 'block' : 'none';
        
        if (matches && !foundAny) {
            foundAny = true;
            // Center on first match
            AppState.map.flyTo({
                center: [point.lng, point.lat],
                zoom: 16,
                duration: 1000
            });
        }
    });
    
    if (!foundAny) {
        showToast('üîç', 'Nenhum ponto encontrado', `Nenhum resultado para "${query}"`);
    }
}

function clearMapSearch() {
    document.getElementById('mapSearch').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    AppState.markers.forEach(({ marker }) => {
        marker.getElement().style.display = 'block';
    });
    showToast('‚úì', 'Busca limpa', 'Mostrando todos os pontos');
}

// =================================================================
// REGISTER WIZARD
// =================================================================
function openRegisterModal() {
    AppState.wizardStep = 0;
    AppState.mainPhoto = null;
    AppState.beforePhoto = null;
    document.getElementById('pointName').value = '';
    document.getElementById('pointCategory').value = '';
    document.getElementById('pointDesc').value = '';
    document.getElementById('charCount').textContent = '0';
    document.getElementById('termsCheck').checked = false;
    document.getElementById('duplicateWarning').innerHTML = '';
    updateWizardUI();
    getLocation();
    document.getElementById('registerModal').classList.add('active');
}

function closeRegisterModal() {
    document.getElementById('registerModal').classList.remove('active');
}

function wizardNext() {
    if (!validateWizardStep()) return;
    if (AppState.wizardStep < 2) {
        AppState.wizardStep++;
        updateWizardUI();
    } else {
        submitPoint();
    }
}

function wizardPrev() {
    if (AppState.wizardStep > 0) {
        AppState.wizardStep--;
        updateWizardUI();
    }
}

function updateWizardUI() {
    const step = AppState.wizardStep;
    document.querySelectorAll('.wizard-page').forEach((p, i) => p.classList.toggle('active', i === step));
    document.querySelectorAll('.wizard-step').forEach((s, i) => {
        s.className = 'wizard-step' + (i === step ? ' active' : i < step ? ' done' : '');
    });
    document.getElementById('wizardBackBtn').style.display = step > 0 ? 'block' : 'none';
    document.getElementById('wizardNextBtn').textContent = step === 2 ? '‚úì Enviar' : 'Pr√≥ximo ‚Üí';
}

function validateWizardStep() {
    const step = AppState.wizardStep;
    if (step === 0) {
        if (!document.getElementById('pointName').value.trim()) { showToast('‚ö†Ô∏è', 'Campo obrigat√≥rio', 'Digite o nome do local'); return false; }
        if (!document.getElementById('pointCategory').value) { showToast('‚ö†Ô∏è', 'Campo obrigat√≥rio', 'Selecione uma categoria'); return false; }
        if (document.getElementById('pointDesc').value.length < 100) { showToast('‚ö†Ô∏è', 'Descri√ß√£o curta', 'Escreva pelo menos 100 caracteres'); return false; }
    }
    if (step === 1) {
        if (!AppState.mainPhoto) { showToast('üì∑', 'Foto necess√°ria', 'Tire ou selecione uma foto do local'); return false; }
    }
    if (step === 2) {
        if (!document.getElementById('termsCheck').checked) { showToast('‚ö†Ô∏è', 'Aceite os termos', 'Confirme as declara√ß√µes para prosseguir'); return false; }
    }
    return true;
}

async function submitPoint() {
    const point = {
        id: Date.now().toString(),
        name: document.getElementById('pointName').value.trim(),
        category: document.getElementById('pointCategory').value,
        description: document.getElementById('pointDesc').value.trim(),
        era: document.getElementById('pointEra').value,
        sources: document.getElementById('pointSources').value.trim(),
        interviewee: document.getElementById('pointInterviewee').value.trim(),
        lat: AppState.location?.lat || -5.291234,
        lng: AppState.location?.lng || -44.493456,
        authorId: AppState.user?.id,
        turma: AppState.user?.turma,
        status: 'pending',
        createdAt: new Date().toISOString()
    };

    // Save to IndexedDB
    await savePointToDB(point);

    // Add to map
    addMapMarker({ ...point, name: point.name });

    // Award XP
    if (AppState.user) {
        AppState.user.xp = (AppState.user.xp || 0) + 75;
        AppState.user.points = (AppState.user.points || 0) + 1;
        Auth.setCurrent(AppState.user);
        document.getElementById('topbarXP').textContent = `‚≠ê ${AppState.user.xp} XP`;
    }

    closeRegisterModal();
    showToast('üéâ', 'Ponto cadastrado!', `"${point.name}" enviado para aprova√ß√£o. +75 XP!`);
    navigateTo('map');
}

// =================================================================
// INDEXEDDB
// =================================================================
let db = null;

async function getDB() {
    if (db) return db;
    return new Promise((resolve, reject) => {
        const req = indexedDB.open('pk_explorer', 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore('points', { keyPath: 'id' });
        req.onsuccess = e => { db = e.target.result; resolve(db); };
        req.onerror = reject;
    });
}

async function savePointToDB(point) {
    const database = await getDB();
    return new Promise((resolve, reject) => {
        const tx = database.transaction('points', 'readwrite');
        tx.objectStore('points').put(point);
        tx.oncomplete = resolve;
        tx.onerror = reject;
    });
}

// =================================================================
// LOCATION
// =================================================================
function getLocation() {
    if (!navigator.geolocation) {
        document.getElementById('locationAddress').textContent = 'GPS n√£o dispon√≠vel';
        return;
    }
    document.getElementById('locationAddress').textContent = 'Obtendo localiza√ß√£o...';
    navigator.geolocation.getCurrentPosition(pos => {
        AppState.location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        document.getElementById('locationCoords').textContent = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
        document.getElementById('locationAddress').textContent = '‚úÖ Localiza√ß√£o obtida';
    }, () => {
        document.getElementById('locationAddress').textContent = '‚ö†Ô∏è GPS negado ‚Äî usando localiza√ß√£o padr√£o';
    });
}

function refreshLocation() { getLocation(); }

function updateCharCount() {
    const len = document.getElementById('pointDesc').value.length;
    const el = document.getElementById('charCount');
    el.textContent = len;
    el.style.color = len >= 100 ? 'var(--green)' : 'var(--gray)';
}

// =================================================================
// MEDIA UPLOAD
// =================================================================
async function handlePhoto(input, type) {
    const file = input.files[0];
    if (!file) return;

    const wrapId = type === 'main' ? 'mainPhotoPreviewWrap' : 'beforePhotoPreviewWrap';
    const uploadId = type === 'main' ? 'mainPhotoUpload' : null;

    try {
        const options = { maxSizeMB: 1, maxWidthOrHeight: 1920, useWebWorker: true };
        const compressed = await imageCompression(file, options);
        const url = URL.createObjectURL(compressed);
        if (type === 'main') AppState.mainPhoto = compressed;
        else AppState.beforePhoto = compressed;

        // Enhanced preview with remove button
        document.getElementById(wrapId).innerHTML = `
            <div style="position:relative;">
                <img src="${url}" class="media-preview">
                <button onclick="removePhoto('${type}')" style="position:absolute;top:8px;right:8px;width:32px;height:32px;border-radius:50%;background:var(--red);color:white;border:2px solid white;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.3);">√ó</button>
                <div style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.7);color:white;padding:0.35rem 0.75rem;border-radius:12px;font-size:0.75rem;backdrop-filter:blur(4px);">
                    ‚úÖ ${(compressed.size/1024).toFixed(0)}KB
                </div>
            </div>
        `;
        if (uploadId) document.getElementById(uploadId).classList.add('has-file');
        showToast('‚úÖ', 'Foto carregada!', `Comprimida de ${(file.size/1024).toFixed(0)}KB para ${(compressed.size/1024).toFixed(0)}KB`);
    } catch (e) {
        showToast('‚ùå', 'Erro', 'N√£o foi poss√≠vel processar a foto');
    }
}

function removePhoto(type) {
    const wrapId = type === 'main' ? 'mainPhotoPreviewWrap' : 'beforePhotoPreviewWrap';
    const uploadId = type === 'main' ? 'mainPhotoUpload' : null;
    const inputId = type === 'main' ? 'mainPhotoInput' : 'beforePhotoInput';
    
    if (type === 'main') AppState.mainPhoto = null;
    else AppState.beforePhoto = null;
    
    document.getElementById(wrapId).innerHTML = type === 'main' 
        ? '<div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∑</div><div style="font-weight: 600; color: var(--primary);">Tirar foto ou escolher arquivo</div><div style="font-size: 0.8rem; color: var(--gray);">JPEG, PNG ‚Äî m√°x. 10MB</div>'
        : '<div style="font-size: 1.5rem; margin-bottom: 0.35rem;">üñºÔ∏è</div><div style="font-size: 0.875rem; color: var(--gray);">Foto de como era antes (digitalizada)</div>';
    
    if (uploadId) document.getElementById(uploadId).classList.remove('has-file');
    document.getElementById(inputId).value = '';
    
    showToast('üóëÔ∏è', 'Foto removida', 'Escolha outra foto se desejar');
}

function handleAudio(input) {
    const file = input.files[0];
    if (!file) return;
    document.getElementById('audioLabel').textContent = `‚úÖ ${file.name}`;
    showToast('üéôÔ∏è', '√Åudio adicionado!', file.name);
}

// =================================================================
// MISSIONS RENDER
// =================================================================
function renderMissions() {
    const missions = [
        { 
            icon: '‚ö°', 
            name: 'Explorador Di√°rio', 
            description: 'Cadastre 1 ponto hist√≥rico hoje',
            type: 'Di√°ria', 
            xp: 50, 
            progress: 0, 
            total: 1, 
            tag: 'daily' 
        },
        { 
            icon: 'üì∏', 
            name: 'Primeiro Registro', 
            description: 'Cadastre seu primeiro ponto no mapa',
            type: 'Explora√ß√£o', 
            xp: 100, 
            progress: 1, 
            total: 1, 
            tag: 'main', 
            done: true 
        },
        { 
            icon: 'üéôÔ∏è', 
            name: 'Mem√≥rias Vivas', 
            description: 'Grave entrevistas com 3 moradores antigos',
            type: 'Entrevista', 
            xp: 200, 
            progress: 1, 
            total: 3, 
            tag: 'main' 
        },
        { 
            icon: 'üó∫Ô∏è', 
            name: 'Explorador da Semana', 
            description: 'Cadastre 5 pontos diferentes esta semana',
            type: 'Semanal', 
            xp: 300, 
            progress: 2, 
            total: 5, 
            tag: 'weekly' 
        }
    ];

    document.getElementById('missionsContent').innerHTML = missions.map(m => {
        const pct = Math.round((m.progress / m.total) * 100);
        const tagColors = { daily: 'var(--orange)', weekly: 'var(--blue)', main: 'var(--primary)' };
        return `
            <div style="background:var(--white);border:2px solid var(--gold);border-radius:12px;padding:1.25rem;margin-bottom:0.75rem;${m.done ? 'opacity:0.6;' : ''}">
                <div style="display:flex;gap:1rem;align-items:flex-start;margin-bottom:0.75rem;">
                    <div style="font-size:2rem;">${m.icon}</div>
                    <div style="flex:1;">
                        <div style="font-weight:700;color:var(--primary);font-size:1.05rem;margin-bottom:0.25rem;">${m.name}</div>
                        <div style="font-size:0.9rem;color:var(--gray);margin-bottom:0.5rem;">${m.description}</div>
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                            <span style="background:${tagColors[m.tag]}20;color:${tagColors[m.tag]};padding:0.25rem 0.7rem;border-radius:10px;font-size:0.75rem;font-weight:700;">${m.tag === 'daily' ? '‚ö° Di√°ria' : m.tag === 'weekly' ? 'üìÖ Semanal' : 'üéØ Principal'}</span>
                            <span style="background:rgba(196,163,90,0.2);color:var(--gold);padding:0.25rem 0.7rem;border-radius:10px;font-size:0.75rem;font-weight:700;">+${m.xp} XP</span>
                        </div>
                    </div>
                </div>
                <div style="height:8px;background:var(--paper-dark);border-radius:4px;overflow:hidden;margin-bottom:0.65rem;">
                    <div style="height:100%;background:linear-gradient(90deg,var(--primary),var(--gold));border-radius:4px;width:${pct}%;transition:width 0.8s;"></div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.85rem;color:var(--gray);font-weight:600;">${m.progress}/${m.total} completo ${m.done ? '‚úÖ' : ''}</span>
                    ${!m.done ? `<button onclick="completeMission('${m.name}', ${m.xp})" style="padding:0.5rem 1.25rem;background:var(--primary);color:white;border:none;border-radius:20px;cursor:pointer;font-family:'Crimson Text',serif;font-size:0.9rem;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='#1d3d28'" onmouseout="this.style.background='var(--primary)'">Come√ßar ‚Üí</button>` : '<span style="color:var(--green);font-size:0.9rem;font-weight:700;">‚úì Conclu√≠da!</span>'}
                </div>
            </div>
        `;
    }).join('');
}

function completeMission(name, xp) {
    if (AppState.user) {
        AppState.user.xp = (AppState.user.xp || 0) + xp;
        Auth.setCurrent(AppState.user);
        document.getElementById('topbarXP').textContent = `‚≠ê ${AppState.user.xp} XP`;
    }
    showToast('üéâ', 'Miss√£o iniciada!', `${name} ‚Äî Boa sorte! +${xp} XP ao completar`);
}

// =================================================================
// FEED RENDER
// =================================================================
// Global feed data
let ALL_FEED_POINTS = [];
let currentFeedFilter = 'all';
let currentCategoryFilter = 'all';

// Pending points database (simulated - would be from Supabase in production)
let PENDING_POINTS = [
    { id: 'p1', name: 'Casa Antiga da Dona Maria', author: 'Pedro Santos', turma: '7¬∫B', category: 'üè† Resid√™ncia', img: 'https://images.unsplash.com/photo-1518780664697-55e3ad937233?w=400&h=220&fit=crop', description: 'Casa centen√°ria com arquitetura colonial preservada.', date: 'H√° 2 dias', lat: -5.291500, lng: -44.493800 },
    { id: 'p2', name: 'Fonte do Centro', author: 'Ana Clara', turma: '6¬∫A', category: 'üí° Curiosidade', img: 'https://images.unsplash.com/photo-1547036967-23d11aacaee0?w=400&h=220&fit=crop', description: 'Fonte hist√≥rica que abastecia a popula√ß√£o no in√≠cio do s√©culo XX.', date: 'Ontem', lat: -5.292200, lng: -44.494200 },
    { id: 'p3', name: 'Capela S√£o Jos√©', author: 'Lucas Oliveira', turma: '8¬∫A', category: '‚õ™ Igreja', img: 'https://images.unsplash.com/photo-1519491050282-cf00c82424b4?w=400&h=220&fit=crop', description: 'Capela constru√≠da em 1955 pelos moradores do bairro.', date: 'H√° 3 dias', lat: -5.290500, lng: -44.495500 }
];

function getPendingPointsCount() {
    return PENDING_POINTS.length;
}

function renderStudentProgress() {
    document.getElementById('progressContainer').innerHTML = `
        <div class="screen-header">
            <span style="font-size:1.5rem">üìä</span>
            <div class="screen-title">Meu Progresso</div>
        </div>

        <!-- Meu Trabalho -->
        <div class="card">
            <div class="card-title" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
                <span>üìù</span>
                <span>Meu Trabalho</span>
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:1rem;">
                <div style="background:var(--paper-dark);border-radius:12px;padding:1rem;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:var(--primary);font-family:'Playfair Display',serif;">7</div>
                    <div style="font-size:0.8rem;color:var(--gray);">Pontos Cadastrados</div>
                </div>
                <div style="background:rgba(16,185,129,0.1);border-radius:12px;padding:1rem;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:var(--green);font-family:'Playfair Display',serif;">5</div>
                    <div style="font-size:0.8rem;color:var(--gray);">‚úÖ Aprovados</div>
                </div>
                <div style="background:rgba(255,140,0,0.1);border-radius:12px;padding:1rem;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:var(--orange);font-family:'Playfair Display',serif;">2</div>
                    <div style="font-size:0.8rem;color:var(--gray);">‚è≥ Em An√°lise</div>
                </div>
                <div style="background:rgba(196,163,90,0.1);border-radius:12px;padding:1rem;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:var(--gold);font-family:'Playfair Display',serif;">12</div>
                    <div style="font-size:0.8rem;color:var(--gray);">üì∑ Fotos Enviadas</div>
                </div>
            </div>
            
            <div style="display:flex;gap:0.75rem;font-size:0.9rem;">
                <div style="flex:1;background:var(--paper-dark);padding:0.75rem;border-radius:10px;text-align:center;">
                    üéôÔ∏è <strong>1</strong> entrevista
                </div>
                <div style="flex:1;background:var(--paper-dark);padding:0.75rem;border-radius:10px;text-align:center;">
                    üó∫Ô∏è <strong>5</strong> locais visitados
                </div>
            </div>
        </div>

        <!-- Nossa Turma -->
        <div class="card" style="background:linear-gradient(135deg,rgba(45,90,61,0.05),rgba(196,163,90,0.05));">
            <div class="card-title" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
                <span>üë•</span>
                <span>Nossa Turma (6¬∫A)</span>
            </div>
            
            <div style="background:var(--white);border-radius:12px;padding:1.25rem;margin-bottom:1rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
                    <div>
                        <div style="font-size:0.85rem;color:var(--gray);margin-bottom:0.25rem;">Total de pontos</div>
                        <div style="font-size:1.75rem;font-weight:700;color:var(--primary);font-family:'Playfair Display',serif;">47</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.85rem;color:var(--gray);margin-bottom:0.25rem;">Ranking</div>
                        <div style="font-size:1.75rem;font-weight:700;color:var(--gold);font-family:'Playfair Display',serif;">ü•à 2¬∫</div>
                    </div>
                </div>
                
                <div style="font-size:0.85rem;color:var(--gray);margin-bottom:0.5rem;">Meta da semana: 50 pontos</div>
                <div style="height:10px;background:var(--paper-dark);border-radius:5px;overflow:hidden;">
                    <div style="height:100%;width:94%;background:linear-gradient(90deg,var(--primary),var(--gold));border-radius:5px;transition:width 0.8s;"></div>
                </div>
                <div style="text-align:right;font-size:0.8rem;color:var(--primary);font-weight:600;margin-top:0.35rem;">94% ‚Äî Faltam 3 pontos!</div>
            </div>
            
            <div style="display:flex;gap:0.75rem;">
                <div style="flex:1;background:var(--white);padding:0.875rem;border-radius:10px;text-align:center;">
                    <div style="font-weight:700;color:var(--primary);margin-bottom:0.25rem;">25</div>
                    <div style="font-size:0.75rem;color:var(--gray);">Alunos ativos</div>
                </div>
                <div style="flex:1;background:var(--white);padding:0.875rem;border-radius:10px;text-align:center;">
                    <div style="font-weight:700;color:var(--primary);margin-bottom:0.25rem;">8</div>
                    <div style="font-size:0.75rem;color:var(--gray);">Sa√≠das de campo</div>
                </div>
            </div>
        </div>

        <!-- Toda a Escola -->
        <div class="card">
            <div class="card-title" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
                <span>üè´</span>
                <span>Toda a Escola</span>
            </div>
            
            <div style="background:linear-gradient(135deg,var(--primary),rgba(45,90,61,0.8));border-radius:12px;padding:1.5rem;color:var(--white);margin-bottom:1rem;">
                <div style="font-size:0.9rem;opacity:0.9;margin-bottom:0.5rem;">üéØ Meta do M√™s</div>
                <div style="font-size:1.75rem;font-weight:700;font-family:'Playfair Display',serif;margin-bottom:1rem;">Mapear 100 Pontos Hist√≥ricos</div>
                
                <div style="height:12px;background:rgba(255,255,255,0.2);border-radius:6px;overflow:hidden;margin-bottom:0.75rem;">
                    <div style="height:100%;width:78%;background:var(--gold);border-radius:6px;transition:width 0.8s;"></div>
                </div>
                
                <div style="display:flex;justify-content:space-between;font-size:0.9rem;">
                    <span><strong>78</strong> pontos cadastrados</span>
                    <span><strong>22</strong> pontos faltando</span>
                </div>
            </div>
            
            <div style="font-size:0.85rem;color:var(--gray);margin-bottom:0.75rem;font-weight:600;">üèÜ Destaques desta semana:</div>
            
            <div style="display:flex;flex-direction:column;gap:0.65rem;">
                <div style="background:var(--paper-dark);padding:0.875rem 1rem;border-radius:10px;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.9rem;">üë§ <strong>Jo√£o Silva</strong> (7¬∫B)</span>
                    <span style="font-size:0.85rem;color:var(--primary);font-weight:600;">8 pontos</span>
                </div>
                <div style="background:rgba(16,185,129,0.1);padding:0.875rem 1rem;border-radius:10px;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.9rem;">ü•á <strong>Turma 6¬∫B</strong></span>
                    <span style="font-size:0.85rem;color:var(--green);font-weight:600;">1¬∫ lugar (52 pontos)</span>
                </div>
                <div style="background:rgba(196,163,90,0.1);padding:0.875rem 1rem;border-radius:10px;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.9rem;">üéôÔ∏è <strong>Melhor entrevista</strong></span>
                    <span style="font-size:0.85rem;color:var(--gold);font-weight:600;">Maria (6¬∫A)</span>
                </div>
            </div>
        </div>

        <!-- Pr√≥ximos Eventos -->
        <div class="card" style="background:rgba(196,163,90,0.05);border-color:var(--gold);">
            <div class="card-title" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
                <span>üìÖ</span>
                <span>Pr√≥ximos Eventos</span>
            </div>
            
            <div style="display:flex;flex-direction:column;gap:0.75rem;">
                <div style="display:flex;gap:1rem;background:var(--white);padding:1rem;border-radius:10px;border-left:4px solid var(--primary);">
                    <div style="text-align:center;min-width:50px;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--primary);font-family:'Playfair Display',serif;">22</div>
                        <div style="font-size:0.7rem;color:var(--gray);text-transform:uppercase;">Fev</div>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;color:var(--primary);margin-bottom:0.25rem;">Sa√≠da de Campo ‚Äî Centro Hist√≥rico</div>
                        <div style="font-size:0.85rem;color:var(--gray);">Sexta-feira ‚Ä¢ 14h √†s 16h</div>
                    </div>
                </div>
                
                <div style="display:flex;gap:1rem;background:var(--white);padding:1rem;border-radius:10px;border-left:4px solid var(--gold);">
                    <div style="text-align:center;min-width:50px;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--gold);font-family:'Playfair Display',serif;">25</div>
                        <div style="font-size:0.7rem;color:var(--gray);text-transform:uppercase;">Fev</div>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;color:var(--primary);margin-bottom:0.25rem;">Exposi√ß√£o: Fotos Antigas da Cidade</div>
                        <div style="font-size:0.85rem;color:var(--gray);">Segunda-feira ‚Ä¢ Biblioteca da escola</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderTeacherPanel() {
    const pendingCount = PENDING_POINTS.length;
    
    document.getElementById('missionsContent').innerHTML = `
        <div class="card" style="background:linear-gradient(135deg,rgba(45,90,61,0.05),rgba(196,163,90,0.05));">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;">
                <div>
                    <div style="font-size:1.5rem;font-weight:700;font-family:'Playfair Display',serif;color:var(--primary);">Painel do Professor</div>
                    <div style="font-size:0.9rem;color:var(--gray);margin-top:0.25rem;">Gerencie os pontos cadastrados pelos alunos</div>
                </div>
                <div style="background:${pendingCount > 0 ? 'var(--orange)' : 'var(--green)'};color:white;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.2);">
                    ${pendingCount}
                </div>
            </div>
            
            ${pendingCount > 0 ? `
                <div style="background:rgba(255,140,0,0.1);border:2px solid var(--orange);border-radius:12px;padding:1rem;margin-bottom:1rem;">
                    <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                        <span style="font-size:1.25rem;">‚è≥</span>
                        <span style="font-weight:700;color:var(--orange);">${pendingCount} ${pendingCount === 1 ? 'ponto aguardando' : 'pontos aguardando'} sua aprova√ß√£o</span>
                    </div>
                    <div style="font-size:0.85rem;color:var(--gray);">Revise as informa√ß√µes e aprove ou solicite corre√ß√µes</div>
                </div>
            ` : `
                <div style="background:rgba(16,185,129,0.1);border:2px solid var(--green);border-radius:12px;padding:1.5rem;text-align:center;">
                    <div style="font-size:2rem;margin-bottom:0.5rem;">‚úÖ</div>
                    <div style="font-weight:700;color:var(--green);margin-bottom:0.25rem;">Tudo em dia!</div>
                    <div style="font-size:0.85rem;color:var(--gray);">N√£o h√° pontos pendentes no momento</div>
                </div>
            `}
        </div>
        
        ${pendingCount > 0 ? PENDING_POINTS.map(p => `
            <div class="card">
                <div style="display:flex;gap:1rem;margin-bottom:1rem;">
                    <img src="${p.img}" style="width:120px;height:120px;object-fit:cover;border-radius:12px;flex-shrink:0;" alt="${p.name}">
                    <div style="flex:1;">
                        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--primary);margin-bottom:0.35rem;">${p.name}</div>
                        <div style="font-size:0.8rem;color:var(--gray);margin-bottom:0.5rem;">
                            üë§ ${p.author} ¬∑ Turma ${p.turma}<br>
                            üìÖ Cadastrado ${p.date}
                        </div>
                        <span style="background:rgba(45,90,61,0.1);color:var(--primary);padding:0.25rem 0.65rem;border-radius:10px;font-size:0.75rem;font-weight:600;">${p.category}</span>
                    </div>
                </div>
                
                <div style="background:var(--paper-dark);border-radius:10px;padding:0.875rem;margin-bottom:1rem;">
                    <div style="font-weight:600;font-size:0.85rem;color:var(--primary);margin-bottom:0.35rem;">üìñ Descri√ß√£o:</div>
                    <div style="font-size:0.9rem;line-height:1.6;color:var(--ink);">${p.description}</div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem;">
                    <button onclick="viewPointOnMap('${p.id}')" style="padding:0.75rem;background:var(--white);border:2px solid var(--primary);color:var(--primary);border-radius:10px;cursor:pointer;font-weight:600;font-size:0.85rem;font-family:'Crimson Text',serif;transition:all 0.2s;" onmouseover="this.style.background='var(--primary)';this.style.color='white'" onmouseout="this.style.background='var(--white)';this.style.color='var(--primary)'">
                        üó∫Ô∏è Ver
                    </button>
                    <button onclick="rejectPoint('${p.id}', '${p.author}')" style="padding:0.75rem;background:var(--white);border:2px solid var(--red);color:var(--red);border-radius:10px;cursor:pointer;font-weight:600;font-size:0.85rem;font-family:'Crimson Text',serif;transition:all 0.2s;" onmouseover="this.style.background='var(--red)';this.style.color='white'" onmouseout="this.style.background='var(--white)';this.style.color='var(--red)'">
                        ‚ùå Rejeitar
                    </button>
                    <button onclick="approvePoint('${p.id}', '${p.author}')" style="padding:0.75rem;background:var(--green);border:2px solid var(--green);color:white;border-radius:10px;cursor:pointer;font-weight:600;font-size:0.85rem;font-family:'Crimson Text',serif;transition:all 0.2s;box-shadow:0 4px 12px rgba(16,185,129,0.3);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
                        ‚úÖ Aprovar
                    </button>
                </div>
            </div>
        `).join('') : ''}
    `;
}

function viewPointOnMap(pointId) {
    const point = PENDING_POINTS.find(p => p.id === pointId);
    if (!point || !AppState.map) return;
    
    navigateTo('map');
    setTimeout(() => {
        AppState.map.flyTo({
            center: [point.lng, point.lat],
            zoom: 17,
            duration: 2000
        });
        showToast('üó∫Ô∏è', 'Visualizando', `"${point.name}" no mapa`);
    }, 300);
}

function approvePoint(pointId, authorName) {
    if (!confirm(`Aprovar o ponto cadastrado por ${authorName}?`)) return;
    
    // Remove from pending
    PENDING_POINTS = PENDING_POINTS.filter(p => p.id !== pointId);
    
    // Re-render panel
    renderTeacherPanel();
    
    // Save approval notification for student
    saveNotificationForStudent(authorName, 'approved', pointId);
    
    // Confetti celebration! üéâ
    createConfetti();
    
    showToast('‚úÖ', 'Ponto aprovado!', `${authorName} ser√° notificado`);
}

function rejectPoint(pointId, authorName) {
    const reason = prompt(`Por que este ponto est√° sendo rejeitado?\n\nMotivo (ser√° enviado para ${authorName}):`);
    if (!reason || reason.trim() === '') return;
    
    // Remove from pending
    PENDING_POINTS = PENDING_POINTS.filter(p => p.id !== pointId);
    
    // Re-render panel
    renderTeacherPanel();
    
    // Save rejection notification for student
    saveNotificationForStudent(authorName, 'rejected', pointId, reason);
    
    showToast('‚ùå', 'Ponto rejeitado', `${authorName} receber√° o motivo`);
}

function saveNotificationForStudent(studentName, action, pointId, reason = '') {
    // In production, this would save to Supabase
    // For now, simulate by storing in localStorage
    const notifications = JSON.parse(localStorage.getItem('pk_notifications') || '[]');
    notifications.push({
        id: Date.now(),
        studentName,
        action,
        pointId,
        reason,
        timestamp: new Date().toISOString(),
        read: false
    });
    localStorage.setItem('pk_notifications', JSON.stringify(notifications));
    updateNotificationBadge();
}

function updateNotificationBadge() {
    const notifications = JSON.parse(localStorage.getItem('pk_notifications') || '[]');
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notificationBadge');
    const button = document.getElementById('topbarNotification');
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
        button.style.display = 'flex';
    } else {
        badge.style.display = 'none';
        button.style.display = 'none';
    }
}

function openNotifications() {
    navigateTo('notifications');
    renderNotifications();
    
    // Mark all as read
    const notifications = JSON.parse(localStorage.getItem('pk_notifications') || '[]');
    notifications.forEach(n => n.read = true);
    localStorage.setItem('pk_notifications', JSON.stringify(notifications));
    updateNotificationBadge();
}

function renderNotifications() {
    const notifications = JSON.parse(localStorage.getItem('pk_notifications') || '[]')
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    if (notifications.length === 0) {
        document.getElementById('notificationsContent').innerHTML = `
            <div style="text-align:center;padding:4rem 2rem;color:var(--gray);">
                <div style="font-size:4rem;margin-bottom:1rem;">üîï</div>
                <div style="font-weight:700;font-size:1.1rem;margin-bottom:0.5rem;color:var(--ink);">Nenhuma notifica√ß√£o</div>
                <div style="font-size:0.9rem;">Voc√™ ser√° avisado quando seus pontos forem aprovados</div>
            </div>
        `;
        return;
    }
    
    document.getElementById('notificationsContent').innerHTML = notifications.map(n => {
        const timeAgo = getTimeAgo(n.timestamp);
        const isApproved = n.action === 'approved';
        
        return `
            <div class="card" style="border-left:4px solid ${isApproved ? 'var(--green)' : 'var(--red)'};">
                <div style="display:flex;gap:1rem;align-items:start;">
                    <div style="font-size:2rem;flex-shrink:0;">
                        ${isApproved ? '‚úÖ' : '‚ùå'}
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:700;color:${isApproved ? 'var(--green)' : 'var(--red)'};margin-bottom:0.35rem;">
                            Ponto ${isApproved ? 'Aprovado' : 'Rejeitado'}!
                        </div>
                        <div style="font-size:0.9rem;color:var(--ink);margin-bottom:0.5rem;">
                            Seu ponto cadastrado foi ${isApproved ? 'aprovado pelo professor' : 'rejeitado'}
                        </div>
                        ${!isApproved && n.reason ? `
                            <div style="background:rgba(139,26,26,0.1);padding:0.75rem;border-radius:8px;margin-bottom:0.5rem;">
                                <div style="font-size:0.8rem;font-weight:600;color:var(--red);margin-bottom:0.25rem;">üìù Motivo:</div>
                                <div style="font-size:0.85rem;color:var(--ink);">${n.reason}</div>
                            </div>
                        ` : ''}
                        <div style="font-size:0.75rem;color:var(--gray);">
                            üïê ${timeAgo}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diffMs = now - time;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Agora mesmo';
    if (diffMins < 60) return `H√° ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
    if (diffHours < 24) return `H√° ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
    if (diffDays === 1) return 'Ontem';
    if (diffDays < 7) return `H√° ${diffDays} dias`;
    return time.toLocaleDateString('pt-BR');
}

function createConfetti() {
    const colors = ['#10B981', '#C4A35A', '#2D5A3D', '#F97316'];
    const confettiCount = 50;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            left: ${Math.random() * 100}%;
            top: 50%;
            opacity: 1;
            z-index: 9999;
            animation: confetti ${1 + Math.random()}s ease-out forwards;
            animation-delay: ${Math.random() * 0.3}s;
        `;
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 2000);
    }
}

// Simple teacher panel functions
function viewPointLocation(pointId) {
    // Sample coordinates for the 3 points
    const coords = {
        1: [-44.493800, -5.291500],
        2: [-44.494200, -5.292200],
        3: [-44.495500, -5.290500]
    };
    
    navigateTo('map');
    
    setTimeout(() => {
        if (AppState.map && coords[pointId]) {
            AppState.map.flyTo({
                center: coords[pointId],
                zoom: 17,
                duration: 2000
            });
            showToast('üó∫Ô∏è', 'Visualizando', 'Ponto localizado no mapa');
        }
    }, 300);
}

function viewPointOnMapFromDetail() {
    // Get coordinates from current point details
    if (!currentPointId || !POINT_DETAILS[currentPointId]) return;
    
    const point = POINT_DETAILS[currentPointId];
    closePointDetail();
    navigateTo('map');
    
    setTimeout(() => {
        if (AppState.map && point.lng && point.lat) {
            AppState.map.flyTo({
                center: [point.lng, point.lat],
                zoom: 17,
                duration: 2000
            });
            showToast('üó∫Ô∏è', 'Visualizando', `"${point.title}" no mapa`);
        }
    }, 300);
}

function renderFeed() {
    ALL_FEED_POINTS = [
        { id: 1, title: 'Igreja Matriz S√£o Sebasti√£o', author: 'Maria S.', turma: '6¬∫A', turmaCode: '6ANOA', category: '‚õ™ Igreja', categoryCode: 'igreja', date: 'Hoje', likes: 24, img: 'https://images.unsplash.com/photo-1548625149-fc4a29cf7092?w=400&h=220&fit=crop', description: 'Igreja cat√≥lica constru√≠da em 1920, representa um dos principais marcos hist√≥ricos da cidade. Sua arquitetura em estilo neog√≥tico apresenta elementos √∫nicos preservados desde sua funda√ß√£o.' },
        { id: 2, title: 'Pra√ßa Central S√£o Sebasti√£o', author: 'Jo√£o P.', turma: '7¬∫A', turmaCode: '7ANOA', category: 'üå≥ Pra√ßa', categoryCode: 'praca', date: 'Hoje', likes: 18, img: 'https://images.unsplash.com/photo-1561731216-c3a4d99437d5?w=400&h=220&fit=crop', description: 'Principal ponto de encontro da popula√ß√£o desde 1945. A pra√ßa foi reformada em 1980 mantendo caracter√≠sticas originais como o coreto central.' },
        { id: 3, title: 'Antiga Esta√ß√£o Ferrovi√°ria', author: 'Ana C.', turma: '8¬∫A', turmaCode: '8ANOA', category: 'üöÇ Patrim√¥nio', categoryCode: 'patrimonio', date: 'Ontem', likes: 31, img: 'https://images.unsplash.com/photo-1474487548417-781cb71495f3?w=400&h=220&fit=crop', description: 'Esta√ß√£o constru√≠da em 1935 que conectava a cidade ao interior do estado. Desativada em 1970 ap√≥s a expans√£o rodovi√°ria, hoje √© tombada como patrim√¥nio hist√≥rico.' },
        { id: 4, title: 'Mercado Municipal', author: 'Carlos R.', turma: '6¬∫A', turmaCode: '6ANOA', category: 'üè™ Com√©rcio', categoryCode: 'comercio', date: 'Ontem', likes: 15, img: 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=220&fit=crop', description: 'Mercado inaugurado em 1978, principal ponto de com√©rcio local.' }
    ];
    
    updateFeedDisplay();
}

function updateFeedDisplay() {
    let filtered = ALL_FEED_POINTS;
    
    // Filter by turma
    if (currentFeedFilter === 'minha-turma' && AppState.user) {
        filtered = filtered.filter(p => p.turmaCode === AppState.user.turma);
    }
    
    // Filter by category
    if (currentCategoryFilter !== 'all') {
        filtered = filtered.filter(p => p.categoryCode === currentCategoryFilter);
    }
    
    if (filtered.length === 0) {
        document.getElementById('feedContent').innerHTML = `
            <div style="text-align:center;padding:3rem 1rem;color:var(--gray);">
                <div style="font-size:3rem;margin-bottom:0.75rem;">üîç</div>
                <div style="font-weight:600;margin-bottom:0.35rem;">Nenhum ponto encontrado</div>
                <div style="font-size:0.85rem;">Tente ajustar os filtros</div>
            </div>
        `;
        return;
    }

    document.getElementById('feedContent').innerHTML = filtered.map((p, i) => `
        <div class="feed-card" data-turma="${p.turmaCode}" data-category="${p.categoryCode}" style="background:var(--white);border:2px solid var(--gold);border-radius:14px;overflow:hidden;margin-bottom:1rem;cursor:pointer;transition:transform 0.2s;" onclick="openPointDetail(${p.id})" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
            <img src="${p.img}" style="width:100%;height:180px;object-fit:cover;" alt="${p.title}">
            <div style="padding:1rem;">
                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                    <span style="background:rgba(45,90,61,0.1);color:var(--primary);padding:0.2rem 0.6rem;border-radius:10px;font-size:0.75rem;font-weight:600;">${p.category}</span>
                    <span style="font-size:0.75rem;color:var(--gold);font-style:italic;">${p.date}</span>
                </div>
                <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--primary);margin-bottom:0.5rem;">${p.title}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;padding-top:0.75rem;border-top:1px solid var(--paper-dark);">
                    <span style="font-size:0.8rem;color:var(--gray);">üë§ ${p.author} ¬∑ Turma ${p.turma}</span>
                    <button onclick="event.stopPropagation();this.textContent=this.textContent.includes('ü§ç')?'‚ù§Ô∏è '+(${p.likes}+1):'ü§ç ${p.likes}'" style="background:none;border:none;cursor:pointer;font-size:0.875rem;color:var(--gray);">ü§ç ${p.likes}</button>
                </div>
            </div>
        </div>
    `).join('');
}

function filterFeed(filter, el) {
    document.querySelectorAll('.feed-filter').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    currentFeedFilter = filter;
    updateFeedDisplay();
}

function filterFeedCategory(category, el) {
    document.querySelectorAll('.feed-filter-cat').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    currentCategoryFilter = category;
    updateFeedDisplay();
}

// Point details data
const POINT_DETAILS = {
    1: { title: 'Igreja Matriz S√£o Sebasti√£o', category: '‚õ™ Igreja', author: 'Maria S.', turma: '6¬∫A', img: 'https://images.unsplash.com/photo-1548625149-fc4a29cf7092?w=800&h=400&fit=crop', description: 'Igreja cat√≥lica constru√≠da em 1920, representa um dos principais marcos hist√≥ricos da cidade. Sua arquitetura em estilo neog√≥tico apresenta elementos √∫nicos preservados desde sua funda√ß√£o. O pr√©dio passou por restaura√ß√£o em 1980 que manteve suas caracter√≠sticas originais. √â local de festas religiosas tradicionais que re√∫nem toda a comunidade.', lat: -5.291234, lng: -44.493456, status: 'approved' },
    2: { title: 'Pra√ßa Central S√£o Sebasti√£o', category: 'üå≥ Pra√ßa', author: 'Jo√£o P.', turma: '7¬∫A', img: 'https://images.unsplash.com/photo-1561731216-c3a4d99437d5?w=800&h=400&fit=crop', description: 'Principal ponto de encontro da popula√ß√£o desde 1945. A pra√ßa foi reformada em 1980 mantendo caracter√≠sticas originais como o coreto central. Aos domingos, a pra√ßa ainda √© palco de apresenta√ß√µes de bandas locais. Em 2010 recebeu o t√≠tulo de Patrim√¥nio Cultural Municipal.', lat: -5.292000, lng: -44.494000, status: 'approved' },
    3: { title: 'Antiga Esta√ß√£o Ferrovi√°ria', category: 'üöÇ Patrim√¥nio', author: 'Ana C.', turma: '8¬∫A', img: 'https://images.unsplash.com/photo-1474487548417-781cb71495f3?w=800&h=400&fit=crop', description: 'Esta√ß√£o constru√≠da em 1935 que conectava a cidade ao interior do estado. Desativada em 1970 ap√≥s a expans√£o rodovi√°ria, hoje √© tombada como patrim√¥nio hist√≥rico municipal. O pr√©dio original de tijolos vermelhos resistiu ao tempo e ainda guarda trilhos e plataformas originais.', lat: -5.290000, lng: -44.495000, status: 'pending' }
};

let currentPointId = null;

function openPointDetail(id) {
    currentPointId = id;
    const point = POINT_DETAILS[id];
    if (!point) return;
    
    // Update modal content
    document.getElementById('detailModalTitle').textContent = point.title;
    document.getElementById('detailModalCategory').textContent = point.category;
    document.getElementById('detailModalAuthor').textContent = `üë§ ${point.author} ¬∑ Turma ${point.turma}`;
    document.getElementById('detailModalStatus').textContent = point.status === 'approved' ? '‚úÖ Aprovado' : '‚è≥ Pendente';
    document.getElementById('detailModalImage').src = point.img;
    document.getElementById('detailModalDescription').textContent = point.description;
    
    // Show modal
    document.getElementById('pointDetailModal').classList.add('active');
}

function closePointDetail() {
    document.getElementById('pointDetailModal').classList.remove('active');
}

async function sharePoint() {
    if (!currentPointId) return;
    
    const point = POINT_DETAILS[currentPointId];
    if (!point) return;
    
    const shareData = {
        title: `üìç ${point.title} ‚Äî PK Explorer`,
        text: `Descobri este ponto hist√≥rico: ${point.title}\n\n${point.description.substring(0, 100)}...`,
        url: window.location.origin + `?ponto=${currentPointId}`
    };
    
    try {
        // Try native Web Share API (works on mobile)
        if (navigator.share) {
            await navigator.share(shareData);
            showToast('‚úÖ', 'Compartilhado!', 'Ponto compartilhado com sucesso');
        } else {
            // Fallback: Copy link to clipboard
            const link = shareData.url;
            await navigator.clipboard.writeText(link);
            showToast('üìã', 'Link copiado!', 'Cole o link onde quiser compartilhar');
        }
    } catch (err) {
        if (err.name !== 'AbortError') {
            // Manual fallback
            const link = shareData.url;
            const textArea = document.createElement('textarea');
            textArea.value = link;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('üìã', 'Link copiado!', 'Cole onde quiser compartilhar');
            } catch (e) {
                showToast('‚ùå', 'Erro', 'N√£o foi poss√≠vel compartilhar');
            }
            
            document.body.removeChild(textArea);
        }
    }
}

// =================================================================
// TOAST NOTIFICATIONS
// =================================================================
function showToast(icon, title, body) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div>
            <div class="toast-title">${title}</div>
            <div class="toast-body">${body}</div>
        </div>
    `;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.transition = 'all 0.3s';
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 3500);
}

// =================================================================
// GEOGRAFIA - JAVASCRIPT
// =================================================================

let currentGeoPhoto = null;
let geoAnalyses = {};

function loadGeoAnalyses() {
    const saved = localStorage.getItem('pk_geo_analyses');
    if (saved) geoAnalyses = JSON.parse(saved);
    updateGeoStats();
}

function saveGeoAnalyses() {
    localStorage.setItem('pk_geo_analyses', JSON.stringify(geoAnalyses));
}

function updateGeoStats() {
    let completed = 0;
    let totalXP = 0;
    Object.values(geoAnalyses).forEach(photo => {
        if (photo.usoSolo?.complete) { completed++; totalXP += 40; }
        if (photo.paisagem?.complete) { totalXP += 60; }
        if (photo.percepcao?.complete) { totalXP += 30; }
    });
    const el1 = document.getElementById('geoCompleted');
    const el2 = document.getElementById('geoXP');
    if (el1) el1.textContent = Math.min(completed, 20);
    if (el2) el2.textContent = totalXP;
}

function renderGeoGrid() {
    const grid = document.getElementById('geoGrid');
    if (!grid) return;
    grid.innerHTML = '';
    
    HISTORICAL_PHOTOS.forEach(photo => {
        const analysis = geoAnalyses[photo.id] || {};
        let badges = [];
        if (analysis.usoSolo?.complete) badges.push('üó∫Ô∏è');
        if (analysis.paisagem?.complete) badges.push('üèîÔ∏è');
        if (analysis.percepcao?.complete) badges.push('üí≠');
        
        const status = badges.length === 0 ? 'none' : badges.length === 3 ? 'complete' : 'partial';
        
        const card = document.createElement('div');
        card.className = 'geo-card';
        card.onclick = () => openGeoModal(photo);
        card.innerHTML = `
            <div class="geo-badge-container">
                <div class="geo-mini-badge ${status}">${badges.length}/3</div>
            </div>
            <img src="${photo.photo_url}" alt="${photo.title}">
            <div class="geo-card-info">
                <div class="geo-card-title">${photo.title}</div>
            </div>
        `;
        grid.appendChild(card);
    });
}

function openGeoModal(photo) {
    currentGeoPhoto = photo;
    document.getElementById('geoModalTitle').textContent = photo.title;
    document.getElementById('geoModalLocation').textContent = photo.description;
    document.getElementById('geoModalImage').src = photo.photo_url;
    
    const analysis = geoAnalyses[photo.id] || {};
    const usoComplete = analysis.usoSolo?.complete;
    const paisagemComplete = analysis.paisagem?.complete;
    
    const layers = [
        {id:'usoSolo', icon:'üó∫Ô∏è', title:'Uso do Solo', xp:40, time:'15 min', locked:false},
        {id:'paisagem', icon:'üèîÔ∏è', title:'An√°lise de Paisagem', xp:60, time:'20 min', locked:!usoComplete},
        {id:'percepcao', icon:'üí≠', title:'Percep√ß√£o do Lugar', xp:30, time:'10 min', locked:false}
    ];
    
    const container = document.getElementById('geoLayers');
    container.innerHTML = '';
    
    layers.forEach(layer => {
        const isComplete = analysis[layer.id]?.complete;
        const div = document.createElement('div');
        div.className = 'geo-layer' + (layer.locked ? ' locked' : '');
        div.innerHTML = `
            <div class="geo-layer-header" onclick="${layer.locked ? '' : `toggleGeoLayer('${layer.id}')`}">
                <span class="geo-layer-icon">${layer.icon}</span>
                <div class="geo-layer-info">
                    <div class="geo-layer-title">${layer.title}</div>
                    <div class="geo-layer-status">
                        ${layer.locked ? 'üîí Bloqueado' : isComplete ? '‚úÖ Completo' : '‚è±Ô∏è ' + layer.time}
                    </div>
                </div>
                <div class="geo-layer-xp">${isComplete ? '+' + layer.xp + ' XP ‚úì' : layer.xp + ' XP'}</div>
            </div>
            <div class="geo-layer-content" id="layer-${layer.id}">
                ${layer.locked ? '<p>Complete a camada anterior para desbloquear.</p>' : renderLayerContent(layer.id, analysis[layer.id])}
            </div>
        `;
        container.appendChild(div);
    });
    
    document.getElementById('geoModal').style.display = 'block';
}

function closeGeoModal() {
    document.getElementById('geoModal').style.display = 'none';
    currentGeoPhoto = null;
}

function toggleGeoLayer(layerId) {
    const content = document.getElementById('layer-' + layerId);
    if (!content) return;
    content.classList.toggle('active');
}

function renderLayerContent(layerId, savedData) {
    if (layerId === 'usoSolo') {
        const saved = savedData?.data || {};
        return `
            <div class="geo-form-group">
                <label class="geo-form-label">1Ô∏è‚É£ Classifique o uso do solo na foto hist√≥rica:</label>
                <div class="geo-radio-group">
                    <label class="geo-radio-option ${saved.tipo === 'comercial' ? 'selected' : ''}">
                        <input type="radio" name="usoTipo" value="comercial" ${saved.tipo === 'comercial' ? 'checked' : ''}>
                        <span>üü¶ Comercial (lojas, mercados)</span>
                    </label>
                    <label class="geo-radio-option ${saved.tipo === 'residencial' ? 'selected' : ''}">
                        <input type="radio" name="usoTipo" value="residencial" ${saved.tipo === 'residencial' ? 'checked' : ''}>
                        <span>üü© Residencial (casas, pr√©dios)</span>
                    </label>
                    <label class="geo-radio-option ${saved.tipo === 'industrial' ? 'selected' : ''}">
                        <input type="radio" name="usoTipo" value="industrial" ${saved.tipo === 'industrial' ? 'checked' : ''}>
                        <span>üü® Industrial (f√°bricas)</span>
                    </label>
                    <label class="geo-radio-option ${saved.tipo === 'institucional' ? 'selected' : ''}">
                        <input type="radio" name="usoTipo" value="institucional" ${saved.tipo === 'institucional' ? 'checked' : ''}>
                        <span>üü• Institucional (igreja, escola, governo)</span>
                    </label>
                </div>
            </div>
            <div class="geo-form-group">
                <label class="geo-form-label">2Ô∏è‚É£ Como est√° hoje?</label>
                <div class="geo-radio-group">
                    <label class="geo-radio-option ${saved.mudanca === 'mesmo' ? 'selected' : ''}">
                        <input type="radio" name="usoMudanca" value="mesmo" ${saved.mudanca === 'mesmo' ? 'checked' : ''}>
                        <span>‚úÖ Mesmo uso</span>
                    </label>
                    <label class="geo-radio-option ${saved.mudanca === 'mudou' ? 'selected' : ''}">
                        <input type="radio" name="usoMudanca" value="mudou" ${saved.mudanca === 'mudou' ? 'checked' : ''}>
                        <span>üîÑ Mudou completamente</span>
                    </label>
                    <label class="geo-radio-option ${saved.mudanca === 'misto' ? 'selected' : ''}">
                        <input type="radio" name="usoMudanca" value="misto" ${saved.mudanca === 'misto' ? 'checked' : ''}>
                        <span>üîÄ Uso misto</span>
                    </label>
                </div>
            </div>
            <div class="geo-form-group">
                <label class="geo-form-label">3Ô∏è‚É£ Descreva a mudan√ßa (m√°x 200 caracteres):</label>
                <textarea class="geo-textarea" id="usoDesc" maxlength="200">${saved.descricao || ''}</textarea>
                <div class="geo-char-counter"><span id="usoDescCounter">${(saved.descricao || '').length}</span>/200</div>
            </div>
            ${savedData?.complete ? `
                <div class="geo-analysis-saved">
                    <div class="geo-analysis-saved-title">‚úÖ An√°lise Salva!</div>
                    <p>Voc√™ ganhou +40 XP por esta an√°lise.</p>
                </div>
            ` : `
                <div class="geo-buttons">
                    <button class="geo-btn-save" onclick="saveGeoAnalysis('usoSolo')">üíæ Salvar An√°lise</button>
                </div>
            `}
        `;
    }
    
    if (layerId === 'paisagem') {
        const saved = savedData?.data || {};
        return `
            <div class="geo-form-group">
                <label class="geo-form-label">1Ô∏è‚É£ Elementos vis√≠veis na paisagem:</label>
                <div style="display:flex;flex-direction:column;gap:0.5rem">
                    <label style="display:flex;align-items:center;gap:0.5rem">
                        <input type="checkbox" ${saved.relevo ? 'checked' : ''}> Relevo (morros, vales)
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem">
                        <input type="checkbox" ${saved.vegetacao ? 'checked' : ''}> Vegeta√ß√£o (√°rvores, parques)
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem">
                        <input type="checkbox" ${saved.construcoes ? 'checked' : ''}> Constru√ß√µes
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem">
                        <input type="checkbox" ${saved.infraestrutura ? 'checked' : ''}> Infraestrutura (ruas, postes)
                    </label>
                </div>
            </div>
            <div class="geo-form-group">
                <label class="geo-form-label">2Ô∏è‚É£ O que mudou desde a foto antiga? (m√°x 300 chars):</label>
                <textarea class="geo-textarea" id="paisagemDesc" maxlength="300">${saved.mudancas || ''}</textarea>
            </div>
            ${savedData?.complete ? `
                <div class="geo-analysis-saved">
                    <div class="geo-analysis-saved-title">‚úÖ An√°lise Salva!</div>
                    <p>Voc√™ ganhou +60 XP por esta an√°lise.</p>
                </div>
            ` : `
                <div class="geo-buttons">
                    <button class="geo-btn-save" onclick="saveGeoAnalysis('paisagem')">üíæ Salvar An√°lise</button>
                </div>
            `}
        `;
    }
    
    if (layerId === 'percepcao') {
        const saved = savedData?.data || {};
        return `
            <div class="geo-form-group">
                <label class="geo-form-label">üí≠ O que esta foto transmite para voc√™?</label>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem">
                    <label style="display:flex;align-items:center;gap:0.5rem">
                        <input type="checkbox" ${saved.orgulho ? 'checked' : ''}> Orgulho
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem">
                        <input type="checkbox" ${saved.saudade ? 'checked' : ''}> Saudade
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem">
                        <input type="checkbox" ${saved.mudanca ? 'checked' : ''}> Mudan√ßa
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem">
                        <input type="checkbox" ${saved.pertencimento ? 'checked' : ''}> Pertencimento
                    </label>
                </div>
            </div>
            <div class="geo-form-group">
                <label class="geo-form-label">‚úçÔ∏è Suas impress√µes (m√°x 250 chars):</label>
                <textarea class="geo-textarea" id="percepcaoDesc" maxlength="250">${saved.impressoes || ''}</textarea>
            </div>
            ${savedData?.complete ? `
                <div class="geo-analysis-saved">
                    <div class="geo-analysis-saved-title">‚úÖ An√°lise Salva!</div>
                    <p>Voc√™ ganhou +30 XP por esta an√°lise.</p>
                </div>
            ` : `
                <div class="geo-buttons">
                    <button class="geo-btn-save" onclick="saveGeoAnalysis('percepcao')">üíæ Salvar An√°lise</button>
                </div>
            `}
        `;
    }
}

function saveGeoAnalysis(layerId) {
    if (!currentGeoPhoto) return;
    
    const photoId = currentGeoPhoto.id;
    if (!geoAnalyses[photoId]) geoAnalyses[photoId] = {};
    
    let data = {};
    let xp = 0;
    let layerName = '';
    
    if (layerId === 'usoSolo') {
        const tipo = document.querySelector('input[name="usoTipo"]:checked')?.value;
        const mudanca = document.querySelector('input[name="usoMudanca"]:checked')?.value;
        const descricao = document.getElementById('usoDesc')?.value;
        
        if (!tipo || !mudanca || !descricao) {
            showToast('‚ö†Ô∏è', 'Campos incompletos', 'Preencha todos os campos!');
            return;
        }
        
        data = {tipo, mudanca, descricao};
        xp = 40;
        layerName = 'Uso do Solo';
    } else if (layerId === 'paisagem') {
        const mudancas = document.getElementById('paisagemDesc')?.value;
        if (!mudancas) {
            showToast('‚ö†Ô∏è', 'Campo vazio', 'Descreva as mudan√ßas!');
            return;
        }
        data = {mudancas};
        xp = 60;
        layerName = 'Paisagem';
    } else if (layerId === 'percepcao') {
        const impressoes = document.getElementById('percepcaoDesc')?.value;
        if (!impressoes) {
            showToast('‚ö†Ô∏è', 'Campo vazio', 'Escreva suas impress√µes!');
            return;
        }
        data = {impressoes};
        xp = 30;
        layerName = 'Percep√ß√£o';
    }
    
    geoAnalyses[photoId][layerId] = {data, complete: true};
    saveGeoAnalyses();
    
    if (AppState.user) {
        AppState.user.xp = (AppState.user.xp || 0) + xp;
        Auth.setCurrent(AppState.user);
        const topbarXP = document.getElementById('topbarXP');
        if (topbarXP) topbarXP.textContent = `‚≠ê ${AppState.user.xp} XP`;
    }
    
    const popup = document.createElement('div');
    popup.className = 'geo-success-popup';
    popup.textContent = `‚úÖ ${layerName} Salva! +${xp} XP`;
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 3000);
    
    closeGeoModal();
    renderGeoGrid();
    updateGeoStats();
}

// =================================================================
// PROFESSOR - PAINEL SIMPLIFICADO
// =================================================================

function loadTeacherData() {
    const pending = getAllPendingContributions();
    const approved = getAllApprovedContributions();
    
    // Count students
    const usersKey = 'pk_users';
    const savedUsers = localStorage.getItem(usersKey);
    const totalStudents = savedUsers ? JSON.parse(savedUsers).filter(u => u.role !== 'professor').length : 0;
    
    // Count geography analyses
    let totalGeoAnalyses = 0;
    Object.keys(geoAnalyses).forEach(photoId => {
        const analysis = geoAnalyses[photoId];
        if (analysis.usoSolo?.complete) totalGeoAnalyses++;
        if (analysis.paisagem?.complete) totalGeoAnalyses++;
        if (analysis.percepcao?.complete) totalGeoAnalyses++;
    });
    
    document.getElementById('teacherPendingCount').textContent = pending.length;
    document.getElementById('teacherApprovedCount').textContent = approved;
    document.getElementById('teacherPendingBadge').textContent = pending.length;
    document.getElementById('teacherTotalStudents').textContent = totalStudents;
    document.getElementById('teacherTotalGeo').textContent = totalGeoAnalyses;
    
    renderTeacherPending(pending);
    renderTeacherRanking();
}

function getAllPendingContributions() {
    const pending = [];
    HISTORICAL_PHOTOS.forEach(photo => {
        const key = 'pk_contributions_' + photo.id;
        const saved = localStorage.getItem(key);
        if (saved) {
            const contribs = JSON.parse(saved);
            contribs.forEach((contrib, index) => {
                if (!contrib.approved && contrib.approved !== false) {
                    pending.push({
                        photoId: photo.id,
                        photoTitle: photo.title,
                        contribIndex: index,
                        author: contrib.author,
                        text: contrib.text,
                        date: contrib.date
                    });
                }
            });
        }
    });
    return pending;
}

function getAllApprovedContributions() {
    let count = 0;
    HISTORICAL_PHOTOS.forEach(photo => {
        const key = 'pk_contributions_' + photo.id;
        const saved = localStorage.getItem(key);
        if (saved) {
            const contribs = JSON.parse(saved);
            contribs.forEach(contrib => {
                if (contrib.approved === true) count++;
            });
        }
    });
    return count;
}

function renderTeacherPending(pending) {
    const container = document.getElementById('teacherPendingList');
    if (!container) return;
    
    if (pending.length === 0) {
        container.innerHTML = '<div class="teacher-empty">‚úÖ Nenhuma contribui√ß√£o pendente!</div>';
        return;
    }
    
    container.innerHTML = '';
    pending.forEach(item => {
        const div = document.createElement('div');
        div.className = 'teacher-pending-item';
        div.innerHTML = `
            <div class="teacher-pending-photo">üì∏ ${item.photoTitle}</div>
            <div class="teacher-pending-author">üë§ ${item.author} ‚Ä¢ ${item.date}</div>
            <div class="teacher-pending-text">${item.text}</div>
            <div class="teacher-actions">
                <button class="teacher-btn teacher-btn-approve" onclick="approveContribution(${item.photoId}, ${item.contribIndex})">
                    ‚úì Aprovar
                </button>
                <button class="teacher-btn teacher-btn-reject" onclick="rejectContribution(${item.photoId}, ${item.contribIndex})">
                    ‚úó Rejeitar
                </button>
            </div>
        `;
        container.appendChild(div);
    });
}

function approveContribution(photoId, contribIndex) {
    const key = 'pk_contributions_' + photoId;
    const saved = localStorage.getItem(key);
    if (!saved) return;
    
    const contribs = JSON.parse(saved);
    contribs[contribIndex].approved = true;
    contribs[contribIndex].approvedAt = new Date().toISOString();
    contribs[contribIndex].approvedBy = AppState.user ? AppState.user.name : 'Professor';
    localStorage.setItem(key, JSON.stringify(contribs));
    
    showToast('‚úÖ', 'Aprovado!', 'Contribui√ß√£o aprovada com sucesso');
    loadTeacherData();
}

function rejectContribution(photoId, contribIndex) {
    if (!confirm('Rejeitar esta contribui√ß√£o?')) return;
    
    const key = 'pk_contributions_' + photoId;
    const saved = localStorage.getItem(key);
    if (!saved) return;
    
    const contribs = JSON.parse(saved);
    contribs[contribIndex].approved = false;
    contribs[contribIndex].rejectedAt = new Date().toISOString();
    localStorage.setItem(key, JSON.stringify(contribs));
    
    showToast('‚ö†Ô∏è', 'Rejeitado', 'Contribui√ß√£o rejeitada');
    loadTeacherData();
}

function renderTeacherRanking() {
    const container = document.getElementById('teacherRankingList');
    if (!container) return;
    
    // Get all users from localStorage
    const usersKey = 'pk_users';
    const savedUsers = localStorage.getItem(usersKey);
    if (!savedUsers) {
        container.innerHTML = '<div class="teacher-empty">Nenhum aluno cadastrado ainda</div>';
        return;
    }
    
    const users = JSON.parse(savedUsers);
    const students = users.filter(u => u.role !== 'professor').sort((a, b) => (b.xp || 0) - (a.xp || 0)).slice(0, 10);
    
    if (students.length === 0) {
        container.innerHTML = '<div class="teacher-empty">Nenhum aluno cadastrado ainda</div>';
        return;
    }
    
    container.innerHTML = '';
    students.forEach((student, index) => {
        const div = document.createElement('div');
        div.className = 'teacher-ranking-item';
        const posClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : 'other';
        div.innerHTML = `
            <div class="teacher-ranking-pos ${posClass}">${index + 1}</div>
            <div class="teacher-ranking-info">
                <div class="teacher-ranking-name">${student.name}</div>
                <div style="font-size:0.8rem;color:#999">${student.email}</div>
            </div>
            <div class="teacher-ranking-xp">${student.xp || 0} XP</div>
        `;
        container.appendChild(div);
    });
}

// =================================================================
// GERA√á√ÉO DE RELAT√ìRIOS EM PDF
// =================================================================

function generateCompletePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('Relat√≥rio Completo - PK Explorer', 20, 20);
    doc.setFontSize(12);
    doc.text('Todas as Contribui√ß√µes dos Alunos', 20, 30);
    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 38);
    
    let yPos = 50;
    let contributionsAdded = 0;
    
    HISTORICAL_PHOTOS.forEach(photo => {
        const key = 'pk_contributions_' + photo.id;
        const saved = localStorage.getItem(key);
        if (saved) {
            const contribs = JSON.parse(saved);
            contribs.forEach(contrib => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(`Foto: ${photo.title}`, 20, yPos);
                yPos += 7;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Aluno: ${contrib.author}`, 20, yPos);
                yPos += 5;
                doc.text(`Data: ${contrib.date}`, 20, yPos);
                yPos += 5;
                doc.text(`Status: ${contrib.approved === true ? 'Aprovado' : contrib.approved === false ? 'Rejeitado' : 'Pendente'}`, 20, yPos);
                yPos += 5;
                
                const textLines = doc.splitTextToSize(contrib.text, 170);
                doc.text(textLines, 20, yPos);
                yPos += (textLines.length * 5) + 5;
                
                doc.line(20, yPos, 190, yPos);
                yPos += 8;
                contributionsAdded++;
            });
        }
    });
    
    if (contributionsAdded === 0) {
        doc.text('Nenhuma contribui√ß√£o encontrada.', 20, yPos);
    }
    
    doc.save(`pk-explorer-completo-${new Date().getTime()}.pdf`);
    showToast('üì•', 'PDF Gerado!', 'Relat√≥rio completo baixado');
}

function generateStudentsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('Ranking de Alunos - PK Explorer', 20, 20);
    doc.setFontSize(12);
    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
    
    const usersKey = 'pk_users';
    const savedUsers = localStorage.getItem(usersKey);
    if (!savedUsers) {
        doc.text('Nenhum aluno cadastrado.', 20, 50);
        doc.save(`pk-explorer-alunos-${new Date().getTime()}.pdf`);
        showToast('üì•', 'PDF Gerado!', 'Relat√≥rio de alunos baixado');
        return;
    }
    
    const users = JSON.parse(savedUsers);
    const students = users.filter(u => u.role !== 'professor').sort((a, b) => (b.xp || 0) - (a.xp || 0));
    
    let yPos = 50;
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Pos.', 20, yPos);
    doc.text('Nome', 40, yPos);
    doc.text('Email', 100, yPos);
    doc.text('XP', 170, yPos);
    yPos += 5;
    doc.line(20, yPos, 190, yPos);
    yPos += 10;
    
    doc.setFont(undefined, 'normal');
    students.forEach((student, index) => {
        if (yPos > 270) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.text(`${index + 1}`, 20, yPos);
        doc.text(student.name, 40, yPos);
        doc.text(student.email, 100, yPos);
        doc.text(String(student.xp || 0), 170, yPos);
        yPos += 8;
    });
    
    doc.save(`pk-explorer-alunos-${new Date().getTime()}.pdf`);
    showToast('üì•', 'PDF Gerado!', 'Relat√≥rio de alunos baixado');
}

function generateGeoPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('An√°lises Geogr√°ficas - PK Explorer', 20, 20);
    doc.setFontSize(12);
    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
    
    let yPos = 50;
    let analysesAdded = 0;
    
    Object.keys(geoAnalyses).forEach(photoId => {
        const photo = HISTORICAL_PHOTOS.find(p => p.id == photoId);
        if (!photo) return;
        
        const analysis = geoAnalyses[photoId];
        
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(`Foto: ${photo.title}`, 20, yPos);
        yPos += 8;
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        
        if (analysis.usoSolo?.complete) {
            doc.text('Uso do Solo:', 25, yPos);
            yPos += 5;
            doc.text(`Tipo: ${analysis.usoSolo.data.tipo}`, 30, yPos);
            yPos += 5;
            doc.text(`Mudan√ßa: ${analysis.usoSolo.data.mudanca}`, 30, yPos);
            yPos += 5;
            const descLines = doc.splitTextToSize(analysis.usoSolo.data.descricao, 160);
            doc.text(descLines, 30, yPos);
            yPos += (descLines.length * 5) + 3;
            analysesAdded++;
        }
        
        if (analysis.paisagem?.complete) {
            doc.text('Paisagem:', 25, yPos);
            yPos += 5;
            const mudLines = doc.splitTextToSize(analysis.paisagem.data.mudancas, 160);
            doc.text(mudLines, 30, yPos);
            yPos += (mudLines.length * 5) + 3;
            analysesAdded++;
        }
        
        if (analysis.percepcao?.complete) {
            doc.text('Percep√ß√£o:', 25, yPos);
            yPos += 5;
            const impLines = doc.splitTextToSize(analysis.percepcao.data.impressoes, 160);
            doc.text(impLines, 30, yPos);
            yPos += (impLines.length * 5) + 3;
            analysesAdded++;
        }
        
        doc.line(20, yPos, 190, yPos);
        yPos += 10;
    });
    
    if (analysesAdded === 0) {
        doc.text('Nenhuma an√°lise geogr√°fica encontrada.', 20, yPos);
    }
    
    doc.save(`pk-explorer-geografia-${new Date().getTime()}.pdf`);
    showToast('üì•', 'PDF Gerado!', 'Relat√≥rio geogr√°fico baixado');
}

// Initialize memories when app loads
loadMemoriesFromLocalStorage();
loadGeoAnalyses();

// Event delegation for geography radio buttons
document.addEventListener('click', function(e) {
    if (e.target.type === 'radio' && e.target.closest('.geo-radio-option')) {
        const option = e.target.closest('.geo-radio-option');
        const group = option.closest('.geo-radio-group');
        group.querySelectorAll('.geo-radio-option').forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
    }
});

// Character counters for geography textareas
document.addEventListener('input', function(e) {
    if (e.target.id === 'usoDesc') {
        const counter = document.getElementById('usoDescCounter');
        if (counter) counter.textContent = e.target.value.length;
    }
});

</script>
</body>
</html>
